<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>影像学术研究计算工具 v4.2 </title>
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #7c3aed;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg: #ffffff;
            --text: #1e293b;
            --card: #f8fafc;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --normal-color: #22c55e;
            --renal-color: #f59e0b;
            --metformin-color: #ef4444;
            --heart-color: #3b82f6;
            --allergy-color: #8b5cf6;
        }

        [data-theme="dark"] {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #f87171;
            --bg: #0f172a;
            --text: #e2e8f0;
            --card: #1e293b;
            --border: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --heart-color: #60a5fa;
            --allergy-color: #a78bfa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text);
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        h1 {
            font-size: 2.8em;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .subtitle {
            font-size: 1.2em;
            color: var(--text);
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .developer-info {
            margin: 15px 0;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
        }

        .clock-container {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border: 2px solid transparent;
            background-clip: padding-box;
            border-radius: 16px;
            padding: 20px;
            margin: 25px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 
                0 8px 32px rgba(79, 70, 229, 0.1),
                inset 0 1px 3px rgba(255, 255, 255, 0.8),
                inset 0 -1px 2px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .clock-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 2px;
            background: linear-gradient(135deg, var(--primary), var(--secondary), #22c55e, var(--primary));
            border-radius: 16px;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            z-index: -1;
            animation: borderGlow 3s ease-in-out infinite alternate;
        }

        @keyframes borderGlow {
            0% { opacity: 0.6; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.02); }
        }

        .digits-container {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .digit-group {
            display: flex;
            gap: 8px;
        }

        .digit {
            position: relative;
            width: 60px;
            height: 100px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 2px rgba(255, 255, 255, 0.8),
                inset 0 -1px 1px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(79, 70, 229, 0.1);
            transition: all 0.3s ease;
        }

        .digit:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.15),
                inset 0 1px 2px rgba(255, 255, 255, 0.9),
                inset 0 -1px 1px rgba(0, 0, 0, 0.05);
        }

        .segment {
            position: absolute;
            background: transparent;
            border-radius: 3px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .segment.active {
            background: #333333;
            box-shadow: 
                0 0 4px rgba(51, 51, 51, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .segment.active {
            background: #ffffff !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.4) !important;
        }

        .segment-a { top: 8px; left: 12px; width: 36px; height: 8px; }
        .segment-d { bottom: 8px; left: 12px; width: 36px; height: 8px; }
        .segment-g { top: 50%; left: 12px; width: 36px; height: 8px; transform: translateY(-50%); }
        .segment-b { top: 12px; right: 8px; width: 8px; height: 36px; }
        .segment-c { bottom: 12px; right: 8px; width: 8px; height: 36px; }
        .segment-e { bottom: 12px; left: 8px; width: 8px; height: 36px; }
        .segment-f { top: 12px; left: 8px; width: 8px; height: 36px; }

        .clock-colon {
            font-size: 2.5rem;
            color: #333333;
            margin: 0 8px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(51, 51, 51, 0.2);
            transition: all 0.3s ease;
        }

        .clock-label {
            font-size: 13px;
            color: var(--primary);
            text-align: center;
            margin-top: 12px;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .clock-container {
            background: linear-gradient(145deg, #1e293b, #334155);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 3px rgba(255, 255, 255, 0.1),
                inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        }

        [data-theme="dark"] .digit {
            background: linear-gradient(145deg, #334155, #475569);
            border: 1px solid rgba(99, 102, 241, 0.2);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.3),
                inset 0 1px 2px rgba(255, 255, 255, 0.1),
                inset 0 -1px 1px rgba(0, 0, 0, 0.2);
        }

        [data-theme="dark"] .clock-colon {
            color: #ffffff !important;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.4) !important;
        }

        .patient-category-selector {
            background: var(--card);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border);
        }

        .category-title {
            text-align: center;
            font-size: 1.8em;
            color: var(--primary);
            margin-bottom: 25px;
            font-weight: 700;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
        }

        .category-card {
            background: var(--bg);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            transition: all 0.3s ease;
        }

        .category-card.normal::before { background: var(--normal-color); }
        .category-card.renal::before { background: var(--renal-color); }
        .category-card.metformin::before { background: var(--metformin-color); }
        .category-card.heart::before { background: var(--heart-color); }
        .category-card.allergy::before { background: var(--allergy-color); }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .category-card.active {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(79, 70, 229, 0.2);
        }

        .category-card.normal.active {
            border-color: var(--normal-color);
            box-shadow: 0 8px 30px rgba(34, 197, 94, 0.2);
        }

        .category-card.renal.active {
            border-color: var(--renal-color);
            box-shadow: 0 8px 30px rgba(245, 158, 11, 0.2);
        }

        .category-card.metformin.active {
            border-color: var(--metformin-color);
            box-shadow: 0 8px 30px rgba(239, 68, 68, 0.2);
        }

        .category-card.heart.active {
            border-color: var(--heart-color);
            box-shadow: 0 8px 30px rgba(59, 130, 246, 0.2);
        }

        .category-card.allergy.active {
            border-color: var(--allergy-color);
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.2);
        }

        .category-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }

        .category-name {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .category-description {
            font-size: 0.95em;
            color: var(--text);
            opacity: 0.7;
            line-height: 1.5;
        }

        .category-card.normal .category-name { color: var(--normal-color); }
        .category-card.renal .category-name { color: var(--renal-color); }
        .category-card.metformin .category-name { color: var(--metformin-color); }
        .category-card.heart .category-name { color: var(--heart-color); }
        .category-card.allergy .category-name { color: var(--allergy-color); }

        .form-container {
            display: none;
            animation: slideIn 0.5s ease;
        }

        .form-container.show {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            background: var(--card);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .form-section:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title.normal { color: var(--normal-color); }
        .section-title.renal { color: var(--renal-color); }
        .section-title.metformin { color: var(--metformin-color); }
        .section-title.heart { color: var(--heart-color); }
        .section-title.allergy { color: var(--allergy-color); }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        label {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .required {
            color: var(--error);
        }

        input, select {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .input-hint {
            font-size: 12px;
            color: var(--text);
            opacity: 0.6;
            margin-top: 4px;
        }

        .input-error {
            border-color: var(--error) !important;
            background-color: rgba(239, 68, 68, 0.05);
        }

        .error-message {
            color: var(--error);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .real-time-validation {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }

        .validation-success { color: var(--success); }
        .validation-error { color: var(--error); }

        .formula-display {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--text);
            opacity: 0.8;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: var(--card);
        }

        .checkbox-item.checked {
            background: rgba(79, 70, 229, 0.1);
            border-color: var(--primary);
        }

        .checkbox-item input[type="checkbox"], .checkbox-item input[type="radio"] {
            margin: 0;
            width: auto;
            height: auto;
        }

        .info-box {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.6;
            border-left: 4px solid;
        }

        .info-box.normal {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #065f46;
            border-left-color: var(--normal-color);
        }

        .info-box.renal {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            color: #92400e;
            border-left-color: var(--renal-color);
        }

        .info-box.metformin {
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            color: #991b1b;
            border-left-color: var(--metformin-color);
        }

        .info-box.heart {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e3a8a;
            border-left-color: var(--heart-color);
        }

        .info-box.allergy {
            background: linear-gradient(135deg, #e9d5ff, #d8b4fe);
            color: #581c87;
            border-left-color: var(--allergy-color);
        }

        .grading-table {
            width: 100%;
            margin: 15px 0;
            border-collapse: collapse;
            font-size: 12px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .grading-table th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 11px;
        }

        .grading-table td {
            padding: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
            font-size: 11px;
        }

        .grading-table .grade-level {
            font-weight: 700;
            white-space: nowrap;
        }

        .grade-minimal { color: var(--success); }
        .grade-low { color: var(--normal-color); }
        .grade-moderate { color: var(--renal-color); }
        .grade-high { color: var(--metformin-color); }
        .grade-very-high { color: var(--error); }

        .risk-score-display {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .score-value {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .score-minimal { color: var(--success); }
        .score-low { color: var(--normal-color); }
        .score-moderate { color: var(--renal-color); }
        .score-high { color: var(--metformin-color); }
        .score-very-high { color: var(--error); }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-secondary {
            background: var(--card);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--border);
        }

        .results {
            background: var(--card);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid var(--border);
            margin-top: 25px;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .results.show { display: block; }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 12px;
            background: var(--bg);
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .result-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .result-label {
            font-weight: 500;
            color: var(--text);
        }

        .result-value {
            font-size: 1.2em;
            color: var(--primary);
            font-weight: 700;
        }

        .calc-type {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
        }

        .disclaimer {
            background: linear-gradient(135deg, #fef7cd, #fed7aa);
            color: #92400e;
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid var(--warning);
            margin-top: 25px;
            font-size: 13px;
            line-height: 1.6;
        }

        .disclaimer h3 {
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 700;
        }

        .highlight {
            font-weight: 700;
            color: #b45309;
        }

        [data-theme="dark"] .grading-table {
            background: #1e293b;
        }

        [data-theme="dark"] .grading-table td {
            border-color: #374151;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; }
            h1 { font-size: 2.2em; }
            .form-row { grid-template-columns: 1fr; gap: 15px; }
            .theme-toggle { 
                position: relative; 
                margin-bottom: 20px; 
                top: auto;
                right: auto;
                align-self: center;
            }
            .btn-group { flex-direction: column; }
            
            .category-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }

            .grading-table {
                font-size: 10px;
            }

            .grading-table th,
            .grading-table td {
                padding: 6px 4px;
            }

            .clock-container {
                padding: 15px 10px;
                margin: 20px 0;
            }
            
            .digits-container {
                gap: 6px;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding: 0 10px;
            }
            
            .digit-group {
                gap: 4px;
                flex-shrink: 0;
            }
            
            .digit {
                width: 45px;
                height: 75px;
                min-width: 45px;
            }
            
            .segment-a, .segment-d, .segment-g {
                width: 29px;
                height: 5px;
                left: 8px;
            }
            
            .segment-b, .segment-c, .segment-e, .segment-f {
                width: 5px;
                height: 26px;
            }
            
            .clock-colon {
                font-size: 1.8rem;
                margin: 0 4px;
            }
        }

        @media print {
            body { background: white; color: black; }
            .container { background: white; box-shadow: none; }
            .btn, .theme-toggle, .patient-category-selector, .clock-container { display: none; }
            .no-print { display: none; }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="theme-toggle" onclick="toggleTheme()">
                <span id="theme-icon">🌙</span>
                <span id="theme-text">夜间模式</span>
            </div>
            <h1>影像学术研究计算工具</h1>
            <div class="subtitle">CTA造影剂用量计算 + 过敏风险评估 + 多专科评估 v4.2</div>
            <div class="developer-info">
                💻 程序开发者:影像涛哥 
            </div>
            
            <div class="clock-container">
                <div class="digits-container">
                    <div class="digit-group">
                        <div class="digit" id="hour-tens">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                        <div class="digit" id="hour-ones">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                    </div>
                    
                    <div class="clock-colon">:</div>
                    
                    <div class="digit-group">
                        <div class="digit" id="min-tens">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                        <div class="digit" id="min-ones">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                    </div>
                    
                    <div class="clock-colon">:</div>
                    
                    <div class="digit-group">
                        <div class="digit" id="sec-tens">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                        <div class="digit" id="sec-ones">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                    </div>
                </div>
                <div class="clock-label">当前时间</div>
            </div>
        </div>
        
        <div class="patient-category-selector">
            <div class="category-title">选择评估类型 - 五大专业评估系统</div>
            <div class="category-grid">
                <div class="category-card normal" onclick="selectPatientType('normal')">
                    <div class="category-icon">👤</div>
                    <div class="category-name">正常患者</div>
                    <div class="category-description">
                        肾功能正常<br>
                        无特殊用药史<br>
                        标准计算流程
                    </div>
                </div>
                
                <div class="category-card renal" onclick="selectPatientType('renal')">
                    <div class="category-icon">🫘</div>
                    <div class="category-name">肾功能异常患者</div>
                    <div class="category-description">
                        肾功能不全<br>
                        需要eGFR评估<br>
                        造影剂用量调整
                    </div>
                </div>
                
                <div class="category-card metformin" onclick="selectPatientType('metformin')">
                    <div class="category-icon">💊</div>
                    <div class="category-name">二甲双胍用药患者</div>
                    <div class="category-description">
                        服用二甲双胍<br>
                        需要风险评估<br>
                        特殊处理方案
                    </div>
                </div>

                <div class="category-card heart" onclick="selectPatientType('heart')">
                    <div class="category-icon">❤️</div>
                    <div class="category-name">心功能不全患者</div>
                    <div class="category-description">
                        心功能异常<br>
                        需要NYHA分级评估<br>
                        造影剂用量限制
                    </div>
                </div>

                <div class="category-card allergy" onclick="selectPatientType('allergy')">
                    <div class="category-icon">⚠️</div>
                    <div class="category-name">过敏风险评估</div>
                    <div class="category-description">
                        造影剂过敏风险评估<br>
                        2024版评估标准<br>
                        预处理方案指导
                    </div>
                </div>
            </div>
        </div>

        <!-- 正常患者表单 -->
        <div class="form-container" id="normalForm">
            <div class="form-section">
                <h2 class="section-title normal">
                    <span>👤</span>
                    正常患者 - 基础参数设置
                </h2>
                <div class="info-box normal">
                    <strong>✅ 正常患者计算流程:</strong><br>
                    • 肾功能正常,无需eGFR评估<br>
                    • 无二甲双胍用药风险<br>
                    • 按标准公式计算造影剂用量<br>
                    • 安全限制:冠脉CTA ≤60ml,胸痛三联 ≤75ml
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="normalHeight">身高 (cm) <span class="required">*</span></label>
                        <input type="number" id="normalHeight" placeholder="请输入身高,如:170" min="100" max="250" step="0.1" required>
                        <span class="real-time-validation" id="normalHeight-validation"></span>
                        <div class="input-hint">范围:100-250cm</div>
                        <div class="error-message" id="normalHeight-error">身高必须在100-250cm之间</div>
                    </div>
                    <div class="form-group">
                        <label for="normalWeight">体重 (kg) <span class="required">*</span></label>
                        <input type="number" id="normalWeight" placeholder="请输入体重,如:70" min="20" max="200" step="0.1" required>
                        <span class="real-time-validation" id="normalWeight-validation"></span>
                        <div class="input-hint">范围:20-200kg</div>
                        <div class="error-message" id="normalWeight-error">体重必须在20-200kg之间</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="normalHeartRate">心率参数</label>
                        <select id="normalHeartRate">
                            <option value="80">≤80 次/分</option>
                            <option value="81">>80 次/分</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="normalExamType">检查类型</label>
                        <select id="normalExamType">
                            <option value="coronary">冠脉CTA</option>
                            <option value="triple">胸痛三联</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 肾功能异常患者表单 -->
        <div class="form-container" id="renalForm">
            <div class="form-section">
                <h2 class="section-title renal">
                    <span>🫘</span>
                    肾功能异常患者 - 基础参数设置
                </h2>
                <div class="info-box renal">
                    <strong>⚠️ 肾功能异常患者特殊处理:</strong><br>
                    • 需要评估eGFR(2021版CKD-EPI公式)<br>
                    • 根据肾功能分级调整造影剂用量<br>
                    • eGFR <45 ml/min/1.73m² 时减量至80%<br>
                    • 必须进行充分水化治疗
                </div>

                <div class="info-box normal">
                    <strong>📊 肾功能异常患者分级标准(基于eGFR):</strong><br>
                    <table class="grading-table">
                        <thead>
                            <tr>
                                <th>等级</th>
                                <th>eGFR范围<br>(ml/min/1.73m²)</th>
                                <th>肾功能状态</th>
                                <th>处理策略</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="grade-level grade-low">一级</td>
                                <td>≥ 60</td>
                                <td>正常/轻度下降</td>
                                <td>标准流程</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-moderate">二级</td>
                                <td>45-59</td>
                                <td>轻中度不全</td>
                                <td>加强监测</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-moderate">三级</td>
                                <td>30-44</td>
                                <td>中重度不全</td>
                                <td>减量至80%</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-high">四级</td>
                                <td>< 30</td>
                                <td>重度不全</td>
                                <td>避免检查</td>
                            </tr>
                        </tbody>
                    </table>
                    <strong>评估流程:</strong>血肌酐 → 2021 CKD-EPI → eGFR分级 → 造影剂调整
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="renalHeight">身高 (cm) <span class="required">*</span></label>
                        <input type="number" id="renalHeight" placeholder="请输入身高,如:170" min="100" max="250" step="0.1" required>
                        <span class="real-time-validation" id="renalHeight-validation"></span>
                        <div class="input-hint">范围:100-250cm</div>
                        <div class="error-message" id="renalHeight-error">身高必须在100-250cm之间</div>
                    </div>
                    <div class="form-group">
                        <label for="renalWeight">体重 (kg) <span class="required">*</span></label>
                        <input type="number" id="renalWeight" placeholder="请输入体重,如:70" min="20" max="200" step="0.1" required>
                        <span class="real-time-validation" id="renalWeight-validation"></span>
                        <div class="input-hint">范围:20-200kg</div>
                        <div class="error-message" id="renalWeight-error">体重必须在20-200kg之间</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="renalCreatinine">血肌酐值 (μmol/L) <span class="required">*</span></label>
                        <input type="number" id="renalCreatinine" placeholder="请输入血肌酐值,如:120" min="30" max="500" step="1" required>
                        <span class="real-time-validation" id="renalCreatinine-validation"></span>
                        <div class="input-hint">范围:30-500 μmol/L,用于计算eGFR</div>
                        <div class="error-message" id="renalCreatinine-error">血肌酐值必须在30-500 μmol/L之间</div>
                        <div class="formula-display" id="renalFormulaDisplay" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="renalAge">年龄 (岁) <span class="required">*</span></label>
                        <input type="number" id="renalAge" placeholder="请输入年龄,如:65" min="18" max="120" step="1" required>
                        <span class="real-time-validation" id="renalAge-validation"></span>
                        <div class="input-hint">范围:18-120岁</div>
                        <div class="error-message" id="renalAge-error">年龄必须在18-120岁之间</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="renalGender">性别 <span class="required">*</span></label>
                        <select id="renalGender" onchange="updateRenalFormulaDisplay()">
                            <option value="male">男性</option>
                            <option value="female">女性</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="renalHeartRate">心率参数</label>
                        <select id="renalHeartRate">
                            <option value="80">≤80 次/分</option>
                            <option value="81">>80 次/分</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="renalExamType">检查类型</label>
                        <select id="renalExamType">
                            <option value="coronary">冠脉CTA</option>
                            <option value="triple">胸痛三联</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 二甲双胍患者表单 -->
        <div class="form-container" id="metforminForm">
            <div class="form-section">
                <h2 class="section-title metformin">
                    <span>💊</span>
                    二甲双胍用药患者 - 基础参数设置
                </h2>
                <div class="info-box metformin">
                    <strong>🚨 二甲双胍患者风险提示:</strong><br>
                    • 造影剂可能增加乳酸酸中毒风险<br>
                    • 需要详细评估肾功能(eGFR)<br>
                    • 造影前后48-72小时暂停用药<br>
                    • 必要时内分泌科会诊
                </div>

                <div class="info-box normal">
                    <strong>💊 二甲双胍患者风险分组标准:</strong><br>
                    <table class="grading-table">
                        <thead>
                            <tr>
                                <th>风险组</th>
                                <th>评分标准</th>
                                <th>评估要素</th>
                                <th>临床处理</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="grade-level grade-low">低风险组</td>
                                <td>1.0-2.0分</td>
                                <td>eGFR≥60 + 年龄<65 + 剂量<1500mg</td>
                                <td>标准处理</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-moderate">中风险组</td>
                                <td>2.5-3.5分</td>
                                <td>eGFR 45-59 + 年龄65-75 + 剂量适中</td>
                                <td>谨慎监测</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-high">高风险组</td>
                                <td>4.0-5.5分</td>
                                <td>eGFR 30-44 + 年龄>75 + 剂量≥1500mg</td>
                                <td>高风险处理</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-very-high">极高风险组</td>
                                <td>≥6.0分</td>
                                <td>eGFR<30 + 高龄 + 高剂量</td>
                                <td>避免检查</td>
                            </tr>
                        </tbody>
                    </table>
                    <strong>评分细则:</strong>eGFR(≥60=1分,45-59=2分,30-44=3分,<30=4分) + 年龄(65-74=0.5分,≥75=1分) + 剂量(1500-1999mg=0.5分,≥2000mg=1分)<br>
                    <strong>评估要素:</strong>肾功能 + 年龄 + 剂量 → 乳酸酸中毒风险评估
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="metforminHeight">身高 (cm) <span class="required">*</span></label>
                        <input type="number" id="metforminHeight" placeholder="请输入身高,如:170" min="100" max="250" step="0.1" required>
                        <span class="real-time-validation" id="metforminHeight-validation"></span>
                        <div class="input-hint">范围:100-250cm</div>
                        <div class="error-message" id="metforminHeight-error">身高必须在100-250cm之间</div>
                    </div>
                    <div class="form-group">
                        <label for="metforminWeight">体重 (kg) <span class="required">*</span></label>
                        <input type="number" id="metforminWeight" placeholder="请输入体重,如:70" min="20" max="200" step="0.1" required>
                        <span class="real-time-validation" id="metforminWeight-validation"></span>
                        <div class="input-hint">范围:20-200kg</div>
                        <div class="error-message" id="metforminWeight-error">体重必须在20-200kg之间</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="metforminCreatinine">血肌酐值 (μmol/L) <span class="required">*</span></label>
                        <input type="number" id="metforminCreatinine" placeholder="请输入血肌酐值,如:80" min="30" max="500" step="1" required>
                        <span class="real-time-validation" id="metforminCreatinine-validation"></span>
                        <div class="input-hint">范围:30-500 μmol/L,用于风险评估</div>
                        <div class="error-message" id="metforminCreatinine-error">血肌酐值必须在30-500 μmol/L之间</div>
                        <div class="formula-display" id="metforminFormulaDisplay" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="metforminAge">年龄 (岁) <span class="required">*</span></label>
                        <input type="number" id="metforminAge" placeholder="请输入年龄,如:60" min="18" max="120" step="1" required>
                        <span class="real-time-validation" id="metforminAge-validation"></span>
                        <div class="input-hint">范围:18-120岁</div>
                        <div class="error-message" id="metforminAge-error">年龄必须在18-120岁之间</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="metforminGender">性别 <span class="required">*</span></label>
                        <select id="metforminGender" onchange="updateMetforminFormulaDisplay()">
                            <option value="male">男性</option>
                            <option value="female">女性</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="metforminDose">二甲双胍剂量(mg/日)</label>
                        <select id="metforminDose">
                            <option value="500">500mg/日</option>
                            <option value="850">850mg/日</option>
                            <option value="1000">1000mg/日</option>
                            <option value="1500">1500mg/日</option>
                            <option value="2000">2000mg/日</option>
                            <option value="other">其他剂量</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="metforminHeartRate">心率参数</label>
                        <select id="metforminHeartRate">
                            <option value="80">≤80 次/分</option>
                            <option value="81">>80 次/分</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="metforminExamType">检查类型</label>
                        <select id="metforminExamType">
                            <option value="coronary">冠脉CTA</option>
                            <option value="triple">胸痛三联</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 心功能不全患者表单 -->
        <div class="form-container" id="heartForm">
            <div class="form-section">
                <h2 class="section-title heart">
                    <span>❤️</span>
                    心功能不全患者 - 基础参数设置
                </h2>
                <div class="info-box heart">
                    <strong>💙 心功能不全患者特殊处理:</strong><br>
                    • 需要评估NYHA心功能分级<br>
                    • 根据射血分数(EF)调整造影剂用量<br>
                    • 严格控制造影剂总量,避免容量负荷过重<br>
                    • 监测BNP/NT-proBNP水平<br>
                    • <strong>新增:如提供肌酐值,将评估心肾综合征风险</strong>
                </div>

                <div class="info-box normal">
                    <strong>❤️ 心功能不全患者风险分级标准:</strong><br>
                    <table class="grading-table">
                        <thead>
                            <tr>
                                <th>风险等级</th>
                                <th>NYHA分级</th>
                                <th>EF值范围</th>
                                <th>处理策略</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="grade-level grade-low">低风险</td>
                                <td>NYHA I级</td>
                                <td>EF ≥ 50%</td>
                                <td>标准流程</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-moderate">中风险</td>
                                <td>NYHA II级</td>
                                <td>EF 40-49%</td>
                                <td>中度监测</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-high">高风险</td>
                                <td>NYHA III级</td>
                                <td>EF 30-39%</td>
                                <td>高风险处理</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-very-high">极高风险</td>
                                <td>NYHA IV级</td>
                                <td>EF < 30%</td>
                                <td>慎重考虑</td>
                            </tr>
                        </tbody>
                    </table>
                    <strong>评估要素:</strong>NYHA分级 + 射血分数 + BNP + <strong>肾功能</strong> → 容量负荷风险评估
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="heartHeight">身高 (cm) <span class="required">*</span></label>
                        <input type="number" id="heartHeight" placeholder="请输入身高,如:170" min="100" max="250" step="0.1" required>
                        <span class="real-time-validation" id="heartHeight-validation"></span>
                        <div class="input-hint">范围:100-250cm</div>
                        <div class="error-message" id="heartHeight-error">身高必须在100-250cm之间</div>
                    </div>
                    <div class="form-group">
                        <label for="heartWeight">体重 (kg) <span class="required">*</span></label>
                        <input type="number" id="heartWeight" placeholder="请输入体重,如:70" min="20" max="200" step="0.1" required>
                        <span class="real-time-validation" id="heartWeight-validation"></span>
                        <div class="input-hint">范围:20-200kg</div>
                        <div class="error-message" id="heartWeight-error">体重必须在20-200kg之间</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="heartNYHA">NYHA心功能分级 <span class="required">*</span></label>
                        <select id="heartNYHA">
                            <option value="1">I级 - 活动不受限制</option>
                            <option value="2">II级 - 轻度活动受限</option>
                            <option value="3">III级 - 明显活动受限</option>
                            <option value="4">IV级 - 休息时也有症状</option>
                        </select>
                        <div class="input-hint">请选择患者的NYHA心功能分级</div>
                    </div>
                    <div class="form-group">
                        <label for="heartEF">左室射血分数(EF) % <span class="required">*</span></label>
                        <input type="number" id="heartEF" placeholder="请输入EF值,如:45" min="10" max="80" step="1" required>
                        <span class="real-time-validation" id="heartEF-validation"></span>
                        <div class="input-hint">范围:10-80%</div>
                        <div class="error-message" id="heartEF-error">EF值必须在10-80%之间</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="heartBNP">BNP/NT-proBNP水平</label>
                        <select id="heartBNP">
                            <option value="normal">正常范围</option>
                            <option value="mild">轻度升高(1-2倍)</option>
                            <option value="moderate">中度升高(2-5倍)</option>
                            <option value="severe">重度升高(>5倍)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="heartCreatinine">血肌酐值 (μmol/L) - 可选</label>
                        <input type="number" id="heartCreatinine" placeholder="如有数据请输入" min="30" max="500" step="1">
                        <span class="real-time-validation" id="heartCreatinine-validation"></span>
                        <div class="input-hint">可选填,用于评估心肾综合征及调整造影剂</div>
                        <div class="error-message" id="heartCreatinine-error">血肌酐值必须在30-500 μmol/L之间</div>
                        <div class="formula-display" id="heartFormulaDisplay" style="display: none;"></div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="heartAge">年龄 (岁) - 用于eGFR计算</label>
                        <input type="number" id="heartAge" placeholder="如有肌酐值需填写" min="18" max="120" step="1">
                        <span class="real-time-validation" id="heartAge-validation"></span>
                        <div class="input-hint">与肌酐值配合计算eGFR</div>
                        <div class="error-message" id="heartAge-error">年龄必须在18-120岁之间</div>
                    </div>
                    <div class="form-group">
                        <label for="heartGender">性别 - 用于eGFR计算</label>
                        <select id="heartGender" onchange="updateHeartFormulaDisplay()">
                            <option value="male">男性</option>
                            <option value="female">女性</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="heartRate">心率参数</label>
                        <select id="heartRate">
                            <option value="80">≤80 次/分</option>
                            <option value="81">>80 次/分</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="heartExamType">检查类型</label>
                        <select id="heartExamType">
                            <option value="coronary">冠脉CTA</option>
                            <option value="triple">胸痛三联</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 过敏风险评估表单 -->
        <div class="form-container" id="allergyForm">
            <div class="form-section">
                <h2 class="section-title allergy">
                    <span>⚠️</span>
                    造影剂过敏风险评估 - 2024版标准
                </h2>
                <div class="info-box allergy">
                    <strong>🔬 2024版造影剂过敏风险评估系统:</strong><br>
                    • 基于多因素评分模型进行风险分层<br>
                    • 主要风险因素(3分)、次要风险因素(2分)、轻微风险因素(1分)<br>
                    • 总分≥6分为极高风险,4-5分为高风险,2-3分为中等风险<br>
                    • 提供个性化预处理方案和监护建议
                </div>

                <div class="info-box normal">
                    <strong>📊 风险评估分级标准:</strong><br>
                    <table class="grading-table">
                        <thead>
                            <tr>
                                <th>风险等级</th>
                                <th>总分范围</th>
                                <th>反应发生率</th>
                                <th>处理策略</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="grade-level grade-minimal">无明显风险</td>
                                <td>0分</td>
                                <td>0.1-0.5%</td>
                                <td>标准监测</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-low">低风险</td>
                                <td>1分</td>
                                <td>1-2%</td>
                                <td>考虑预处理</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-moderate">中等风险</td>
                                <td>2-3分</td>
                                <td>2-5%</td>
                                <td>标准预处理</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-high">高风险</td>
                                <td>4-5分</td>
                                <td>5-10%</td>
                                <td>强化预处理</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-very-high">极高风险</td>
                                <td>≥6分</td>
                                <td>10-30%</td>
                                <td>避免使用</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- A. 造影剂使用史评估 -->
                <div class="form-section">
                    <h3 style="color: var(--allergy-color); margin-bottom: 15px;">A. 造影剂使用史评估</h3>
                    
                    <div class="form-group">
                        <label>1. 是否曾经使用过造影剂? <span class="required">*</span></label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="radio" name="previousContrast" value="no" id="prevContrast-no">
                                <label for="prevContrast-no">否,从未使用过</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="radio" name="previousContrast" value="yes" id="prevContrast-yes">
                                <label for="prevContrast-yes">是,曾经使用过</label>
                            </div>
                        </div>
                    </div>

                    <div id="contrastHistoryDetails" style="display: none;">
                        <div class="form-group">
                            <label>2. 上次使用造影剂时的反应情况? <span class="required">*</span></label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="radio" name="previousReaction" value="none" id="reaction-none">
                                    <label for="reaction-none">无任何反应</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="previousReaction" value="mild" id="reaction-mild">
                                    <label for="reaction-mild">轻微反应(+1分)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="previousReaction" value="moderate" id="reaction-moderate">
                                    <label for="reaction-moderate">中度反应(+3分)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="previousReaction" value="severe" id="reaction-severe">
                                    <label for="reaction-severe">严重反应(+3分)</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>3. 具体反应症状(可多选):</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-rash">
                                    <label for="symptom-rash">皮疹/荨麻疹</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-itch">
                                    <label for="symptom-itch">全身瘙痒</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-nausea">
                                    <label for="symptom-nausea">恶心呕吐</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-dizzy">
                                    <label for="symptom-dizzy">头晕头痛</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-dyspnea">
                                    <label for="symptom-dyspnea">呼吸困难</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-edema">
                                    <label for="symptom-edema">喉头水肿</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-hypotension">
                                    <label for="symptom-hypotension">血压下降</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-consciousness">
                                    <label for="symptom-consciousness">意识改变</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- B. 过敏史评估 -->
                <div class="form-section">
                    <h3 style="color: var(--allergy-color); margin-bottom: 15px;">B. 过敏史评估</h3>
                    
                    <div class="form-group">
                        <label>1. 药物过敏史(可多选):</label>
                        <div class="checkbox-group" id="drugAllergyGroup">
                            <div class="checkbox-item">
                                <input type="checkbox" id="drug-none" data-group="drug">
                                <label for="drug-none">无药物过敏史</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="drug-penicillin" data-group="drug">
                                <label for="drug-penicillin">青霉素类</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="drug-cephalosporin" data-group="drug">
                                <label for="drug-cephalosporin">头孢类</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="drug-sulfa" data-group="drug">
                                <label for="drug-sulfa">磺胺类</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="drug-aspirin" data-group="drug">
                                <label for="drug-aspirin">阿司匹林</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="drug-multiple" data-group="drug">
                                <label for="drug-multiple">≥3种不相关药物(+2分)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="drug-severe-allergy" data-group="drug">
                                <label for="drug-severe-allergy">严重过敏反应史(+3分)</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>2. 食物过敏史(可多选):</label>
                        <div class="checkbox-group" id="foodAllergyGroup">
                            <div class="checkbox-item">
                                <input type="checkbox" id="food-none" data-group="food">
                                <label for="food-none">无食物过敏史</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="food-seafood" data-group="food">
                                <label for="food-seafood">海鲜类(+1分)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="food-nuts" data-group="food">
                                <label for="food-nuts">坚果类(+1分)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="food-milk" data-group="food">
                                <label for="food-milk">牛奶蛋白</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="food-egg" data-group="food">
                                <label for="food-egg">鸡蛋</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="food-others" data-group="food">
                                <label for="food-others">其他食物</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>3. 哮喘评估:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="radio" name="asthma" value="none" id="asthma-none">
                                <label for="asthma-none">无哮喘病史</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="radio" name="asthma" value="mild" id="asthma-mild">
                                <label for="asthma-mild">轻度哮喘(+1分)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="radio" name="asthma" value="severe" id="asthma-severe">
                                <label for="asthma-severe">重度哮喘(+2分)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="radio" name="asthma" value="allergic" id="asthma-allergic">
                                <label for="asthma-allergic">哮喘伴过敏史(+3分)</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>4. 其他过敏性疾病(可多选):</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="other-rhinitis">
                                <label for="other-rhinitis">过敏性鼻炎(+1分)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="other-eczema">
                                <label for="other-eczema">湿疹/特应性皮炎(+1分)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="other-urticaria">
                                <label for="other-urticaria">慢性荨麻疹</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="other-contact">
                                <label for="other-contact">接触性皮炎</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- C. 特殊情况评估 -->
                <div class="form-section">
                    <h3 style="color: var(--allergy-color); margin-bottom: 15px;">C. 特殊情况评估</h3>
                    
                    <div class="form-group">
                        <label>1. 特殊疾病史(可多选):</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="special-mastocytosis">
                                <label for="special-mastocytosis">肥大细胞增多症(+2分)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="special-heart">
                                <label for="special-heart">严重心脏病</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="special-thyroid">
                                <label for="special-thyroid">甲状腺功能亢进</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>2. 当前用药情况(可多选):</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="med-beta-blocker">
                                <label for="med-beta-blocker">β受体阻滞剂</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="med-ace">
                                <label for="med-ace">ACE抑制剂</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="med-metformin">
                                <label for="med-metformin">二甲双胍</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="med-antihistamine">
                                <label for="med-antihistamine">抗组胺药物</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="risk-score-display" id="allergyRiskScore" style="display: none;">
                    <div class="score-value" id="riskScoreValue">0</div>
                    <div id="riskLevelText">风险等级评估中...</div>
                </div>
            </div>
        </div>

        <div class="form-container show" id="actionForm">
            <div class="form-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress"></div>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="calculate()" id="calculateBtn" disabled>
                        <span>🧮</span> 开始评估计算
                    </button>
                    <button class="btn btn-secondary" onclick="exportToPDF()" id="pdfBtn" disabled>
                        <span>📄</span> 导出评估报告
                    </button>
                    <button class="btn btn-secondary" onclick="resetForm()" id="resetBtn">
                        <span>🔄</span> 重新选择
                    </button>
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <h2 class="section-title">
                <span>📊</span>
                评估结果
            </h2>
            <div id="calculationResults"></div>
        </div>

        <div class="disclaimer">
            <h3>⚠️ 重要使用声明</h3>
            <p><span class="highlight">专业背景要求:</span>使用者须是在医学影像科工作的专业人员,熟悉CT检查流程和造影剂使用规范。</p>
            <p><span class="highlight">设备依据:</span>本工具计算公式基于联影CT960+设备的技术参数和临床研究数据。</p>
            <p><span class="highlight">学术用途:</span>仅供影像技术教学、学术研究使用,严禁用于临床诊断或治疗决策。</p>
            <p><span class="highlight">五大评估系统:</span>正常患者标准计算、肾功能异常患者eGFR评估、二甲双胍患者风险评估、心功能不全患者NYHA分级评估、造影剂过敏风险评估。</p>
            <p><span class="highlight">过敏评估系统:</span>基于2024版国际指南,但不能100%预测过敏反应,临床使用时必须配备完善的抢救措施。</p>
            <p><span class="highlight">eGFR计算:</span>采用2021版CKD-EPI公式(无种族系数),适用于中国人群。</p>
            <p><span class="highlight">安全限制:</span>程序已设置造影剂用量和注射流速的安全上限,但实际使用需结合患者具体情况充分评估。</p>
            <p><span class="highlight">v4.2混合版更新:</span>前四类患者使用详细PDF格式,过敏评估使用专门PDF格式,优化用户体验。</p>
            <p style="margin-top: 15px; font-weight: 700; color: #b45309; border-top: 1px solid #fed7aa; padding-top: 15px;">
                开发者不承担任何直接或间接的法律责任;使用即表示同意本声明。程序使用过程中如遇到问题及反馈,请联系邮箱:lucky@taothink.com
            </p>
        </div>
    </div>

    <script>
        const digitConfig = {
            '0': [1, 1, 1, 1, 1, 1, 0],
            '1': [0, 1, 1, 0, 0, 0, 0],
            '2': [1, 1, 0, 1, 1, 0, 1],
            '3': [1, 1, 1, 1, 0, 0, 1],
            '4': [0, 1, 1, 0, 0, 1, 1],
            '5': [1, 0, 1, 1, 0, 1, 1],
            '6': [1, 0, 1, 1, 1, 1, 1],
            '7': [1, 1, 1, 0, 0, 0, 0],
            '8': [1, 1, 1, 1, 1, 1, 1],
            '9': [1, 1, 1, 1, 0, 1, 1]
        };

        const appState = {
            isDarkMode: false,
            currentPatientType: null,
            currentResults: null,
            allergyRiskScore: 0
        };

        function updateClock() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            const hoursStr = hours.toString().padStart(2, '0');
            const minutesStr = minutes.toString().padStart(2, '0');
            const secondsStr = seconds.toString().padStart(2, '0');

            displayDigit(document.getElementById('hour-tens'), hoursStr[0]);
            displayDigit(document.getElementById('hour-ones'), hoursStr[1]);
            displayDigit(document.getElementById('min-tens'), minutesStr[0]);
            displayDigit(document.getElementById('min-ones'), minutesStr[1]);
            displayDigit(document.getElementById('sec-tens'), secondsStr[0]);
            displayDigit(document.getElementById('sec-ones'), secondsStr[1]);
        }

        function displayDigit(digitElement, number) {
            if (!digitElement) return;
            
            const segments = digitElement.querySelectorAll('.segment');
            const config = digitConfig[number] || digitConfig['0'];

            segments.forEach((segment, index) => {
                segment.classList.remove('active');
                if (config[index] === 1) {
                    segment.classList.add('active');
                }
            });
        }

        function toggleTheme() {
            try {
                appState.isDarkMode = !appState.isDarkMode;
                const body = document.body;
                const themeIcon = document.getElementById('theme-icon');
                const themeText = document.getElementById('theme-text');
                
                if (appState.isDarkMode) {
                    body.setAttribute('data-theme', 'dark');
                    if (themeIcon) themeIcon.textContent = '☀️';
                    if (themeText) themeText.textContent = '日间模式';
                } else {
                    body.removeAttribute('data-theme');
                    if (themeIcon) themeIcon.textContent = '🌙';
                    if (themeText) themeText.textContent = '夜间模式';
                }
                
                setTimeout(updateClock, 100);
                
            } catch (error) {
                console.error('主题切换出错:', error);
                showNotification('⚠️ 主题切换失败', 'warning');
            }
        }

        function selectPatientType(type) {
            appState.currentPatientType = type;
            
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`.category-card.${type}`).classList.add('active');
            
            document.querySelectorAll('.form-container').forEach(form => {
                if (form.id !== 'actionForm') {
                    form.classList.remove('show');
                }
            });
            
            const targetForm = document.getElementById(`${type}Form`);
            if (targetForm) {
                targetForm.classList.add('show');
            }
            
            const results = document.getElementById('results');
            results.classList.remove('show');
            appState.currentResults = null;
            
            updateProgress();
            
            setTimeout(() => {
                targetForm.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function resetForm() {
            appState.currentPatientType = null;
            appState.allergyRiskScore = 0;
            
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('active');
            });
            
            document.querySelectorAll('.form-container').forEach(form => {
                if (form.id !== 'actionForm') {
                    form.classList.remove('show');
                }
            });
            
            document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
                input.value = '';
                input.classList.remove('input-error');
            });
            
            document.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
                input.checked = false;
            });
            
            document.querySelectorAll('.real-time-validation').forEach(el => {
                el.textContent = '';
            });
            
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            
            document.querySelectorAll('.formula-display').forEach(el => {
                el.style.display = 'none';
            });
            
            const historyDetails = document.getElementById('contrastHistoryDetails');
            if (historyDetails) historyDetails.style.display = 'none';
            
            const riskScoreDisplay = document.getElementById('allergyRiskScore');
            if (riskScoreDisplay) riskScoreDisplay.style.display = 'none';
            
            const results = document.getElementById('results');
            results.classList.remove('show');
            appState.currentResults = null;
            
            updateProgress();
            
            document.getElementById('calculateBtn').disabled = true;
            document.getElementById('pdfBtn').disabled = true;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            showNotification('✅ 表单已重置,请重新选择评估类型', 'success');
        }

        function calculateEGFR_2021_Corrected(creatinine_umol, age, gender) {
            let eGFR;
            
            if (gender === 'female') {
                if (creatinine_umol <= 62) {
                    eGFR = 142 * Math.pow(creatinine_umol / 62, -0.241) * Math.pow(0.9938, age) * 1.012;
                } else {
                    eGFR = 142 * Math.pow(creatinine_umol / 62, -1.2) * Math.pow(0.9938, age) * 1.012;
                }
            } else {
                if (creatinine_umol <= 80) {
                    eGFR = 142 * Math.pow(creatinine_umol / 80, -0.302) * Math.pow(0.9938, age);
                } else {
                    eGFR = 142 * Math.pow(creatinine_umol / 80, -1.2) * Math.pow(0.9938, age);
                }
            }
            
            return Math.round(eGFR);
        }

        function generateSimplifiedEGFRCalculation(creatinine_umol, age, gender) {
            let formula = '';
            let result = '';
            
            if (gender === 'female') {
                if (creatinine_umol <= 62) {
                    formula = `女性,Scr ≤ 62 μmol/L:eGFR = 142 × (${creatinine_umol}/62)^(-0.241) × 0.9938^${age} × 1.012`;
                } else {
                    formula = `女性,Scr > 62 μmol/L:eGFR = 142 × (${creatinine_umol}/62)^(-1.2) × 0.9938^${age} × 1.012`;
                }
            } else {
                if (creatinine_umol <= 80) {
                    formula = `男性,Scr ≤ 80 μmol/L:eGFR = 142 × (${creatinine_umol}/80)^(-0.302) × 0.9938^${age}`;
                } else {
                    formula = `男性,Scr > 80 μmol/L:eGFR = 142 × (${creatinine_umol}/80)^(-1.2) × 0.9938^${age}`;
                }
            }
            
            result = calculateEGFR_2021_Corrected(creatinine_umol, age, gender);
            
            return {
                formula: formula,
                result: result,
                simplifiedCalculation: `${formula} = ${result}`
            };
        }

        function updateRenalFormulaDisplay() {
            updateFormulaDisplay('renal');
        }

        function updateMetforminFormulaDisplay() {
            updateFormulaDisplay('metformin');
        }

        function updateHeartFormulaDisplay() {
            const creatinine = parseFloat(document.getElementById('heartCreatinine').value);
            const age = parseFloat(document.getElementById('heartAge').value);
            const gender = document.getElementById('heartGender').value;
            const formulaDisplay = document.getElementById('heartFormulaDisplay');
            
            if (!creatinine || creatinine < 30 || creatinine > 500 || !age) {
                formulaDisplay.style.display = 'none';
                return;
            }
            
            let formulaText = '';
            if (gender === 'female') {
                if (creatinine <= 62) {
                    formulaText = `女性,Scr ≤ 62 μmol/L:eGFR = 142 × (${creatinine}/62)^(-0.241) × 0.9938^${age} × 1.012`;
                } else {
                    formulaText = `女性,Scr > 62 μmol/L:eGFR = 142 × (${creatinine}/62)^(-1.2) × 0.9938^${age} × 1.012`;
                }
            } else {
                if (creatinine <= 80) {
                    formulaText = `男性,Scr ≤ 80 μmol/L:eGFR = 142 × (${creatinine}/80)^(-0.302) × 0.9938^${age}`;
                } else {
                    formulaText = `男性,Scr > 80 μmol/L:eGFR = 142 × (${creatinine}/80)^(-1.2) × 0.9938^${age}`;
                }
            }
            
            const eGFR = calculateEGFR_2021_Corrected(creatinine, age, gender);
            formulaText += ` = ${eGFR} ml/min/1.73m²`;
            
            formulaDisplay.innerHTML = formulaText;
            formulaDisplay.style.display = 'block';
        }

        function updateFormulaDisplay(type) {
            const gender = document.getElementById(`${type}Gender`).value;
            const creatinine = parseFloat(document.getElementById(`${type}Creatinine`).value);
            const formulaDisplay = document.getElementById(`${type}FormulaDisplay`);
            
            if (!creatinine || creatinine < 30 || creatinine > 500) {
                formulaDisplay.style.display = 'none';
                return;
            }
            
            let formulaText = '';
            if (gender === 'female') {
                if (creatinine <= 62) {
                    formulaText = `女性,Scr ≤ 62 μmol/L:eGFR = 142 × (${creatinine}/62)^(-0.241) × 0.9938^年龄 × 1.012`;
                } else {
                    formulaText = `女性,Scr > 62 μmol/L:eGFR = 142 × (${creatinine}/62)^(-1.2) × 0.9938^年龄 × 1.012`;
                }
            } else {
                if (creatinine <= 80) {
                    formulaText = `男性,Scr ≤ 80 μmol/L:eGFR = 142 × (${creatinine}/80)^(-0.302) × 0.9938^年龄`;
                } else {
                    formulaText = `男性,Scr > 80 μmol/L:eGFR = 142 × (${creatinine}/80)^(-1.2) × 0.9938^年龄`;
                }
            }
            
            formulaDisplay.innerHTML = formulaText;
            formulaDisplay.style.display = 'block';
        }

        function assessHeartFailureRisk(nyha, ef, bnp, eGFR = null) {
            let riskLevel = 'low';
            let recommendations = [];
            let clinicalAction = '';
            
            const nyhaValue = parseInt(nyha);
            const efValue = parseFloat(ef);
            
            if (nyhaValue === 1 && efValue >= 50) {
                riskLevel = 'low';
                clinicalAction = '低风险处理';
                recommendations = [
                    '心功能尚可,按标准流程检查',
                    '适当控制造影剂用量',
                    '监测血流动力学变化',
                    '检查后观察2小时'
                ];
            } else if (nyhaValue <= 2 && efValue >= 40) {
                riskLevel = 'moderate';
                clinicalAction = '中度风险监测';
                recommendations = [
                    '轻度心功能不全,需谨慎评估',
                    '造影剂用量减至标准用量的85%',
                    '控制注射流速≤4.5ml/s',
                    '密切关注有无过敏反应',
                    '检查前后监测BNP变化',
                    '必要时预防性使用利尿剂'
                ];
            } else if (nyhaValue === 3 || efValue < 40) {
                riskLevel = 'high';
                clinicalAction = '高风险处理';
                recommendations = [
                    '明显心功能不全,高风险',
                    '造影剂用量减至标准用量的70%',
                    '严格控制注射流速≤4.0ml/s',
                    '分次注射,避免短时间大量负荷',
                    '检查前优化心功能治疗',
                    '心内科会诊评估',
                    '准备急救药物和设备'
                ];
            } else if (nyhaValue === 4 || efValue < 30) {
                riskLevel = 'very-high';
                clinicalAction = '极高风险 - 慎重考虑';
                recommendations = [
                    '严重心功能不全,极高风险',
                    '强烈建议避免或推迟检查',
                    '如必须检查,需CCU监护条件',
                    '造影剂用量减至最低(≤50ml)',
                    '考虑替代检查方法',
                    '必须心内科团队在场'
                ];
            }
            
            if (eGFR !== null && eGFR < 60) {
                if (eGFR < 30) {
                    riskLevel = 'very-high';
                    recommendations.unshift('⚠️ 严重心肾综合征风险,eGFR<30,强烈建议避免造影剂');
                } else if (eGFR < 45) {
                    if (riskLevel === 'low') riskLevel = 'moderate';
                    else if (riskLevel === 'moderate') riskLevel = 'high';
                    recommendations.unshift('⚠️ 心肾综合征风险,需双重考虑,造影剂再减量20%');
                } else {
                    recommendations.unshift('⚠️ 轻度肾功能不全,注意心肾综合征风险');
                }
            }
            
            if (bnp === 'severe') {
                riskLevel = riskLevel === 'low' ? 'moderate' : 
                           riskLevel === 'moderate' ? 'high' : 'very-high';
                recommendations.unshift('BNP严重升高,提示心功能失代偿风险');
            }
            
            return { 
                riskLevel, 
                recommendations, 
                clinicalAction,
                riskScore: calculateHeartRiskScore(nyhaValue, efValue, bnp, eGFR)
            };
        }

        function calculateHeartRiskScore(nyha, ef, bnp, eGFR = null) {
            let score = 0;
            score += nyha;
            
            if (ef >= 50) score += 1;
            else if (ef >= 40) score += 2;
            else if (ef >= 30) score += 3;
            else score += 4;
            
            switch(bnp) {
                case 'normal': score += 0; break;
                case 'mild': score += 1; break;
                case 'moderate': score += 2; break;
                case 'severe': score += 3; break;
            }
            
            if (eGFR !== null) {
                if (eGFR < 30) score += 3;
                else if (eGFR < 45) score += 2;
                else if (eGFR < 60) score += 1;
            }
            
            return score;
        }

        function assessMetforminRisk(eGFR, dose, age) {
            let riskLevel = 'low';
            let recommendations = [];
            let clinicalAction = '';
            
            if (eGFR >= 60) {
                riskLevel = 'low';
                clinicalAction = '标准处理';
                recommendations = [
                    '肾功能正常,造影前后暂停二甲双胍48小时',
                    '造影后监测肾功能,无异常可恢复用药',
                    '建议造影前后充分水化'
                ];
            } else if (eGFR >= 45) {
                riskLevel = 'moderate';
                clinicalAction = '谨慎监测';
                recommendations = [
                    '轻度肾功能不全,需谨慎评估',
                    '造影前后暂停二甲双胍48-72小时',
                    '造影后48-72小时复查肾功能',
                    '建议静脉水化:0.9% NaCl 1ml/kg/h,检查前6-12h开始'
                ];
            } else if (eGFR >= 30) {
                riskLevel = 'high';
                clinicalAction = '高风险处理';
                recommendations = [
                    '中度肾功能不全,高风险',
                    '造影前后暂停二甲双胍72小时',
                    '考虑减少造影剂用量至标准用量的80%',
                    '必须静脉水化:0.9% NaCl 1ml/kg/h × 12h',
                    '密切关注有无过敏反应',
                    '造影后72小时内密切监测肾功能'
                ];
            } else {
                riskLevel = 'very-high';
                clinicalAction = '极高风险 - 避免检查';
                recommendations = [
                    '重度肾功能不全,极高风险',
                    '强烈建议避免使用造影剂',
                    '如必须检查,需内分泌科和肾内科会诊',
                    '考虑替代检查方法(MRI、超声等)',
                    '如无法避免,需透析准备'
                ];
            }

            if (age >= 75 && eGFR < 60) {
                recommendations.unshift('高龄患者,增加监测频次');
            }
            
            return { 
                riskLevel, 
                recommendations, 
                clinicalAction,
                riskScore: calculateRiskScore(eGFR, age, dose)
            };
        }

        function calculateRiskScore(eGFR, age, dose) {
            let score = 0;
            
            if (eGFR >= 60) score += 1;
            else if (eGFR >= 45) score += 2;
            else if (eGFR >= 30) score += 3;
            else score += 4;
            
            if (age >= 75) score += 1;
            else if (age >= 65) score += 0.5;
            
            const doseNum = parseInt(dose);
            if (doseNum >= 2000) score += 1;
            else if (doseNum >= 1500) score += 0.5;
            
            return score;
        }

        function calculateAllergyRiskScore() {
            let score = 0;
            
            const previousReaction = document.querySelector('input[name="previousReaction"]:checked');
            if (previousReaction) {
                switch(previousReaction.value) {
                    case 'mild': score += 1; break;
                    case 'moderate': 
                    case 'severe': score += 3; break;
                }
            }
            
            if (document.getElementById('drug-multiple')?.checked) score += 2;
            if (document.getElementById('drug-severe-allergy')?.checked) score += 3;
            
            if (document.getElementById('food-seafood')?.checked || 
                document.getElementById('food-nuts')?.checked) score += 1;
            
            const asthma = document.querySelector('input[name="asthma"]:checked');
            if (asthma) {
                switch(asthma.value) {
                    case 'mild': score += 1; break;
                    case 'severe': score += 2; break;
                    case 'allergic': score += 3; break;
                }
            }
            
            if (document.getElementById('other-rhinitis')?.checked) score += 1;
            if (document.getElementById('other-eczema')?.checked) score += 1;
            if (document.getElementById('special-mastocytosis')?.checked) score += 2;
            
            return score;
        }

        function assessAllergyRisk(score) {
            let riskLevel, riskText, riskColor, reactionRate, strategy, premedication;
            
            if (score === 0) {
                riskLevel = 'minimal';
                riskText = '无明显风险';
                riskColor = 'score-minimal';
                reactionRate = '0.1-0.5%';
                strategy = '标准监测';
                premedication = '无需预处理,常规监测即可';
            } else if (score === 1) {
                riskLevel = 'low';
                riskText = '低风险';
                riskColor = 'score-low';
                reactionRate = '1-2%';
                strategy = '考虑预处理';
                premedication = '可考虑检查前1小时给予苯海拉明25mg口服';
            } else if (score >= 2 && score <= 3) {
                riskLevel = 'moderate';
                riskText = '中等风险';
                riskColor = 'score-moderate';
                reactionRate = '2-5%';
                strategy = '标准预处理方案';
                premedication = `检查前13小时:强的松50mg口服\n检查前1小时:苯海拉明50mg肌注或口服`;
            } else if (score >= 4 && score <= 5) {
                riskLevel = 'high';
                riskText = '高风险';
                riskColor = 'score-high';
                reactionRate = '5-10%';
                strategy = '强化预处理+专科评估';
                premedication = `检查前13小时和7小时:甲泼尼龙40mg IV\n检查前1小时:苯海拉明50mg IV + 雷尼替丁50mg IV\n建议过敏科会诊评估`;
            } else {
                riskLevel = 'very-high';
                riskText = '极高风险';
                riskColor = 'score-very-high';
                reactionRate = '10-30%';
                strategy = '避免使用或过敏科会诊';
                premedication = `强烈建议避免造影剂检查\n如必须检查:过敏科会诊,ICU监护条件下进行\n紧急预处理:检查前4-6小时,甲泼尼龙40mg IV,每4小时一次,共3次`;
            }
            
            const recommendations = generateAllergyRecommendations(score);
            const emergencyPrep = generateEmergencyPreparation(riskLevel);
            
            return {
                riskLevel,
                riskText,
                riskColor,
                reactionRate,
                strategy,
                premedication,
                recommendations,
                emergencyPrep,
                contrastChoice: generateContrastChoice(riskLevel)
            };
        }

        function generateAllergyRecommendations(score) {
            const recommendations = [];
            
            if (score === 0) {
                recommendations.push(
                    '常规生命体征监测',
                    '观察皮肤和呼吸道变化',
                    '检查后观察30分钟'
                );
            } else if (score === 1) {
                recommendations.push(
                    '密切观察前30分钟',
                    '准备抗过敏药物',
                    '患者教育:及时报告不适'
                );
            } else if (score >= 2 && score <= 3) {
                recommendations.push(
                    '建立可靠静脉通路',
                    '连续心电监护',
                    '血压、血氧饱和度监测',
                    '准备肾上腺素、激素等急救药物',
                    '检查后观察1-2小时'
                );
            } else if (score >= 4 && score <= 5) {
                recommendations.push(
                    '多路静脉通路',
                    '连续监护设备',
                    '麻醉科或ICU医师在场',
                    '气管插管设备准备',
                    '完善的过敏反应抢救方案',
                    '检查后观察4-6小时'
                );
            } else {
                recommendations.push(
                    '强烈建议重新评估检查必要性',
                    '考虑MRI、超声等替代方法',
                    '如无法避免:过敏科联合会诊',
                    'ICU监护条件下进行',
                    '完整的过敏反应抢救团队'
                );
            }
            
            return recommendations;
        }

        function generateEmergencyPreparation(riskLevel) {
            const prep = {
                medications: [],
                equipment: [],
                personnel: []
            };
            
            prep.medications.push(
                '肾上腺素 1:1000',
                '甲泼尼龙 40-125mg',
                '苯海拉明 25-50mg',
                '雷尼替丁 50mg'
            );
            
            prep.equipment.push(
                '心电监护设备',
                '血压监测',
                '脉搏血氧仪',
                '氧气供应系统',
                '静脉输液用品'
            );
            
            if (riskLevel === 'high' || riskLevel === 'very-high') {
                prep.medications.push(
                    '多巴胺',
                    '去甲肾上腺素',
                    '氨茶碱',
                    '地塞米松'
                );
                
                prep.equipment.push(
                    '气管插管设备',
                    '简易呼吸器',
                    '除颤器',
                    '中心静脉置管包'
                );
                
                prep.personnel.push(
                    '经验丰富的放射科医师',
                    '麻醉科医师',
                    '急救护士'
                );
            }
            
            if (riskLevel === 'very-high') {
                prep.personnel.push(
                    '过敏科医师',
                    'ICU医师',
                    '急救团队'
                );
            }
            
            return prep;
        }

        function generateContrastChoice(riskLevel) {
            let choice = '';
            
            switch(riskLevel) {
                case 'minimal':
                case 'low':
                    choice = '标准低渗造影剂(如碘海醇、碘普罗胺)';
                    break;
                case 'moderate':
                    choice = '低渗造影剂,首选碘克沙醇(等渗)';
                    break;
                case 'high':
                    choice = '等渗造影剂(碘克沙醇),考虑皮试';
                    break;
                case 'very-high':
                    choice = '强烈建议避免使用,考虑MRI增强或超声检查';
                    break;
            }
            
            return choice;
        }

        function setupCheckboxExclusivity() {
            const drugGroup = document.getElementById('drugAllergyGroup');
            const foodGroup = document.getElementById('foodAllergyGroup');
            
            if (drugGroup) {
                drugGroup.addEventListener('change', function(e) {
                    if (e.target.type === 'checkbox' && e.target.dataset.group === 'drug') {
                        if (e.target.id === 'drug-none' && e.target.checked) {
                            drugGroup.querySelectorAll('input[type="checkbox"]:not(#drug-none)').forEach(cb => {
                                cb.checked = false;
                            });
                        } else if (e.target.id !== 'drug-none' && e.target.checked) {
                            document.getElementById('drug-none').checked = false;
                        }
                    }
                });
            }
            
            if (foodGroup) {
                foodGroup.addEventListener('change', function(e) {
                    if (e.target.type === 'checkbox' && e.target.dataset.group === 'food') {
                        if (e.target.id === 'food-none' && e.target.checked) {
                            foodGroup.querySelectorAll('input[type="checkbox"]:not(#food-none)').forEach(cb => {
                                cb.checked = false;
                            });
                        } else if (e.target.id !== 'food-none' && e.target.checked) {
                            document.getElementById('food-none').checked = false;
                        }
                    }
                });
            }
        }

        function setupRealTimeValidation() {
            const validationRules = {
                Height: { min: 100, max: 250, message: '身高必须在100-250cm之间' },
                Weight: { min: 20, max: 200, message: '体重必须在20-200kg之间' },
                Creatinine: { min: 30, max: 500, message: '血肌酐值必须在30-500μmol/L之间' },
                Age: { min: 18, max: 120, message: '年龄必须在18-120岁之间' },
                EF: { min: 10, max: 80, message: 'EF值必须在10-80%之间' }
            };

            ['normal', 'renal', 'metformin', 'heart'].forEach(type => {
                Object.keys(validationRules).forEach(fieldType => {
                    const fieldId = type + fieldType;
                    const field = document.getElementById(fieldId);
                    const validation = document.getElementById(`${fieldId}-validation`);
                    const error = document.getElementById(`${fieldId}-error`);
                    
                    if (field) {
                        field.addEventListener('input', function() {
                            validateField(this, validationRules[fieldType], validation, error);
                            updateProgress();
                            
                            if (fieldType === 'Creatinine' && (type === 'renal' || type === 'metformin')) {
                                updateFormulaDisplay(type);
                            }
                            
                            if (type === 'heart' && (fieldType === 'Creatinine' || fieldType === 'Age')) {
                                updateHeartFormulaDisplay();
                            }
                        });
                    }
                });
            });
        }

        function validateField(field, rule, validationEl, errorEl) {
            const value = parseFloat(field.value);
            const isValid = !isNaN(value) && value >= rule.min && value <= rule.max;
            
            if (field.value === '') {
                field.classList.remove('input-error');
                if (validationEl) validationEl.textContent = '';
                if (errorEl) errorEl.style.display = 'none';
                return null;
            }
            
            if (isValid) {
                field.classList.remove('input-error');
                if (validationEl) {
                    validationEl.textContent = '✓';
                    validationEl.className = 'real-time-validation validation-success';
                }
                if (errorEl) errorEl.style.display = 'none';
                return true;
            } else {
                field.classList.add('input-error');
                if (validationEl) {
                    validationEl.textContent = '✗';
                    validationEl.className = 'real-time-validation validation-error';
                }
                if (errorEl) errorEl.style.display = 'block';
                return false;
            }
        }

        document.addEventListener('change', function(e) {
            if (e.target.name === 'previousContrast') {
                const historyDetails = document.getElementById('contrastHistoryDetails');
                if (e.target.value === 'yes') {
                    historyDetails.style.display = 'block';
                } else {
                    historyDetails.style.display = 'none';
                    document.querySelectorAll('input[name="previousReaction"]').forEach(r => r.checked = false);
                }
                updateAllergyRiskScore();
            }
            
            if (e.target.closest('#allergyForm')) {
                updateAllergyRiskScore();
            }
        });

        function updateAllergyRiskScore() {
            if (appState.currentPatientType !== 'allergy') return;
            
            const score = calculateAllergyRiskScore();
            appState.allergyRiskScore = score;
            
            const riskAssessment = assessAllergyRisk(score);
            const scoreDisplay = document.getElementById('allergyRiskScore');
            const scoreValue = document.getElementById('riskScoreValue');
            const riskLevelText = document.getElementById('riskLevelText');
            
            if (scoreDisplay && scoreValue && riskLevelText) {
                scoreValue.textContent = score;
                scoreValue.className = `score-value ${riskAssessment.riskColor}`;
                riskLevelText.innerHTML = `
                    <div style="font-size: 1.2em; margin-bottom: 5px; font-weight: 600;">${riskAssessment.riskText} (${riskAssessment.reactionRate})</div>
                    <div style="font-size: 0.9em; opacity: 0.8;">${riskAssessment.strategy}</div>
                `;
                scoreDisplay.style.display = 'block';
            }
            
            updateProgress();
        }

        function updateProgress() {
            if (!appState.currentPatientType) {
                const progressBar = document.getElementById('progress');
                if (progressBar) progressBar.style.width = '0%';
                const calculateBtn = document.getElementById('calculateBtn');
                if (calculateBtn) calculateBtn.disabled = true;
                return;
            }
            
            let progress = 0;
            
            if (appState.currentPatientType === 'allergy') {
                let totalFields = 3;
                let completedFields = 0;
                
                const previousContrast = document.querySelector('input[name="previousContrast"]:checked');
                if (previousContrast) {
                    if (previousContrast.value === 'no') {
                        completedFields += 1;
                    } else if (previousContrast.value === 'yes') {
                        const previousReaction = document.querySelector('input[name="previousReaction"]:checked');
                        if (previousReaction) {
                            completedFields += 1;
                        }
                    }
                }
                
                if (document.querySelector('#drugAllergyGroup input:checked')) {
                    completedFields += 1;
                }
                
                if (document.querySelector('input[name="asthma"]:checked')) {
                    completedFields += 1;
                }
                
                progress = (completedFields / totalFields) * 100;
            } else {
                const requiredFields = getRequiredFields(appState.currentPatientType);
                let completedFields = 0;
                
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && field.value !== '') {
                        completedFields++;
                    }
                });
                
                progress = (completedFields / requiredFields.length) * 100;
            }
            
            const progressBar = document.getElementById('progress');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
            
            const calculateBtn = document.getElementById('calculateBtn');
            if (calculateBtn) {
                const threshold = appState.currentPatientType === 'allergy' ? 66 : 80;
                calculateBtn.disabled = progress < threshold;
            }
        }

        function getRequiredFields(type) {
            const baseFields = [`${type}Height`, `${type}Weight`];
            
            if (type === 'renal' || type === 'metformin') {
                baseFields.push(`${type}Creatinine`, `${type}Age`);
            } else if (type === 'heart') {
                baseFields.push(`${type}EF`);
            }
            
            return baseFields;
        }

        function calculate() {
            if (!appState.currentPatientType) {
                showNotification('请先选择评估类型', 'error');
                return;
            }
            
            try {
                let results;
                
                if (appState.currentPatientType === 'allergy') {
                    results = calculateAllergyAssessment();
                } else {
                    results = calculateContrastDosage();
                }
                
                displayResults(results);
                appState.currentResults = results;
                document.getElementById('pdfBtn').disabled = false;
                showNotification('评估计算完成!', 'success');
            } catch (error) {
                console.error('计算过程出错:', error);
                showNotification('计算过程中出现错误:' + error.message, 'error');
            }
        }

        function calculateAllergyAssessment() {
            const score = calculateAllergyRiskScore();
            const riskAssessment = assessAllergyRisk(score);
            
            const previousContrast = document.querySelector('input[name="previousContrast"]:checked')?.value || 'unknown';
            const previousReaction = document.querySelector('input[name="previousReaction"]:checked')?.value || 'none';
            const asthma = document.querySelector('input[name="asthma"]:checked')?.value || 'none';
            
            const selectedRiskFactors = [];
            document.querySelectorAll('#allergyForm input:checked').forEach(input => {
                const label = document.querySelector(`label[for="${input.id}"]`);
                if (label && !input.name) {
                    selectedRiskFactors.push(label.textContent.trim());
                }
            });
            
            return {
                patientType: 'allergy',
                score,
                riskAssessment,
                previousContrast,
                previousReaction,
                asthma,
                selectedRiskFactors,
                timestamp: new Date()
            };
        }

        function calculateContrastDosage() {
            const type = appState.currentPatientType;
            
            const heightElement = document.getElementById(`${type}Height`);
            const weightElement = document.getElementById(`${type}Weight`);
            const heartRateElement = type === 'heart' ? 
                document.getElementById('heartRate') : 
                document.getElementById(`${type}HeartRate`);
            const examTypeElement = document.getElementById(`${type}ExamType`);
            
            if (!heightElement || !weightElement || !heartRateElement || !examTypeElement) {
                throw new Error('表单元素缺失,请检查输入');
            }
            
            const height = parseFloat(heightElement.value);
            const weight = parseFloat(weightElement.value);
            const heartRate = parseInt(heartRateElement.value);
            const examType = examTypeElement.value;

            if (!height || height < 100 || height > 250) {
                throw new Error('身高范围应在100-250cm之间');
            }
            if (!weight || weight < 20 || weight > 200) {
                throw new Error('体重范围应在20-200kg之间');
            }

            let specialData = null;
            
            if (type === 'renal' || type === 'metformin') {
                const creatinine = parseFloat(document.getElementById(`${type}Creatinine`).value);
                const age = parseInt(document.getElementById(`${type}Age`).value);
                const gender = document.getElementById(`${type}Gender`).value;

                if (!creatinine || creatinine < 30 || creatinine > 500) {
                    throw new Error('血肌酐值范围应在30-500 μmol/L之间');
                }
                if (!age || age < 18 || age > 120) {
                    throw new Error('年龄范围应在18-120岁之间');
                }

                const eGFR = calculateEGFR_2021_Corrected(creatinine, age, gender);
                const eGFRDetails = generateSimplifiedEGFRCalculation(creatinine, age, gender);
                
                specialData = {
                    eGFR,
                    creatinine,
                    age,
                    gender,
                    calculationMethod: '2021版CKD-EPI公式',
                    eGFRDetails
                };
                
                if (type === 'metformin') {
                    const dose = document.getElementById('metforminDose').value;
                    const metforminRisk = assessMetforminRisk(eGFR, dose, age);
                    specialData.metforminRisk = metforminRisk;
                    specialData.dose = dose;
                }
            } else if (type === 'heart') {
                const nyha = document.getElementById('heartNYHA').value;
                const ef = parseFloat(document.getElementById('heartEF').value);
                const bnp = document.getElementById('heartBNP').value;
                const creatinine = parseFloat(document.getElementById('heartCreatinine').value) || null;
                const age = parseInt(document.getElementById('heartAge').value) || null;
                const gender = document.getElementById('heartGender').value;

                if (!ef || ef < 10 || ef > 80) {
                    throw new Error('EF值范围应在10-80%之间');
                }

                let eGFR = null;
                let eGFRDetails = null;
                if (creatinine && creatinine >= 30 && creatinine <= 500 && age) {
                    eGFR = calculateEGFR_2021_Corrected(creatinine, age, gender);
                    eGFRDetails = generateSimplifiedEGFRCalculation(creatinine, age, gender);
                }

                const heartRisk = assessHeartFailureRisk(nyha, ef, bnp, eGFR);
                specialData = {
                    nyha,
                    ef,
                    bnp,
                    heartRisk,
                    creatinine,
                    age,
                    gender,
                    eGFR,
                    eGFRDetails
                };
            }

            return performCalculations(height, weight, heartRate, examType, type, specialData);
        }

        function performCalculations(height, weight, heartRate, examType, patientType, specialData) {
            const bmi = weight / Math.pow(height / 100, 2);
            
            let contrastVolume;
            let maxVolume;
            
            if (examType === 'coronary') {
                contrastVolume = weight * (heartRate <= 80 ? 0.8 : 0.85);
                maxVolume = 60;
            } else {
                contrastVolume = weight * (heartRate <= 80 ? 0.8 : 0.85) + 15;
                maxVolume = 75;
            }

            let contrastAdjustments = [];
            
            if ((patientType === 'renal' || patientType === 'metformin') && specialData && specialData.eGFR < 45) {
                const originalVolume = contrastVolume;
                contrastVolume = contrastVolume * 0.8;
                contrastAdjustments.push(`肾功能不全调整:${originalVolume.toFixed(1)}ml → ${contrastVolume.toFixed(1)}ml (减量20%)`);
            }
            
            if (patientType === 'heart' && specialData) {
                const risk = specialData.heartRisk;
                let reductionFactor = 1;
                
                if (risk.riskLevel === 'moderate') reductionFactor = 0.85;
                else if (risk.riskLevel === 'high') reductionFactor = 0.70;
                else if (risk.riskLevel === 'very-high') reductionFactor = 0.50;
                
                if (reductionFactor < 1) {
                    const originalVolume = contrastVolume;
                    contrastVolume = contrastVolume * reductionFactor;
                    contrastAdjustments.push(`心功能不全调整:${originalVolume.toFixed(1)}ml → ${contrastVolume.toFixed(1)}ml (减量${((1-reductionFactor)*100).toFixed(0)}%)`);
                }
                
                if (specialData.eGFR && specialData.eGFR < 45) {
                    const originalVolume = contrastVolume;
                    contrastVolume = contrastVolume * 0.8;
                    contrastAdjustments.push(`心肾综合征额外调整:${originalVolume.toFixed(1)}ml → ${contrastVolume.toFixed(1)}ml (再减量20%)`);
                }
            }

            const isVolumeExceeded = contrastVolume > maxVolume;
            const originalVolume = contrastVolume;
            if (isVolumeExceeded) {
                contrastVolume = maxVolume;
            }

            let flowRate;
            if (examType === 'coronary') {
                flowRate = contrastVolume / 12;
            } else {
                flowRate = Math.max(contrastVolume - 15, 0) / 12;
            }

            if (patientType === 'heart' && specialData) {
                const risk = specialData.heartRisk;
                let maxFlowRate = 5.0;
                
                if (risk.riskLevel === 'moderate') maxFlowRate = 4.5;
                else if (risk.riskLevel === 'high') maxFlowRate = 4.0;
                else if (risk.riskLevel === 'very-high') maxFlowRate = 3.5;
                
                if (flowRate > maxFlowRate) {
                    flowRate = maxFlowRate;
                }
            }

            const isFlowRateExceeded = flowRate > 5.0;
            const originalFlowRate = flowRate;
            if (isFlowRateExceeded) {
                flowRate = 5.0;
            }

            return {
                height, weight, heartRate, examType, bmi, patientType,
                contrastVolume, flowRate, maxVolume,
                isVolumeExceeded, originalVolume,
                isFlowRateExceeded, originalFlowRate,
                specialData, 
                contrastAdjustments,
                timestamp: new Date()
            };
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('calculationResults');
            
            if (results.patientType === 'allergy') {
                displayAllergyResults(results, resultsContent);
            } else {
                displayContrastResults(results, resultsContent);
            }
            
            resultsDiv.classList.add('show');
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function displayAllergyResults(results, container) {
            const assessment = results.riskAssessment;
            const riskColorClass = assessment.riskColor.replace('score-', 'grade-');
            
            let previousContrastText = '';
            if (results.previousContrast === 'yes') {
                const reactionTexts = {
                    'none': '无反应',
                    'mild': '轻微反应',
                    'moderate': '中度反应',
                    'severe': '严重反应'
                };
                previousContrastText = `既往使用过造影剂,反应情况:${reactionTexts[results.previousReaction] || '未知'}`;
            } else {
                previousContrastText = '既往未使用过造影剂';
            }

            const asthmaTexts = {
                'none': '无哮喘病史',
                'mild': '轻度哮喘',
                'severe': '重度哮喘', 
                'allergic': '哮喘伴过敏史'
            };

            container.innerHTML = `
                <div class="calc-type">
                    <div>造影剂过敏风险评估 | 2024版评估标准</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">
                        评估时间:${results.timestamp.toLocaleString()}
                    </div>
                </div>
                
                <div class="risk-score-display">
                    <div class="score-value ${assessment.riskColor}">${results.score}</div>
                    <div style="font-size: 1.2em; margin-bottom: 5px; font-weight: 600; color: var(--${riskColorClass}-color);">${assessment.riskText}</div>
                    <div style="font-size: 0.9em; opacity: 0.8;">反应发生率:${assessment.reactionRate}</div>
                </div>

                <div class="result-item">
                    <span class="result-label">既往造影剂使用史</span>
                    <span class="result-value">${previousContrastText}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">哮喘病史</span>
                    <span class="result-value">${asthmaTexts[results.asthma] || '未评估'}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">风险评分</span>
                    <span class="result-value" style="color: var(--${riskColorClass}-color);">${results.score} 分</span>
                </div>
                <div class="result-item">
                    <span class="result-label">风险等级</span>
                    <span class="result-value" style="color: var(--${riskColorClass}-color);">${assessment.riskText}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">处理策略</span>
                    <span class="result-value">${assessment.strategy}</span>
                </div>

                ${results.selectedRiskFactors.length > 0 ? `
                <div class="info-box allergy">
                    <strong>已识别的风险因素:</strong><br>
                    ${results.selectedRiskFactors.map(factor => `• ${factor}`).join('<br>')}
                </div>
                ` : ''}

                <div class="info-box ${riskColorClass}">
                    <strong>预处理方案:</strong><br>
                    ${assessment.premedication.split('\n').join('<br>')}
                </div>

                <div class="info-box normal">
                    <strong>临床监护建议:</strong><br>
                    ${assessment.recommendations.map(rec => `• ${rec}`).join('<br>')}
                </div>

                <div class="info-box normal">
                    <strong>造影剂选择建议:</strong><br>
                    ${assessment.contrastChoice}
                </div>

                <div class="info-box normal">
                    <strong>应急药物准备:</strong><br>
                    <strong>必备药物:</strong>${assessment.emergencyPrep.medications.join('、')}<br>
                    <strong>必备设备:</strong>${assessment.emergencyPrep.equipment.join('、')}
                    ${assessment.emergencyPrep.personnel.length > 0 ? `<br><strong>人员要求:</strong>${assessment.emergencyPrep.personnel.join('、')}` : ''}
                </div>
            `;
        }

        function displayContrastResults(results, container) {
            let bmiStatus, bmiClass;
            if (results.bmi < 18.5) {
                bmiStatus = '偏瘦';
                bmiClass = 'info-box renal';
            } else if (results.bmi < 24) {
                bmiStatus = '正常';
                bmiClass = 'info-box normal';
            } else if (results.bmi < 28) {
                bmiStatus = '超重';
                bmiClass = 'info-box renal';
            } else {
                bmiStatus = '肥胖';
                bmiClass = 'info-box renal';
            }

            const examTypeText = results.examType === 'coronary' ? '冠脉CTA' : '胸痛三联';
            const heartRateText = results.heartRate <= 80 ? '≤80次/分' : '>80次/分';
            
            let patientTypeText = '';
            switch(results.patientType) {
                case 'normal': patientTypeText = '正常患者'; break;
                case 'renal': patientTypeText = '肾功能异常患者'; break;
                case 'metformin': patientTypeText = '二甲双胍用药患者'; break;
                case 'heart': patientTypeText = '心功能不全患者'; break;
            }

            let specialAssessment = '';
            
            if (results.patientType === 'normal') {
                specialAssessment = `
                    <div class="info-box normal">
                        <strong>正常患者处理流程:</strong><br>
                        • 肾功能正常,无需特殊评估<br>
                        • 按标准流程进行造影检查<br>
                        • 常规监测,无特殊风险
                    </div>
                `;
            } else if (results.patientType === 'renal' && results.specialData) {
                const data = results.specialData;
                let renalRisk = '';
                let riskClass = '';
                
                if (data.eGFR >= 60) {
                    renalRisk = '肾功能正常';
                    riskClass = 'normal';
                } else if (data.eGFR >= 45) {
                    renalRisk = '轻度肾功能不全';
                    riskClass = 'renal';
                } else if (data.eGFR >= 30) {
                    renalRisk = '中度肾功能不全';
                    riskClass = 'renal';
                } else {
                    renalRisk = '重度肾功能不全';
                    riskClass = 'metformin';
                }
                
                const recommendations = [];
                if (data.eGFR >= 60) {
                    recommendations.push('按标准流程检查', '常规水化治疗', '造影后常规监测');
                } else if (data.eGFR >= 45) {
                    recommendations.push('适当减少造影剂用量', '加强水化治疗', '造影后24-48小时复查肾功能');
                } else if (data.eGFR >= 30) {
                    recommendations.push('造影剂用量减至80%', '充分静脉水化', '密切关注有无过敏反应', '密切监测48-72小时');
                } else {
                    recommendations.push('强烈建议避免造影剂检查', '考虑MRI、超声等替代检查', '如必须检查需肾内科会诊');
                }
                
                specialAssessment = `
                    <div class="result-item">
                        <span class="result-label">血肌酐值</span>
                        <span class="result-value">${data.creatinine} μmol/L</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">eGFR</span>
                        <span class="result-value">${data.eGFR} ml/min/1.73m²</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">肾功能评估</span>
                        <span class="result-value" style="color: var(--${riskClass}-color);">${renalRisk}</span>
                    </div>
                    <div class="info-box ${riskClass}">
                        <strong>临床处理建议:</strong><br>
                        ${recommendations.map(rec => `• ${rec}`).join('<br>')}
                    </div>
                `;
            } else if (results.patientType === 'metformin' && results.specialData) {
                const data = results.specialData;
                const risk = data.metforminRisk;
                
                let riskColor = '';
                switch(risk.riskLevel) {
                    case 'low': riskColor = 'var(--normal-color)'; break;
                    case 'moderate': riskColor = 'var(--renal-color)'; break;
                    case 'high': 
                    case 'very-high': riskColor = 'var(--metformin-color)'; break;
                }
                
                specialAssessment = `
                    <div class="result-item">
                        <span class="result-label">血肌酐值</span>
                        <span class="result-value">${data.creatinine} μmol/L</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">eGFR</span>
                        <span class="result-value">${data.eGFR} ml/min/1.73m²</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">二甲双胍剂量</span>
                        <span class="result-value">${data.dose}mg/日</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">风险等级</span>
                        <span class="result-value" style="color: ${riskColor};">${risk.clinicalAction}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">风险评分</span>
                        <span class="result-value">${risk.riskScore.toFixed(1)} 分</span>
                    </div>
                    <div class="info-box ${risk.riskLevel === 'low' ? 'normal' : risk.riskLevel === 'moderate' ? 'renal' : 'metformin'}">
                        <strong>临床处理建议:</strong><br>
                        ${risk.recommendations.map(rec => `• ${rec}`).join('<br>')}
                    </div>
                `;
            } else if (results.patientType === 'heart' && results.specialData) {
                const data = results.specialData;
                const risk = data.heartRisk;
                
                let riskColor = '';
                switch(risk.riskLevel) {
                    case 'low': riskColor = 'var(--normal-color)'; break;
                    case 'moderate': riskColor = 'var(--heart-color)'; break;
                    case 'high': riskColor = 'var(--renal-color)'; break;
                    case 'very-high': riskColor = 'var(--metformin-color)'; break;
                }
                
                const nyhaText = ['I级 - 活动不受限制', 'II级 - 轻度活动受限', 'III级 - 明显活动受限', 'IV级 - 休息时也有症状'][parseInt(data.nyha) - 1];
                
                specialAssessment = `
                    <div class="result-item">
                        <span class="result-label">NYHA分级</span>
                        <span class="result-value">${nyhaText}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">左室射血分数</span>
                        <span class="result-value">${data.ef}%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">BNP水平</span>
                        <span class="result-value">${
                            data.bnp === 'normal' ? '正常范围' :
                            data.bnp === 'mild' ? '轻度升高' :
                            data.bnp === 'moderate' ? '中度升高' : '重度升高'
                        }</span>
                    </div>
                    ${data.creatinine ? `
                        <div class="result-item">
                            <span class="result-label">血肌酐值</span>
                            <span class="result-value">${data.creatinine} μmol/L</span>
                        </div>
                    ` : ''}
                    ${data.eGFR ? `
                        <div class="result-item">
                            <span class="result-label">eGFR (心肾评估)</span>
                            <span class="result-value">${data.eGFR} ml/min/1.73m²</span>
                        </div>
                    ` : ''}
                    <div class="result-item">
                        <span class="result-label">风险等级</span>
                        <span class="result-value" style="color: ${riskColor};">${risk.clinicalAction}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">风险评分</span>
                        <span class="result-value">${risk.riskScore} 分</span>
                    </div>
                    <div class="info-box ${risk.riskLevel === 'low' ? 'normal' : risk.riskLevel === 'moderate' ? 'heart' : risk.riskLevel === 'high' ? 'renal' : 'metformin'}">
                        <strong>临床处理建议:</strong><br>
                        ${risk.recommendations.map(rec => `• ${rec}`).join('<br>')}
                    </div>
                `;
            }

            let limitWarning = '';
            if (results.isVolumeExceeded) {
                limitWarning += `
                    <div class="info-box renal">
                        <strong>造影剂用量限制提示:</strong><br>
                        理论计算用量:${results.originalVolume.toFixed(1)}ml<br>
                        安全限制用量:${results.contrastVolume.toFixed(1)}ml(${examTypeText}最大用量:${results.maxVolume}ml)<br>
                        <strong>建议:</strong>已应用安全上限,请结合患者具体情况评估。
                    </div>
                `;
            }
            
            if (results.isFlowRateExceeded) {
                limitWarning += `
                    <div class="info-box renal">
                        <strong>注射流速限制提示:</strong><br>
                        理论计算流速:${results.originalFlowRate.toFixed(2)}ml/s<br>
                        安全限制流速:${results.flowRate.toFixed(2)}ml/s(最大流速:5.0ml/s)<br>
                        <strong>建议:</strong>已应用安全上限,可考虑延长注射时间或调整方案。
                    </div>
                `;
            }

            if (results.contrastAdjustments && results.contrastAdjustments.length > 0) {
                limitWarning += `
                    <div class="info-box renal">
                        <strong>特殊调整提示:</strong><br>
                        ${results.contrastAdjustments.map(adj => `• ${adj}`).join('<br>')}<br>
                        <strong>原因:</strong>${
                            results.patientType === 'heart' ? '心功能不全患者减少造影剂用量以降低容量负荷' :
                            '肾功能不全患者减少造影剂用量以降低肾毒性风险'
                        }。
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="calc-type">
                    <div>患者类型:${patientTypeText} | 检查:${examTypeText} | 心率:${heartRateText}</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">
                        计算时间:${results.timestamp.toLocaleString()}
                    </div>
                </div>
                
                <div class="result-item">
                    <span class="result-label">身高</span>
                    <span class="result-value">${results.height} cm</span>
                </div>
                <div class="result-item">
                    <span class="result-label">体重</span>
                    <span class="result-value">${results.weight} kg</span>
                </div>
                <div class="result-item">
                    <span class="result-label">BMI指数</span>
                    <span class="result-value">${results.bmi.toFixed(2)}</span>
                </div>
                
                <div class="${bmiClass}">
                    <strong>BMI评估:</strong>${bmiStatus}
                </div>
                
                ${specialAssessment}
                
                <div class="result-item">
                    <span class="result-label">造影剂用量</span>
                    <span class="result-value" style="color: ${results.isVolumeExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.contrastVolume.toFixed(1)} ml
                    </span>
                </div>
                <div class="result-item">
                    <span class="result-label">注射流速</span>
                    <span class="result-value" style="color: ${results.isFlowRateExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.flowRate.toFixed(2)} ml/s
                    </span>
                </div>
                
                ${limitWarning}
                
                <div class="info-box normal">
                    <strong>计算依据:</strong><br>
                    <strong>eGFR公式:</strong>2021版CKD-EPI肾小球滤过率方程(无种族系数)<br>
                    <strong>造影剂用量:</strong>${results.examType === 'coronary' ? 
                        (results.heartRate <= 80 ? '冠脉CTA心率≤80:体重×0.8ml/kg' : '冠脉CTA心率>80:体重×0.85ml/kg') :
                        (results.heartRate <= 80 ? '胸痛三联心率≤80:体重×0.8ml/kg + 15ml' : '胸痛三联心率>80:体重×0.85ml/kg + 15ml')
                    }<br>
                    <strong>注射流速:</strong>${results.examType === 'coronary' ? '用量÷12s' : '(用量-15ml)÷12s (所有调整后的最终用量)'}<br>
                    <strong>安全限制:</strong>${results.examType === 'coronary' ? '冠脉CTA最大60ml' : '胸痛三联最大75ml'},流速最大5.0ml/s<br>
                    <strong>程序版本:</strong>v4.2混合版本
                </div>
            `;
        }

        function exportToPDF() {
            if (!appState.currentResults) {
                showNotification('没有可导出的评估结果', 'warning');
                return;
            }
            
            try {
                const results = appState.currentResults;
                const reportId = Date.now().toString(36).toUpperCase();
                const reportNumber = `${new Date().getFullYear()}${(new Date().getMonth() + 1).toString().padStart(2, '0')}${new Date().getDate().toString().padStart(2, '0')}_${reportId}`;
                
                const pdfWindow = window.open('', '_blank', 'width=800,height=600');
                if (!pdfWindow) {
                    showNotification('浏览器阻止了弹窗,请允许弹窗后重试', 'warning');
                    return;
                }
                
                // 关键:过敏评估使用专门PDF格式,其他使用详细PDF格式
                const pdfContent = results.patientType === 'allergy' ? 
                    generateAllergyPDFContent(results, reportNumber) : 
                    generateDetailedPDFContent(results, reportNumber);
                
                pdfWindow.document.write(pdfContent);
                pdfWindow.document.close();
                
                if (pdfWindow.document.readyState === 'complete') {
                    setTimeout(() => pdfWindow.print(), 500);
                } else {
                    pdfWindow.addEventListener('load', function() {
                        setTimeout(() => pdfWindow.print(), 500);
                    });
                }
                
                showNotification('请在打印对话框中选择"保存为PDF"', 'info');
                
            } catch (error) {
                console.error('PDF导出出错:', error);
                showNotification('PDF导出失败: ' + error.message, 'error');
            }
        }

        // 过敏评估专用PDF格式
        function generateAllergyPDFContent(results, reportNumber) {
            const currentDate = new Date().toLocaleString();
            const assessment = results.riskAssessment;
            
            return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>造影剂过敏风险评估报告_${reportNumber}</title>
    <style>
        @page { size: A4; margin: 1cm; }
        body { 
            font-family: 'Microsoft YaHei', 'SimSun', sans-serif; 
            line-height: 1.4; 
            color: #333; 
            margin: 0; 
            padding: 0; 
            font-size: 11px; 
        }
        .header { 
            text-align: center; 
            border-bottom: 2px solid #8b5cf6; 
            padding-bottom: 10px; 
            margin-bottom: 20px; 
        }
        .header h1 { 
            color: #8b5cf6; 
            font-size: 20px; 
            margin: 0 0 8px 0; 
            font-weight: 700; 
        }
        .risk-score-section {
            text-align: center;
            background: linear-gradient(135deg, #e9d5ff, #d8b4fe);
            border: 2px solid #8b5cf6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .risk-score {
            font-size: 48px;
            font-weight: 700;
            color: #581c87;
            margin-bottom: 10px;
        }
        .risk-level {
            font-size: 16px;
            font-weight: 600;
            color: #581c87;
        }
        .section {
            margin: 15px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .section-title {
            font-weight: 700;
            color: #8b5cf6;
            font-size: 13px;
            margin-bottom: 8px;
        }
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 10px;
        }
        .recommendation-box {
            background: linear-gradient(135deg, #f8f9fa, #f1f3f4);
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
        }
        .footer {
            border-top: 1px solid #ddd;
            padding-top: 10px;
            text-align: center;
            font-size: 8px;
            color: #666;
            margin-top: 20px;
        }
        @media print { body { margin: 0; padding: 0; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>造影剂过敏风险评估报告</h1>
        <div>2024版评估标准 | 评估时间: ${results.timestamp.toLocaleString()}</div>
        <div>生成时间: ${currentDate} | 编号: ${reportNumber}</div>
    </div>
    
    <div class="risk-score-section">
        <div class="risk-score">${results.score}</div>
        <div class="risk-level">${assessment.riskText} | 反应发生率: ${assessment.reactionRate}</div>
    </div>
    
    <div class="section">
        <div class="section-title">风险评估结果</div>
        <div class="data-row">
            <span>风险评分</span>
            <span>${results.score} 分</span>
        </div>
        <div class="data-row">
            <span>风险等级</span>
            <span>${assessment.riskText}</span>
        </div>
        <div class="data-row">
            <span>反应发生率</span>
            <span>${assessment.reactionRate}</span>
        </div>
        <div class="data-row">
            <span>处理策略</span>
            <span>${assessment.strategy}</span>
        </div>
    </div>
    
    <div class="recommendation-box">
        <div class="section-title">预处理方案</div>
        <div style="font-size: 10px; line-height: 1.4;">
            ${assessment.premedication.split('\n').join('<br>')}
        </div>
    </div>
    
    <div class="recommendation-box">
        <div class="section-title">临床监护建议</div>
        <div style="font-size: 10px; line-height: 1.4;">
            ${assessment.recommendations.map(rec => `• ${rec}`).join('<br>')}
        </div>
    </div>
    
    <div class="recommendation-box">
        <div class="section-title">造影剂选择建议</div>
        <div style="font-size: 10px; line-height: 1.4;">
            ${assessment.contrastChoice}
        </div>
    </div>
    
    <div class="recommendation-box">
        <div class="section-title">应急准备</div>
        <div style="font-size: 10px; line-height: 1.4;">
            <strong>必备药物:</strong>${assessment.emergencyPrep.medications.join('、')}<br>
            <strong>必备设备:</strong>${assessment.emergencyPrep.equipment.join('、')}
            ${assessment.emergencyPrep.personnel.length > 0 ? `<br><strong>人员要求:</strong>${assessment.emergencyPrep.personnel.join('、')}` : ''}
        </div>
    </div>
    
    <div class="footer">
        <p><strong>重要声明:</strong> 本评估结果仅供学术研究参考,不能100%预测过敏反应。临床使用时必须结合患者具体情况,配备完善的抢救措施。</p>
        <p><strong>报告编号:</strong> ${reportNumber} | <strong>程序版本:</strong> v4.2混合版 | <strong>开发者:</strong> 影像涛哥</p>
    </div>
</body>
</html>`;
        }

        // 前四类患者详细PDF格式(沿用v3.4样式)
        function generateDetailedPDFContent(results, reportNumber) {
            const currentDate = new Date().toLocaleString();
            
            let bmiStatus = '';
            if (results.bmi < 18.5) bmiStatus = '偏瘦';
            else if (results.bmi < 24) bmiStatus = '正常';
            else if (results.bmi < 28) bmiStatus = '超重';
            else bmiStatus = '肥胖';
            
            const examTypeText = results.examType === 'coronary' ? '冠脉CTA' : '胸痛三联';
            const heartRateText = results.heartRate <= 80 ? '≤80次/分' : '>80次/分';
            
            let patientTypeText = '';
            switch(results.patientType) {
                case 'normal': patientTypeText = '正常患者'; break;
                case 'renal': patientTypeText = '肾功能异常患者'; break;
                case 'metformin': patientTypeText = '二甲双胍用药患者'; break;
                case 'heart': patientTypeText = '心功能不全患者'; break;
            }

            let patientSpecificInfo = '';
            
            if (results.patientType === 'normal') {
                patientSpecificInfo = `
                    <div class="data-row">
                        <span class="data-label">特殊评估</span>
                        <span class="data-value">无需特殊评估</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">处理方式</span>
                        <span class="data-value">标准流程</span>
                    </div>
                `;
            } else if (results.patientType === 'renal' && results.specialData) {
                const data = results.specialData;
                patientSpecificInfo = `
                    <div class="data-row">
                        <span class="data-label">性别年龄</span>
                        <span class="data-value">${data.gender === 'male' ? '男性' : '女性'} ${data.age}岁</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">血肌酐</span>
                        <span class="data-value">${data.creatinine} μmol/L</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">eGFR</span>
                        <span class="data-value">${data.eGFR} ml/min/1.73m²</span>
                    </div>
                `;
            } else if (results.patientType === 'metformin' && results.specialData) {
                const data = results.specialData;
                patientSpecificInfo = `
                    <div class="data-row">
                        <span class="data-label">性别年龄</span>
                        <span class="data-value">${data.gender === 'male' ? '男性' : '女性'} ${data.age}岁</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">血肌酐</span>
                        <span class="data-value">${data.creatinine} μmol/L</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">eGFR</span>
                        <span class="data-value">${data.eGFR} ml/min/1.73m²</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">二甲双胍剂量</span>
                        <span class="data-value">${data.dose} mg/日</span>
                    </div>
                `;
            } else if (results.patientType === 'heart' && results.specialData) {
                const data = results.specialData;
                const nyhaTexts = ['I级', 'II级', 'III级', 'IV级'];
                const bnpTexts = { 'normal': '正常', 'mild': '轻度升高', 'moderate': '中度升高', 'severe': '重度升高' };
                patientSpecificInfo = `
                    <div class="data-row">
                        <span class="data-label">NYHA分级</span>
                        <span class="data-value">${nyhaTexts[parseInt(data.nyha) - 1]}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">射血分数EF</span>
                        <span class="data-value">${data.ef}%</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">BNP水平</span>
                        <span class="data-value">${bnpTexts[data.bnp]}</span>
                    </div>
                    ${data.creatinine ? `
                    <div class="data-row">
                        <span class="data-label">血肌酐</span>
                        <span class="data-value">${data.creatinine} μmol/L</span>
                    </div>
                    ` : ''}
                `;
            }

            let assessmentResults = '';
            
            if (results.patientType === 'normal') {
                assessmentResults = `
                    <div class="assessment-section">
                        <div class="assessment-title">正常患者处理流程</div>
                        <div class="assessment-content">肾功能正常,无特殊用药史,按标准流程进行造影检查,常规监测即可</div>
                    </div>
                `;
            } else if (results.patientType === 'renal' && results.specialData) {
                const data = results.specialData;
                let riskLevel = data.eGFR >= 60 ? '低风险' : data.eGFR >= 45 ? '中风险' : data.eGFR >= 30 ? '高风险' : '极高风险';
                let riskColor = data.eGFR >= 60 ? '#22c55e' : data.eGFR >= 45 ? '#f59e0b' : '#ef4444';
                
                let clinicalRecommendation = '';
                if (data.eGFR >= 60) {
                    clinicalRecommendation = '标准流程,常规水化治疗,造影后常规监测';
                } else if (data.eGFR >= 45) {
                    clinicalRecommendation = '适当减量,加强水化治疗,造影后24-48小时复查肾功能';
                } else if (data.eGFR >= 30) {
                    clinicalRecommendation = '造影剂减量至80%,充分静脉水化,密切关注有无过敏反应,密切监测48-72小时';
                } else {
                    clinicalRecommendation = '强烈建议避免造影剂检查,考虑MRI、超声等替代检查方法';
                }

                assessmentResults = `
                    <div class="assessment-section">
                        <div class="assessment-title">肾功能评估结果</div>
                        <div class="assessment-content">
                            <span style="color: ${riskColor}; font-weight: bold;">${riskLevel}</span> | ${clinicalRecommendation}
                        </div>
                    </div>
                `;
            } else if (results.patientType === 'metformin' && results.specialData) {
                const data = results.specialData;
                const risk = data.metforminRisk;
                let riskColor = risk.riskLevel === 'low' ? '#22c55e' : risk.riskLevel === 'moderate' ? '#f59e0b' : '#ef4444';

                assessmentResults = `
                    <div class="assessment-section">
                        <div class="assessment-title">二甲双胍风险评估</div>
                        <div class="assessment-content">
                            风险评分${risk.riskScore.toFixed(1)}分, <span style="color: ${riskColor}; font-weight: bold;">${risk.clinicalAction}</span><br>
                            用药管理: 造影前${data.eGFR >= 60 ? '48小时' : '48-72小时'}停药,造影后${data.eGFR >= 60 ? '24-48小时' : '48-72小时'}复查肾功能正常后恢复用药
                        </div>
                    </div>
                `;
            } else if (results.patientType === 'heart' && results.specialData) {
                const data = results.specialData;
                const risk = data.heartRisk;
                let riskColor = risk.riskLevel === 'low' ? '#22c55e' : risk.riskLevel === 'moderate' ? '#3b82f6' : risk.riskLevel === 'high' ? '#f59e0b' : '#ef4444';

                let monitoringPlan = '';
                if (risk.riskLevel === 'low') {
                    monitoringPlan = '标准处理,检查后观察2小时';
                } else if (risk.riskLevel === 'moderate') {
                    monitoringPlan = '用量减至85%,流速≤4.5ml/s,检查后观察4小时';
                } else if (risk.riskLevel === 'high') {
                    monitoringPlan = '用量减至70%,流速≤4.0ml/s,心内科会诊,准备急救设备';
                } else {
                    monitoringPlan = '慎重考虑,建议推迟检查或在CCU监护条件下进行';
                }

                assessmentResults = `
                    <div class="assessment-section">
                        <div class="assessment-title">心功能评估结果</div>
                        <div class="assessment-content">
                            风险评分${risk.riskScore}分, <span style="color: ${riskColor}; font-weight: bold;">${risk.clinicalAction}</span><br>
                            监护方案: ${monitoringPlan}
                        </div>
                    </div>
                `;
            }

            let eGFRCalculationSection = '';
            if ((results.patientType === 'renal' || results.patientType === 'metformin') && results.specialData && results.specialData.eGFRDetails) {
                const eGFRDetails = results.specialData.eGFRDetails;
                eGFRCalculationSection = `
                    <div class="calculation-details">
                        <h3>eGFR详细演算过程</h3>
                        <div class="calculation-steps">
                            <strong>2021版CKD-EPI公式:</strong><br>
                            <pre style="font-size: 9px; line-height: 1.2; white-space: pre-wrap; background: #f8f9fa; padding: 6px; border-radius: 4px; margin: 3px 0; font-family: 'Courier New', monospace;">${eGFRDetails.simplifiedCalculation}</pre>
                            <strong>最终结果:</strong> eGFR = ${eGFRDetails.result} ml/min/1.73m²
                        </div>
                    </div>
                `;
            }

            let safetySection = '';
            if (results.isVolumeExceeded || results.isFlowRateExceeded || results.contrastAdjustments.length > 0) {
                let warnings = [];
                
                if (results.isVolumeExceeded) {
                    warnings.push(`用量超限: 理论${results.originalVolume.toFixed(1)}ml → 限制${results.contrastVolume.toFixed(1)}ml`);
                }
                
                if (results.isFlowRateExceeded) {
                    warnings.push(`流速超限: 理论${results.originalFlowRate.toFixed(2)}ml/s → 限制${results.flowRate.toFixed(2)}ml/s`);
                }
                
                if (results.contrastAdjustments.length > 0) {
                    warnings.push(`${results.contrastAdjustments.join(' | ')}`);
                }
                
                safetySection = `
                    <div class="warning-section">
                        <div class="warning-title">安全限制与调整</div>
                        <div class="warning-content">${warnings.join(' | ')}<br>
                        已应用程序安全上限,实际使用需结合患者具体情况评估</div>
                    </div>
                `;
            }
            
            return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>影像学术研究计算结果_${reportNumber}</title>
    <style>
        @page { size: A4; margin: 1cm; }
        body { 
            font-family: 'Microsoft YaHei', 'SimSun', sans-serif; 
            line-height: 1.3; 
            color: #333; 
            margin: 0; 
            padding: 0; 
            font-size: 11px; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header { 
            text-align: center; 
            border-bottom: 2px solid #4f46e5; 
            padding-bottom: 8px; 
            margin-bottom: 15px; 
        }
        .header h1 { 
            color: #4f46e5; 
            font-size: 18px; 
            margin: 0 0 5px 0; 
            font-weight: 700; 
        }
        .header .subtitle { 
            color: #666; 
            font-size: 12px; 
            margin-bottom: 5px; 
        }
        .header .meta-info { 
            font-size: 9px; 
            color: #888; 
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            flex: 1;
        }
        
        .info-card {
            border: 1.5px solid #ddd;
            border-radius: 6px;
            height: fit-content;
        }
        
        .card-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #ddd;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 11px;
            color: #4f46e5;
        }
        
        .card-body {
            padding: 10px 12px;
        }
        
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 10px;
        }
        
        .data-row:last-child {
            border-bottom: none;
        }
        
        .data-label {
            color: #666;
            font-weight: 500;
        }
        
        .data-value {
            color: #333;
            font-weight: 600;
        }
        
        .result-highlight {
            color: #4f46e5;
            font-size: 11px;
            font-weight: 700;
        }
        
        .assessment-section {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #f8f9fa, #f1f3f4);
            border: 1.5px solid #ddd;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 8px 0;
        }
        
        .assessment-title {
            font-weight: 700;
            font-size: 11px;
            color: #4f46e5;
            margin-bottom: 5px;
        }
        
        .assessment-content {
            font-size: 10px;
            line-height: 1.4;
            color: #333;
        }
        
        .warning-section {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            border: 1.5px solid #f59e0b;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 8px 0;
        }
        
        .warning-title {
            font-weight: 700;
            font-size: 11px;
            color: #92400e;
            margin-bottom: 5px;
        }
        
        .warning-content {
            font-size: 10px;
            line-height: 1.4;
            color: #92400e;
        }
        
        .calculation-summary {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1.5px solid #bfdbfe;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 8px 0;
        }
        
        .calculation-summary h3 {
            color: #1e40af;
            font-size: 11px;
            margin: 0 0 8px 0;
            font-weight: 700;
        }
        
        .calc-formula {
            font-size: 9px;
            line-height: 1.4;
            color: #1e40af;
        }

        .calculation-details {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #fefce8, #fef3c7);
            border: 1.5px solid #eab308;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 8px 0;
        }

        .calculation-details h3 {
            color: #92400e;
            font-size: 11px;
            margin: 0 0 8px 0;
            font-weight: 700;
        }

        .calculation-steps {
            font-size: 9px;
            line-height: 1.3;
            color: #92400e;
        }
        
        .tech-specs {
            background: linear-gradient(135deg, #f8f9fa, #f1f3f4);
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 9px;
            line-height: 1.3;
            color: #666;
            margin: 15px 0 10px 0;
            border: 1px solid #e2e8f0;
        }
        
        .footer {
            border-top: 1.5px solid #ddd;
            padding-top: 10px;
            text-align: center;
            font-size: 8px;
            color: #666;
            line-height: 1.3;
            margin-top: auto;
        }
        
        @media print { 
            body { margin: 0; padding: 0; } 
            .no-print { display: none; } 
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>影像学术研究计算结果</h1>
        <div class="subtitle">CTA造影剂用量与BMI学术参考计算 v4.2混合版 - ${patientTypeText}</div>
        <div class="meta-info">
            计算时间: ${results.timestamp.toLocaleString()} | 生成时间: ${currentDate} | 编号: ${reportNumber}
        </div>
    </div>
    
    <div class="main-content">
        <div class="info-card">
            <div class="card-header">基本信息与BMI评估</div>
            <div class="card-body">
                <div class="data-row">
                    <span class="data-label">患者类型</span>
                    <span class="data-value">${patientTypeText}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">身高/体重</span>
                    <span class="data-value">${results.height}cm / ${results.weight}kg</span>
                </div>
                <div class="data-row">
                    <span class="data-label">BMI指数</span>
                    <span class="data-value">${results.bmi.toFixed(2)} (${bmiStatus})</span>
                </div>
                <div class="data-row">
                    <span class="data-label">检查类型</span>
                    <span class="data-value">${examTypeText}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">心率参数</span>
                    <span class="data-value">${heartRateText}</span>
                </div>
            </div>
        </div>
        
        <div class="info-card">
            <div class="card-header">专科参数与评估</div>
            <div class="card-body">
                ${patientSpecificInfo}
            </div>
        </div>
        
        <div class="info-card">
            <div class="card-header">计算结果</div>
            <div class="card-body">
                <div class="data-row">
                    <span class="data-label">造影剂用量</span>
                    <span class="data-value result-highlight" style="color: ${results.isVolumeExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.contrastVolume.toFixed(1)} ml
                    </span>
                </div>
                <div class="data-row">
                    <span class="data-label">注射流速</span>
                    <span class="data-value result-highlight" style="color: ${results.isFlowRateExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.flowRate.toFixed(2)} ml/s
                    </span>
                </div>
                <div class="data-row">
                    <span class="data-label">注射时间</span>
                    <span class="data-value">${results.examType === 'coronary' ? '12秒' : '约' + Math.ceil((results.contrastVolume - (results.examType === 'triple' ? 15 : 0)) / results.flowRate) + '秒'}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">安全上限</span>
                    <span class="data-value">≤${results.maxVolume}ml, ≤5.0ml/s</span>
                </div>
            </div>
        </div>
        
        <div class="info-card">
            <div class="card-header">注射方案与监护</div>
            <div class="card-body">
                <div class="data-row">
                    <span class="data-label">静脉通路</span>
                    <span class="data-value">右肘中静脉</span>
                </div>
                <div class="data-row">
                    <span class="data-label">注射压力</span>
                    <span class="data-value"><300psi</span>
                </div>
                <div class="data-row">
                    <span class="data-label">过敏监测</span>
                    <span class="data-value">密切关注有无过敏反应</span>
                </div>
                <div class="data-row">
                    <span class="data-label">监护时间</span>
                    <span class="data-value">${results.patientType === 'heart' ? '4-6小时' : '2-4小时'}</span>
                </div>
            </div>
        </div>
        
        ${assessmentResults}
        
        ${eGFRCalculationSection}
        
        ${safetySection}
        
        <div class="calculation-summary">
            <h3>计算公式与理论依据</h3>
            <div class="calc-formula">
                <strong>BMI计算:</strong> ${results.weight} ÷ (${results.height/100})² = ${results.bmi.toFixed(2)} | 
                <strong>造影剂用量:</strong> ${results.examType === 'coronary' ? 
                    (results.heartRate <= 80 ? '体重×0.8ml/kg' : '体重×0.85ml/kg') :
                    (results.heartRate <= 80 ? '体重×0.8+15ml' : '体重×0.85+15ml')
                } | 
                <strong>注射流速:</strong> ${results.examType === 'coronary' ? '用量÷12s' : '(用量-15ml)÷12s'}
                ${results.contrastAdjustments.length > 0 ? `<br><strong>调整依据:</strong> ${results.contrastAdjustments.join('; ')}` : ''}
                ${results.specialData && (results.patientType === 'renal' || results.patientType === 'metformin') ? 
                `<br><strong>eGFR计算:</strong> 2021版CKD-EPI公式(无种族系数),${results.specialData.gender === 'male' ? '男性' : '女性'}${results.specialData.age}岁患者,详细演算过程见上方` : ''}
            </div>
        </div>
    </div>
    
    <div class="tech-specs">
        <strong>程序版本:</strong> v4.2混合版 | 
        <strong>开发者:</strong> 影像涛哥 | 
        <strong>计算标准:</strong> 基于联影设备技术参数与临床研究数据 | 
        <strong>计算公式:</strong> 2021版CKD-EPI肾小球滤过率方程(无种族系数)
    </div>
    
    <div class="footer">
        <p><strong>重要声明:</strong> 本计算结果仅供影像技术教学和学术研究参考,严禁用于临床诊断或治疗决策。实际使用时必须结合患者具体病史、实验室检查结果和临床医师判断。开发者不承担任何法律责任。</p>
        <p><strong>结果编号:</strong> ${reportNumber} | <strong>技术支持:</strong> 联影CT960+平台 | <strong>使用许可:</strong> 仅限学术研究用途 | <strong>eGFR公式:</strong> 2021版CKD-EPI方程</p>
    </div>
</body>
</html>`;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 15px 20px;
                border-radius: 8px; color: white; font-weight: 500; z-index: 1000;
                opacity: 0; transition: opacity 0.3s ease; max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            switch(type) {
                case 'success': notification.style.background = '#22c55e'; break;
                case 'error': notification.style.background = '#ef4444'; break;
                case 'warning': notification.style.background = '#f59e0b'; break;
                default: notification.style.background = '#3b82f6';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.opacity = '1', 10);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            try {
                updateClock();
                setInterval(updateClock, 1000);
                
                setupRealTimeValidation();
                setupCheckboxExclusivity();
                updateProgress();
                
                document.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !document.getElementById('calculateBtn').disabled) {
                        calculate();
                    }
                });
                
                document.addEventListener('input', function(e) {
                    updateProgress();
                    
                    if (e.target.closest('#allergyForm')) {
                        updateAllergyRiskScore();
                    }
                });
                
            } catch (error) {
                console.error('页面初始化出错:', error);
                showNotification('页面初始化过程中出现问题,部分功能可能无法正常使用', 'warning');
            }
        });

        window.addEventListener('error', function(event) {
            console.error('全局错误:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('未处理的Promise拒绝:', event.reason);
        });
    </script>
</body>
</html>

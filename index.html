<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½±åƒå­¦æœ¯ç ”ç©¶è®¡ç®—å·¥å…· v3.2</title>
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #7c3aed;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg: #ffffff;
            --text: #1e293b;
            --card: #f8fafc;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --normal-color: #22c55e;
            --renal-color: #f59e0b;
            --metformin-color: #ef4444;
            --heart-color: #3b82f6;
        }

        [data-theme="dark"] {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #f87171;
            --bg: #0f172a;
            --text: #e2e8f0;
            --card: #1e293b;
            --border: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --heart-color: #60a5fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text);
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        h1 {
            font-size: 2.8em;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .subtitle {
            font-size: 1.2em;
            color: var(--text);
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .developer-info {
            margin: 15px 0;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
        }

        /* ç”µå­é’Ÿæ ·å¼ */
        .clock-container {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border: 2px solid transparent;
            background-clip: padding-box;
            border-radius: 16px;
            padding: 20px;
            margin: 25px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 
                0 8px 32px rgba(79, 70, 229, 0.1),
                inset 0 1px 3px rgba(255, 255, 255, 0.8),
                inset 0 -1px 2px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .clock-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 2px;
            background: linear-gradient(135deg, var(--primary), var(--secondary), #22c55e, var(--primary));
            border-radius: 16px;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            z-index: -1;
            animation: borderGlow 3s ease-in-out infinite alternate;
        }

        @keyframes borderGlow {
            0% { opacity: 0.6; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.02); }
        }

        .clock-container:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 40px rgba(79, 70, 229, 0.15),
                inset 0 1px 3px rgba(255, 255, 255, 0.9),
                inset 0 -1px 2px rgba(0, 0, 0, 0.05);
        }

        .digits-container {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .digit-group {
            display: flex;
            gap: 8px;
        }

        .digit {
            position: relative;
            width: 60px;
            height: 100px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 2px rgba(255, 255, 255, 0.8),
                inset 0 -1px 1px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(79, 70, 229, 0.1);
            transition: all 0.3s ease;
        }

        .digit:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.15),
                inset 0 1px 2px rgba(255, 255, 255, 0.9),
                inset 0 -1px 1px rgba(0, 0, 0, 0.05);
        }

        .segment {
            position: absolute;
            background: transparent;
            border-radius: 3px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .segment.active {
            background: #333333;
            box-shadow: 
                0 0 4px rgba(51, 51, 51, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        /* æš—è‰²ä¸»é¢˜ä¸‹çš„æ®µæ ·å¼ */
        [data-theme="dark"] .segment.active {
            background: #ffffff !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.4) !important;
        }

        /* æ°´å¹³æ®µ */
        .segment-a { top: 8px; left: 12px; width: 36px; height: 8px; }
        .segment-d { bottom: 8px; left: 12px; width: 36px; height: 8px; }
        .segment-g { top: 50%; left: 12px; width: 36px; height: 8px; transform: translateY(-50%); }

        /* å‚ç›´æ®µ */
        .segment-b { top: 12px; right: 8px; width: 8px; height: 36px; }
        .segment-c { bottom: 12px; right: 8px; width: 8px; height: 36px; }
        .segment-e { bottom: 12px; left: 8px; width: 8px; height: 36px; }
        .segment-f { top: 12px; left: 8px; width: 8px; height: 36px; }

        .clock-colon {
            font-size: 2.5rem;
            color: #333333;
            margin: 0 8px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(51, 51, 51, 0.2);
            transition: all 0.3s ease;
        }

        .clock-label {
            font-size: 13px;
            color: var(--primary);
            text-align: center;
            margin-top: 12px;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* æš—è‰²ä¸»é¢˜ä¸‹çš„ç”µå­é’Ÿæ ·å¼ */
        [data-theme="dark"] .clock-container {
            background: linear-gradient(145deg, #1e293b, #334155);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 3px rgba(255, 255, 255, 0.1),
                inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        }

        [data-theme="dark"] .digit {
            background: linear-gradient(145deg, #334155, #475569);
            border: 1px solid rgba(99, 102, 241, 0.2);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.3),
                inset 0 1px 2px rgba(255, 255, 255, 0.1),
                inset 0 -1px 1px rgba(0, 0, 0, 0.2);
        }

        [data-theme="dark"] .clock-colon {
            color: #ffffff !important;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.4) !important;
        }

        /* æ‚£è€…åˆ†ç±»é€‰æ‹©å™¨ */
        .patient-category-selector {
            background: var(--card);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border);
        }

        .category-title {
            text-align: center;
            font-size: 1.8em;
            color: var(--primary);
            margin-bottom: 25px;
            font-weight: 700;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }

        .category-card {
            background: var(--bg);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            transition: all 0.3s ease;
        }

        .category-card.normal::before { background: var(--normal-color); }
        .category-card.renal::before { background: var(--renal-color); }
        .category-card.metformin::before { background: var(--metformin-color); }
        .category-card.heart::before { background: var(--heart-color); }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .category-card.active {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(79, 70, 229, 0.2);
        }

        .category-card.normal.active {
            border-color: var(--normal-color);
            box-shadow: 0 8px 30px rgba(34, 197, 94, 0.2);
        }

        .category-card.renal.active {
            border-color: var(--renal-color);
            box-shadow: 0 8px 30px rgba(245, 158, 11, 0.2);
        }

        .category-card.metformin.active {
            border-color: var(--metformin-color);
            box-shadow: 0 8px 30px rgba(239, 68, 68, 0.2);
        }

        .category-card.heart.active {
            border-color: var(--heart-color);
            box-shadow: 0 8px 30px rgba(59, 130, 246, 0.2);
        }

        .category-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }

        .category-name {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .category-description {
            font-size: 0.95em;
            color: var(--text);
            opacity: 0.7;
            line-height: 1.5;
        }

        .category-card.normal .category-name { color: var(--normal-color); }
        .category-card.renal .category-name { color: var(--renal-color); }
        .category-card.metformin .category-name { color: var(--metformin-color); }
        .category-card.heart .category-name { color: var(--heart-color); }

        /* è¡¨å•åŒºåŸŸ */
        .form-container {
            display: none;
            animation: slideIn 0.5s ease;
        }

        .form-container.show {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            background: var(--card);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .form-section:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title.normal { color: var(--normal-color); }
        .section-title.renal { color: var(--renal-color); }
        .section-title.metformin { color: var(--metformin-color); }
        .section-title.heart { color: var(--heart-color); }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        label {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .required {
            color: var(--error);
        }

        input, select {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .input-hint {
            font-size: 12px;
            color: var(--text);
            opacity: 0.6;
            margin-top: 4px;
        }

        .input-error {
            border-color: var(--error) !important;
            background-color: rgba(239, 68, 68, 0.05);
        }

        .error-message {
            color: var(--error);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .info-box {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.6;
            border-left: 4px solid;
        }

        .info-box.normal {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #065f46;
            border-left-color: var(--normal-color);
        }

        .info-box.renal {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            color: #92400e;
            border-left-color: var(--renal-color);
        }

        .info-box.metformin {
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            color: #991b1b;
            border-left-color: var(--metformin-color);
        }

        .info-box.heart {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e3a8a;
            border-left-color: var(--heart-color);
        }

        /* åˆ†çº§æ ‡å‡†è¡¨æ ¼æ ·å¼ */
        .grading-table {
            width: 100%;
            margin: 15px 0;
            border-collapse: collapse;
            font-size: 12px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .grading-table th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 11px;
        }

        .grading-table td {
            padding: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
            font-size: 11px;
        }

        .grading-table .grade-level {
            font-weight: 700;
            white-space: nowrap;
        }

        .grade-low { color: var(--normal-color); }
        .grade-moderate { color: var(--renal-color); }
        .grade-high { color: var(--metformin-color); }
        .grade-very-high { color: var(--error); }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-secondary {
            background: var(--card);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--border);
        }

        .results {
            background: var(--card);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid var(--border);
            margin-top: 25px;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .results.show { display: block; }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 12px;
            background: var(--bg);
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .result-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .result-label {
            font-weight: 500;
            color: var(--text);
        }

        .result-value {
            font-size: 1.2em;
            color: var(--primary);
            font-weight: 700;
        }

        .calc-type {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
        }

        .real-time-validation {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }

        .validation-success { color: var(--success); }
        .validation-error { color: var(--error); }

        .formula-display {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--text);
            opacity: 0.8;
        }

        .disclaimer {
            background: linear-gradient(135deg, #fef7cd, #fed7aa);
            color: #92400e;
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid var(--warning);
            margin-top: 25px;
            font-size: 13px;
            line-height: 1.6;
        }

        .disclaimer h3 {
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 700;
        }

        .highlight {
            font-weight: 700;
            color: #b45309;
        }

        /* æš—è‰²ä¸»é¢˜é€‚é… */
        [data-theme="dark"] .grading-table {
            background: #1e293b;
        }

        [data-theme="dark"] .grading-table td {
            border-color: #374151;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; }
            h1 { font-size: 2.2em; }
            .form-row { grid-template-columns: 1fr; gap: 15px; }
            .theme-toggle { position: relative; margin-bottom: 20px; }
            .btn-group { flex-direction: column; }
            
            .category-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .grading-table {
                font-size: 10px;
            }

            .grading-table th,
            .grading-table td {
                padding: 6px 4px;
            }

            /* ç§»åŠ¨ç«¯ç”µå­é’Ÿä¼˜åŒ– */
            .clock-container {
                padding: 25px 15px;
                margin: 25px 0;
                border-radius: 20px;
            }
            
            .digits-container {
                gap: 10px;
                transform: scale(1.1);
            }
            
            .digit {
                width: 55px;
                height: 90px;
                border-radius: 10px;
                padding: 10px;
                box-shadow: 
                    0 4px 12px rgba(0, 0, 0, 0.15),
                    inset 0 2px 4px rgba(255, 255, 255, 0.8),
                    inset 0 -2px 3px rgba(0, 0, 0, 0.05);
            }
            
            .digit:hover {
                transform: translateY(-2px);
            }
            
            /* ç§»åŠ¨ç«¯æ®µæ›´ç²—æ›´æ¸…æ™° */
            .segment-a, .segment-d, .segment-g {
                width: 35px;
                height: 6px;
                left: 10px;
            }
            
            .segment-b, .segment-c, .segment-e, .segment-f {
                width: 6px;
                height: 32px;
            }
            
            .segment-b, .segment-c {
                right: 10px;
            }
            
            .segment-e, .segment-f {
                left: 10px;
            }
            
            .segment-a { top: 10px; }
            .segment-d { bottom: 10px; }
            .segment-g { top: 50%; transform: translateY(-50%); }
            .segment-b { top: 14px; }
            .segment-c { bottom: 14px; }
            .segment-e { bottom: 14px; }
            .segment-f { top: 14px; }
            
            .clock-colon {
                font-size: 2.2rem;
                margin: 0 6px;
                font-weight: 900;
            }
            
            .clock-label {
                font-size: 14px;
                margin-top: 15px;
                font-weight: 600;
            }
        }

        @media print {
            body { background: white; color: black; }
            .container { background: white; box-shadow: none; }
            .btn, .theme-toggle, .patient-category-selector, .clock-container { display: none; }
            .no-print { display: none; }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="theme-toggle" onclick="toggleTheme()">
                <span id="theme-icon">ğŸŒ™</span>
                <span id="theme-text">å¤œé—´æ¨¡å¼</span>
            </div>
            <h1>å½±åƒå­¦æœ¯ç ”ç©¶è®¡ç®—å·¥å…·</h1>
            <div class="subtitle">CTAé€ å½±å‰‚ç”¨é‡ä¸BMIå­¦æœ¯å‚è€ƒè®¡ç®— v3.2</div>
            <div class="developer-info">
                ğŸ’» ç¨‹åºå¼€å‘è€…ï¼šå½±åƒæ¶›å“¥
            </div>
            
            <!-- ç”µå­é’Ÿ -->
            <div class="clock-container">
                <div class="digits-container">
                    <div class="digit-group">
                        <div class="digit" id="hour-tens">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                        <div class="digit" id="hour-ones">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                    </div>
                    
                    <div class="clock-colon">:</div>
                    
                    <div class="digit-group">
                        <div class="digit" id="min-tens">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                        <div class="digit" id="min-ones">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                    </div>
                    
                    <div class="clock-colon">:</div>
                    
                    <div class="digit-group">
                        <div class="digit" id="sec-tens">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                        <div class="digit" id="sec-ones">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="clock-label">å½“å‰æ—¶é—´</div>
        </div>
        
        <!-- æ‚£è€…åˆ†ç±»é€‰æ‹©å™¨ -->
        <div class="patient-category-selector">
            <div class="category-title">è¯·é€‰æ‹©æ‚£è€…ç±»å‹</div>
            <div class="category-grid">
                <div class="category-card normal" onclick="selectPatientType('normal')">
                    <div class="category-icon">ğŸ‘¤</div>
                    <div class="category-name">æ­£å¸¸æ‚£è€…</div>
                    <div class="category-description">
                        è‚¾åŠŸèƒ½æ­£å¸¸<br>
                        æ— äºŒç”²åŒèƒç”¨è¯å²<br>
                        æ ‡å‡†è®¡ç®—æµç¨‹
                    </div>
                </div>
                
                <div class="category-card renal" onclick="selectPatientType('renal')">
                    <div class="category-icon">ğŸ«˜</div>
                    <div class="category-name">è‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€…</div>
                    <div class="category-description">
                        è‚¾åŠŸèƒ½ä¸å…¨<br>
                        éœ€è¦eGFRè¯„ä¼°<br>
                        é€ å½±å‰‚ç”¨é‡è°ƒæ•´
                    </div>
                </div>
                
                <div class="category-card metformin" onclick="selectPatientType('metformin')">
                    <div class="category-icon">ğŸ’Š</div>
                    <div class="category-name">äºŒç”²åŒèƒç”¨è¯æ‚£è€…</div>
                    <div class="category-description">
                        æœç”¨äºŒç”²åŒèƒ<br>
                        éœ€è¦é£é™©è¯„ä¼°<br>
                        ç‰¹æ®Šå¤„ç†æ–¹æ¡ˆ
                    </div>
                </div>

                <div class="category-card heart" onclick="selectPatientType('heart')">
                    <div class="category-icon">â¤ï¸</div>
                    <div class="category-name">å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…</div>
                    <div class="category-description">
                        å¿ƒåŠŸèƒ½å¼‚å¸¸<br>
                        éœ€è¦NYHAåˆ†çº§è¯„ä¼°<br>
                        é€ å½±å‰‚ç”¨é‡é™åˆ¶
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­£å¸¸æ‚£è€…è¡¨å• -->
        <div class="form-container" id="normalForm">
            <div class="form-section">
                <h2 class="section-title normal">
                    <span>ğŸ‘¤</span>
                    æ­£å¸¸æ‚£è€… - åŸºç¡€å‚æ•°è®¾ç½®
                </h2>
                <div class="info-box normal">
                    <strong>âœ… æ­£å¸¸æ‚£è€…è®¡ç®—æµç¨‹ï¼š</strong><br>
                    â€¢ è‚¾åŠŸèƒ½æ­£å¸¸ï¼Œæ— éœ€eGFRè¯„ä¼°<br>
                    â€¢ æ— äºŒç”²åŒèƒç”¨è¯é£é™©<br>
                    â€¢ æŒ‰æ ‡å‡†å…¬å¼è®¡ç®—é€ å½±å‰‚ç”¨é‡<br>
                    â€¢ å®‰å…¨é™åˆ¶ï¼šå† è„‰CTA â‰¤60mlï¼Œèƒ¸ç—›ä¸‰è” â‰¤75ml
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="normalHeight">èº«é«˜ (cm) <span class="required">*</span></label>
                        <input type="number" id="normalHeight" placeholder="è¯·è¾“å…¥èº«é«˜ï¼Œå¦‚ï¼š170" min="100" max="250" step="0.1" required>
                        <span class="real-time-validation" id="normalHeight-validation"></span>
                        <div class="input-hint">èŒƒå›´ï¼š100-250cm</div>
                        <div class="error-message" id="normalHeight-error">èº«é«˜å¿…é¡»åœ¨100-250cmä¹‹é—´</div>
                    </div>
                    <div class="form-group">
                        <label for="normalWeight">ä½“é‡ (kg) <span class="required">*</span></label>
                        <input type="number" id="normalWeight" placeholder="è¯·è¾“å…¥ä½“é‡ï¼Œå¦‚ï¼š70" min="20" max="200" step="0.1" required>
                        <span class="real-time-validation" id="normalWeight-validation"></span>
                        <div class="input-hint">èŒƒå›´ï¼š20-200kg</div>
                        <div class="error-message" id="normalWeight-error">ä½“é‡å¿…é¡»åœ¨20-200kgä¹‹é—´</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="normalHeartRate">å¿ƒç‡å‚æ•°</label>
                        <select id="normalHeartRate">
                            <option value="80">â‰¤80 æ¬¡/åˆ†</option>
                            <option value="81">>80 æ¬¡/åˆ†</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="normalExamType">æ£€æŸ¥ç±»å‹</label>
                        <select id="normalExamType">
                            <option value="coronary">å† è„‰CTA</option>
                            <option value="triple">èƒ¸ç—›ä¸‰è”</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- è‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€…è¡¨å• -->
        <div class="form-container" id="renalForm">
            <div class="form-section">
                <h2 class="section-title renal">
                    <span>ğŸ«˜</span>
                    è‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€… - åŸºç¡€å‚æ•°è®¾ç½®
                </h2>
                <div class="info-box renal">
                    <strong>âš ï¸ è‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€…ç‰¹æ®Šå¤„ç†ï¼š</strong><br>
                    â€¢ éœ€è¦è¯„ä¼°eGFRï¼ˆ2021ç‰ˆCKD-EPIå…¬å¼ï¼‰<br>
                    â€¢ æ ¹æ®è‚¾åŠŸèƒ½åˆ†çº§è°ƒæ•´é€ å½±å‰‚ç”¨é‡<br>
                    â€¢ eGFR <45 ml/min/1.73mÂ² æ—¶å‡é‡è‡³80%<br>
                    â€¢ å¿…é¡»è¿›è¡Œå……åˆ†æ°´åŒ–æ²»ç–—
                </div>

                <!-- å†…ç½®è‚¾åŠŸèƒ½åˆ†çº§æ ‡å‡† -->
                <div class="info-box normal">
                    <strong>ğŸ“Š è‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€…åˆ†çº§æ ‡å‡†ï¼ˆåŸºäºeGFRï¼‰ï¼š</strong><br>
                    <table class="grading-table">
                        <thead>
                            <tr>
                                <th>ç­‰çº§</th>
                                <th>eGFRèŒƒå›´<br>(ml/min/1.73mÂ²)</th>
                                <th>è‚¾åŠŸèƒ½çŠ¶æ€</th>
                                <th>å¤„ç†ç­–ç•¥</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="grade-level grade-low">ä¸€çº§</td>
                                <td>â‰¥ 60</td>
                                <td>æ­£å¸¸/è½»åº¦ä¸‹é™</td>
                                <td>æ ‡å‡†æµç¨‹</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-moderate">äºŒçº§</td>
                                <td>45-59</td>
                                <td>è½»ä¸­åº¦ä¸å…¨</td>
                                <td>åŠ å¼ºç›‘æµ‹</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-moderate">ä¸‰çº§</td>
                                <td>30-44</td>
                                <td>ä¸­é‡åº¦ä¸å…¨</td>
                                <td>å‡é‡è‡³80%</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-high">å››çº§</td>
                                <td>< 30</td>
                                <td>é‡åº¦ä¸å…¨</td>
                                <td>é¿å…æ£€æŸ¥</td>
                            </tr>
                        </tbody>
                    </table>
                    <strong>è¯„ä¼°æµç¨‹ï¼š</strong>è¡€è‚Œé… â†’ 2021 CKD-EPI â†’ eGFRåˆ†çº§ â†’ é€ å½±å‰‚è°ƒæ•´
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="renalHeight">èº«é«˜ (cm) <span class="required">*</span></label>
                        <input type="number" id="renalHeight" placeholder="è¯·è¾“å…¥èº«é«˜ï¼Œå¦‚ï¼š170" min="100" max="250" step="0.1" required>
                        <span class="real-time-validation" id="renalHeight-validation"></span>
                        <div class="input-hint">èŒƒå›´ï¼š100-250cm</div>
                        <div class="error-message" id="renalHeight-error">èº«é«˜å¿…é¡»åœ¨100-250cmä¹‹é—´</div>
                    </div>
                    <div class="form-group">
                        <label for="renalWeight">ä½“é‡ (kg) <span class="required">*</span></label>
                        <input type="number" id="renalWeight" placeholder="è¯·è¾“å…¥ä½“é‡ï¼Œå¦‚ï¼š70" min="20" max="200" step="0.1" required>
                        <span class="real-time-validation" id="renalWeight-validation"></span>
                        <div class="input-hint">èŒƒå›´ï¼š20-200kg</div>
                        <div class="error-message" id="renalWeight-error">ä½“é‡å¿…é¡»åœ¨20-200kgä¹‹é—´</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="renalCreatinine">è¡€è‚Œé…å€¼ (Î¼mol/L) <span class="required">*</span></label>
                        <input type="number" id="renalCreatinine" placeholder="è¯·è¾“å…¥è¡€è‚Œé…å€¼ï¼Œå¦‚ï¼š120" min="30" max="500" step="1" required>
                        <span class="real-time-validation" id="renalCreatinine-validation"></span>
                        <div class="input-hint">èŒƒå›´ï¼š30-500 Î¼mol/Lï¼Œç”¨äºè®¡ç®—eGFR</div>
                        <div class="error-message" id="renalCreatinine-error">è¡€è‚Œé…å€¼å¿…é¡»åœ¨30-500 Î¼mol/Lä¹‹é—´</div>
                        <div class="formula-display" id="renalFormulaDisplay" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="renalAge">å¹´é¾„ (å²) <span class="required">*</span></label>
                        <input type="number" id="renalAge" placeholder="è¯·è¾“å…¥å¹´é¾„ï¼Œå¦‚ï¼š65" min="18" max="120" step="1" required>
                        <span class="real-time-validation" id="renalAge-validation"></span>
                        <div class="input-hint">èŒƒå›´ï¼š18-120å²</div>
                        <div class="error-message" id="renalAge-error">å¹´é¾„å¿…é¡»åœ¨18-120å²ä¹‹é—´</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="renalGender">æ€§åˆ« <span class="required">*</span></label>
                        <select id="renalGender" onchange="updateRenalFormulaDisplay()">
                            <option value="male">ç”·æ€§</option>
                            <option value="female">å¥³æ€§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="renalHeartRate">å¿ƒç‡å‚æ•°</label>
                        <select id="renalHeartRate">
                            <option value="80">â‰¤80 æ¬¡/åˆ†</option>
                            <option value="81">>80 æ¬¡/åˆ†</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="renalExamType">æ£€æŸ¥ç±»å‹</label>
                        <select id="renalExamType">
                            <option value="coronary">å† è„‰CTA</option>
                            <option value="triple">èƒ¸ç—›ä¸‰è”</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- äºŒç”²åŒèƒæ‚£è€…è¡¨å• -->
        <div class="form-container" id="metforminForm">
            <div class="form-section">
                <h2 class="section-title metformin">
                    <span>ğŸ’Š</span>
                    äºŒç”²åŒèƒç”¨è¯æ‚£è€… - åŸºç¡€å‚æ•°è®¾ç½®
                </h2>
                <div class="info-box metformin">
                    <strong>ğŸš¨ äºŒç”²åŒèƒæ‚£è€…é£é™©æç¤ºï¼š</strong><br>
                    â€¢ é€ å½±å‰‚å¯èƒ½å¢åŠ ä¹³é…¸é…¸ä¸­æ¯’é£é™©<br>
                    â€¢ éœ€è¦è¯¦ç»†è¯„ä¼°è‚¾åŠŸèƒ½(eGFR)<br>
                    â€¢ é€ å½±å‰å48-72å°æ—¶æš‚åœç”¨è¯<br>
                    â€¢ å¿…è¦æ—¶å†…åˆ†æ³Œç§‘ä¼šè¯Š
                </div>

                <!-- å†…ç½®äºŒç”²åŒèƒé£é™©åˆ†ç»„æ ‡å‡† -->
                <div class="info-box normal">
                    <strong>ğŸ’Š äºŒç”²åŒèƒæ‚£è€…é£é™©åˆ†ç»„æ ‡å‡†ï¼š</strong><br>
                    <table class="grading-table">
                        <thead>
                            <tr>
                                <th>é£é™©ç»„</th>
                                <th>è¯„ä¼°æ ‡å‡†</th>
                                <th>ä¸´åºŠå¤„ç†</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="grade-level grade-low">ä½é£é™©ç»„</td>
                                <td>eGFRâ‰¥60 + å¹´é¾„<65 + ä½å‰‚é‡</td>
                                <td>æ ‡å‡†å¤„ç†</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-moderate">ä¸­é£é™©ç»„</td>
                                <td>eGFR 45-59 + å¹´é¾„65-75</td>
                                <td>è°¨æ…ç›‘æµ‹</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-high">é«˜é£é™©ç»„</td>
                                <td>eGFR 30-44 + å¹´é¾„>75 + é«˜å‰‚é‡</td>
                                <td>é«˜é£é™©å¤„ç†</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-very-high">æé«˜é£é™©ç»„</td>
                                <td>eGFR<30 æˆ–æ€¥æ€§æƒ…å†µ</td>
                                <td>é¿å…æ£€æŸ¥</td>
                            </tr>
                        </tbody>
                    </table>
                    <strong>è¯„ä¼°è¦ç´ ï¼š</strong>è‚¾åŠŸèƒ½ + å¹´é¾„ + å‰‚é‡ â†’ ä¹³é…¸é…¸ä¸­æ¯’é£é™©è¯„ä¼°
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="metforminHeight">èº«é«˜ (cm) <span class="required">*</span></label>
                        <input type="number" id="metforminHeight" placeholder="è¯·è¾“å…¥èº«é«˜ï¼Œå¦‚ï¼š170" min="100" max="250" step="0.1" required>
                        <span class="real-time-validation" id="metforminHeight-validation"></span>
                        <div class="input-hint">èŒƒå›´ï¼š100-250cm</div>
                        <div class="error-message" id="metforminHeight-error">èº«é«˜å¿…é¡»åœ¨100-250cmä¹‹é—´</div>
                    </div>
                    <div class="form-group">
                        <label for="metforminWeight">ä½“é‡ (kg) <span class="required">*</span></label>
                        <input type="number" id="metforminWeight" placeholder="è¯·è¾“å…¥ä½“é‡ï¼Œå¦‚ï¼š70" min="20" max="200" step="0.1" required>
                        <span class="real-time-validation" id="metforminWeight-validation"></span>
                        <div class="input-hint">èŒƒå›´ï¼š20-200kg</div>
                        <div class="error-message" id="metforminWeight-error">ä½“é‡å¿…é¡»åœ¨20-200kgä¹‹é—´</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="metforminCreatinine">è¡€è‚Œé…å€¼ (Î¼mol/L) <span class="required">*</span></label>
                        <input type="number" id="metforminCreatinine" placeholder="è¯·è¾“å…¥è¡€è‚Œé…å€¼ï¼Œå¦‚ï¼š80" min="30" max="500" step="1" required>
                        <span class="real-time-validation" id="metforminCreatinine-validation"></span>
                        <div class="input-hint">èŒƒå›´ï¼š30-500 Î¼mol/Lï¼Œç”¨äºé£é™©è¯„ä¼°</div>
                        <div class="error-message" id="metforminCreatinine-error">è¡€è‚Œé…å€¼å¿…é¡»åœ¨30-500 Î¼mol/Lä¹‹é—´</div>
                        <div class="formula-display" id="metforminFormulaDisplay" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="metforminAge">å¹´é¾„ (å²) <span class="required">*</span></label>
                        <input type="number" id="metforminAge" placeholder="è¯·è¾“å…¥å¹´é¾„ï¼Œå¦‚ï¼š60" min="18" max="120" step="1" required>
                        <span class="real-time-validation" id="metforminAge-validation"></span>
                        <div class="input-hint">èŒƒå›´ï¼š18-120å²</div>
                        <div class="error-message" id="metforminAge-error">å¹´é¾„å¿…é¡»åœ¨18-120å²ä¹‹é—´</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="metforminGender">æ€§åˆ« <span class="required">*</span></label>
                        <select id="metforminGender" onchange="updateMetforminFormulaDisplay()">
                            <option value="male">ç”·æ€§</option>
                            <option value="female">å¥³æ€§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="metforminDose">äºŒç”²åŒèƒå‰‚é‡ï¼ˆmg/æ—¥ï¼‰</label>
                        <select id="metforminDose">
                            <option value="500">500mg/æ—¥</option>
                            <option value="850">850mg/æ—¥</option>
                            <option value="1000">1000mg/æ—¥</option>
                            <option value="1500">1500mg/æ—¥</option>
                            <option value="2000">2000mg/æ—¥</option>
                            <option value="other">å…¶ä»–å‰‚é‡</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="metforminHeartRate">å¿ƒç‡å‚æ•°</label>
                        <select id="metforminHeartRate">
                            <option value="80">â‰¤80 æ¬¡/åˆ†</option>
                            <option value="81">>80 æ¬¡/åˆ†</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="metforminExamType">æ£€æŸ¥ç±»å‹</label>
                        <select id="metforminExamType">
                            <option value="coronary">å† è„‰CTA</option>
                            <option value="triple">èƒ¸ç—›ä¸‰è”</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…è¡¨å• -->
        <div class="form-container" id="heartForm">
            <div class="form-section">
                <h2 class="section-title heart">
                    <span>â¤ï¸</span>
                    å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€… - åŸºç¡€å‚æ•°è®¾ç½®
                </h2>
                <div class="info-box heart">
                    <strong>ğŸ’™ å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…ç‰¹æ®Šå¤„ç†ï¼š</strong><br>
                    â€¢ éœ€è¦è¯„ä¼°NYHAå¿ƒåŠŸèƒ½åˆ†çº§<br>
                    â€¢ æ ¹æ®å°„è¡€åˆ†æ•°(EF)è°ƒæ•´é€ å½±å‰‚ç”¨é‡<br>
                    â€¢ ä¸¥æ ¼æ§åˆ¶é€ å½±å‰‚æ€»é‡ï¼Œé¿å…å®¹é‡è´Ÿè·è¿‡é‡<br>
                    â€¢ ç›‘æµ‹BNP/NT-proBNPæ°´å¹³
                </div>

                <!-- å†…ç½®å¿ƒåŠŸèƒ½é£é™©åˆ†çº§æ ‡å‡† -->
                <div class="info-box normal">
                    <strong>â¤ï¸ å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…é£é™©åˆ†çº§æ ‡å‡†ï¼š</strong><br>
                    <table class="grading-table">
                        <thead>
                            <tr>
                                <th>é£é™©ç­‰çº§</th>
                                <th>NYHAåˆ†çº§</th>
                                <th>EFå€¼èŒƒå›´</th>
                                <th>å¤„ç†ç­–ç•¥</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="grade-level grade-low">ä½é£é™©</td>
                                <td>NYHA Içº§</td>
                                <td>EF â‰¥ 50%</td>
                                <td>æ ‡å‡†æµç¨‹</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-moderate">ä¸­é£é™©</td>
                                <td>NYHA IIçº§</td>
                                <td>EF 40-49%</td>
                                <td>ä¸­åº¦ç›‘æµ‹</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-high">é«˜é£é™©</td>
                                <td>NYHA IIIçº§</td>
                                <td>EF 30-39%</td>
                                <td>é«˜é£é™©å¤„ç†</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-very-high">æé«˜é£é™©</td>
                                <td>NYHA IVçº§</td>
                                <td>EF < 30%</td>
                                <td>æ…é‡è€ƒè™‘</td>
                            </tr>
                        </tbody>
                    </table>
                    <strong>è¯„ä¼°è¦ç´ ï¼š</strong>NYHAåˆ†çº§ + å°„è¡€åˆ†æ•° + BNP â†’ å®¹é‡è´Ÿè·é£é™©è¯„ä¼°
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="heartHeight">èº«é«˜ (cm) <span class="required">*</span></label>
                        <input type="number" id="heartHeight" placeholder="è¯·è¾“å…¥èº«é«˜ï¼Œå¦‚ï¼š170" min="100" max="250" step="0.1" required>
                        <span class="real-time-validation" id="heartHeight-validation"></span>
                        <div class="input-hint">èŒƒå›´ï¼š100-250cm</div>
                        <div class="error-message" id="heartHeight-error">èº«é«˜å¿…é¡»åœ¨100-250cmä¹‹é—´</div>
                    </div>
                    <div class="form-group">
                        <label for="heartWeight">ä½“é‡ (kg) <span class="required">*</span></label>
                        <input type="number" id="heartWeight" placeholder="è¯·è¾“å…¥ä½“é‡ï¼Œå¦‚ï¼š70" min="20" max="200" step="0.1" required>
                        <span class="real-time-validation" id="heartWeight-validation"></span>
                        <div class="input-hint">èŒƒå›´ï¼š20-200kg</div>
                        <div class="error-message" id="heartWeight-error">ä½“é‡å¿…é¡»åœ¨20-200kgä¹‹é—´</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="heartNYHA">NYHAå¿ƒåŠŸèƒ½åˆ†çº§ <span class="required">*</span></label>
                        <select id="heartNYHA">
                            <option value="1">Içº§ - æ´»åŠ¨ä¸å—é™åˆ¶</option>
                            <option value="2">IIçº§ - è½»åº¦æ´»åŠ¨å—é™</option>
                            <option value="3">IIIçº§ - æ˜æ˜¾æ´»åŠ¨å—é™</option>
                            <option value="4">IVçº§ - ä¼‘æ¯æ—¶ä¹Ÿæœ‰ç—‡çŠ¶</option>
                        </select>
                        <div class="input-hint">è¯·é€‰æ‹©æ‚£è€…çš„NYHAå¿ƒåŠŸèƒ½åˆ†çº§</div>
                    </div>
                    <div class="form-group">
                        <label for="heartEF">å·¦å®¤å°„è¡€åˆ†æ•°(EF) % <span class="required">*</span></label>
                        <input type="number" id="heartEF" placeholder="è¯·è¾“å…¥EFå€¼ï¼Œå¦‚ï¼š45" min="10" max="80" step="1" required>
                        <span class="real-time-validation" id="heartEF-validation"></span>
                        <div class="input-hint">èŒƒå›´ï¼š10-80%</div>
                        <div class="error-message" id="heartEF-error">EFå€¼å¿…é¡»åœ¨10-80%ä¹‹é—´</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="heartBNP">BNP/NT-proBNPæ°´å¹³</label>
                        <select id="heartBNP">
                            <option value="normal">æ­£å¸¸èŒƒå›´</option>
                            <option value="mild">è½»åº¦å‡é«˜ï¼ˆ1-2å€ï¼‰</option>
                            <option value="moderate">ä¸­åº¦å‡é«˜ï¼ˆ2-5å€ï¼‰</option>
                            <option value="severe">é‡åº¦å‡é«˜ï¼ˆ>5å€ï¼‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="heartCreatinine">è¡€è‚Œé…å€¼ (Î¼mol/L)</label>
                        <input type="number" id="heartCreatinine" placeholder="è¯·è¾“å…¥è¡€è‚Œé…å€¼" min="30" max="500" step="1">
                        <span class="real-time-validation" id="heartCreatinine-validation"></span>
                        <div class="input-hint">å¯é€‰å¡«ï¼Œç”¨äºè¯„ä¼°å¿ƒè‚¾ç»¼åˆå¾</div>
                        <div class="error-message" id="heartCreatinine-error">è¡€è‚Œé…å€¼å¿…é¡»åœ¨30-500 Î¼mol/Lä¹‹é—´</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="heartRate">å¿ƒç‡å‚æ•°</label>
                        <select id="heartRate">
                            <option value="80">â‰¤80 æ¬¡/åˆ†</option>
                            <option value="81">>80 æ¬¡/åˆ†</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="heartExamType">æ£€æŸ¥ç±»å‹</label>
                        <select id="heartExamType">
                            <option value="coronary">å† è„‰CTA</option>
                            <option value="triple">èƒ¸ç—›ä¸‰è”</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- é€šç”¨æ“ä½œåŒºåŸŸ -->
        <div class="form-container show" id="actionForm">
            <div class="form-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress"></div>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="calculate()" id="calculateBtn" disabled>
                        <span>ğŸ§®</span> è®¡ç®—å‚è€ƒæ•°å€¼
                    </button>
                    <button class="btn btn-secondary" onclick="exportToPDF()" id="pdfBtn" disabled>
                        <span>ğŸ“„</span> å¯¼å‡ºPDF
                    </button>
                    <button class="btn btn-secondary" onclick="resetForm()" id="resetBtn">
                        <span>ğŸ”„</span> é‡æ–°é€‰æ‹©
                    </button>
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <h2 class="section-title">
                <span>ğŸ“Š</span>
                è®¡ç®—ç»“æœ
            </h2>
            <div id="calculationResults"></div>
        </div>

        <div class="disclaimer">
            <h3>âš ï¸ é‡è¦ä½¿ç”¨å£°æ˜</h3>
            <p><span class="highlight">ä¸“ä¸šèƒŒæ™¯è¦æ±‚ï¼š</span>ä½¿ç”¨è€…é¡»æ˜¯åœ¨åŒ»å­¦å½±åƒç§‘å·¥ä½œçš„ä¸“ä¸šäººå‘˜ï¼Œç†Ÿæ‚‰CTæ£€æŸ¥æµç¨‹å’Œé€ å½±å‰‚ä½¿ç”¨è§„èŒƒã€‚</p>
            <p><span class="highlight">è®¾å¤‡ä¾æ®ï¼š</span>æœ¬å·¥å…·è®¡ç®—å…¬å¼åŸºäºè”å½±CT960+è®¾å¤‡çš„æŠ€æœ¯å‚æ•°å’Œä¸´åºŠç ”ç©¶æ•°æ®ã€‚</p>
            <p><span class="highlight">å­¦æœ¯ç”¨é€”ï¼š</span>ä»…ä¾›å½±åƒæŠ€æœ¯æ•™å­¦ã€å­¦æœ¯ç ”ç©¶ä½¿ç”¨ï¼Œä¸¥ç¦ç”¨äºä¸´åºŠè¯Šæ–­æˆ–æ²»ç–—å†³ç­–ã€‚</p>
            <p><span class="highlight">å››ç±»åˆ†ç»„ï¼š</span>æ­£å¸¸æ‚£è€…é‡‡ç”¨æ ‡å‡†è®¡ç®—ï¼Œè‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€…éœ€eGFRè¯„ä¼°ï¼ŒäºŒç”²åŒèƒæ‚£è€…éœ€é£é™©è¯„ä¼°ï¼Œå¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…éœ€NYHAåˆ†çº§è¯„ä¼°ã€‚</p>
            <p><span class="highlight">eGFRè®¡ç®—ï¼š</span>é‡‡ç”¨2021ç‰ˆCKD-EPIå…¬å¼ï¼ˆæ— ç§æ—ç³»æ•°ï¼‰ï¼Œé€‚ç”¨äºä¸­å›½äººç¾¤ï¼Œè®¡ç®—æ–¹å¼å·²ä¼˜åŒ–ä¿®æ­£ã€‚</p>
            <p><span class="highlight">å®‰å…¨é™åˆ¶ï¼š</span>ç¨‹åºå·²è®¾ç½®é€ å½±å‰‚ç”¨é‡å’Œæ³¨å°„æµé€Ÿçš„å®‰å…¨ä¸Šé™ï¼Œä½†å®é™…ä½¿ç”¨éœ€ç»“åˆæ‚£è€…å…·ä½“æƒ…å†µå……åˆ†è¯„ä¼°è¡€ç®¡é€šè·¯ã€å¿ƒè‚¾åŠŸèƒ½ã€‚</p>
            <p style="margin-top: 15px; font-weight: 700; color: #b45309; border-top: 1px solid #fed7aa; padding-top: 15px;">
                å¼€å‘è€…ä¸æ‰¿æ‹…ä»»ä½•ç›´æ¥æˆ–é—´æ¥çš„æ³•å¾‹è´£ä»»ï¼›ä½¿ç”¨å³è¡¨ç¤ºåŒæ„æœ¬å£°æ˜ã€‚
            </p>
        </div>
    </div>

    <script>
        // 7æ®µæ•°ç ç®¡æ•°å­—é…ç½®ï¼ˆa-gæ®µï¼‰
        const digitConfig = {
            '0': [1, 1, 1, 1, 1, 1, 0],
            '1': [0, 1, 1, 0, 0, 0, 0],
            '2': [1, 1, 0, 1, 1, 0, 1],
            '3': [1, 1, 1, 1, 0, 0, 1],
            '4': [0, 1, 1, 0, 0, 1, 1],
            '5': [1, 0, 1, 1, 0, 1, 1],
            '6': [1, 0, 1, 1, 1, 1, 1],
            '7': [1, 1, 1, 0, 0, 0, 0],
            '8': [1, 1, 1, 1, 1, 1, 1],
            '9': [1, 1, 1, 1, 0, 1, 1]
        };

        // å…¨å±€çŠ¶æ€ç®¡ç†
        const appState = {
            isDarkMode: false,
            currentPatientType: null,
            currentResults: null
        };

        // ç”µå­é’Ÿç›¸å…³å‡½æ•°
        function updateClock() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            // æ ¼å¼åŒ–æ—¶é—´å„éƒ¨åˆ†
            const hoursStr = hours.toString().padStart(2, '0');
            const minutesStr = minutes.toString().padStart(2, '0');
            const secondsStr = seconds.toString().padStart(2, '0');

            // æ›´æ–°æ•°ç ç®¡æ˜¾ç¤º
            displayDigit(document.getElementById('hour-tens'), hoursStr[0]);
            displayDigit(document.getElementById('hour-ones'), hoursStr[1]);
            displayDigit(document.getElementById('min-tens'), minutesStr[0]);
            displayDigit(document.getElementById('min-ones'), minutesStr[1]);
            displayDigit(document.getElementById('sec-tens'), secondsStr[0]);
            displayDigit(document.getElementById('sec-ones'), secondsStr[1]);
        }

        // æ˜¾ç¤ºæ•°å­—åˆ°7æ®µæ•°ç ç®¡
        function displayDigit(digitElement, number) {
            if (!digitElement) return;
            
            const segments = digitElement.querySelectorAll('.segment');
            const config = digitConfig[number] || digitConfig['0'];

            segments.forEach((segment, index) => {
                // é¦–å…ˆç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                segment.classList.remove('active');
                
                // ç„¶åæ ¹æ®é…ç½®æ·»åŠ æ¿€æ´»çŠ¶æ€
                if (config[index] === 1) {
                    segment.classList.add('active');
                }
            });
        }

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function toggleTheme() {
            try {
                appState.isDarkMode = !appState.isDarkMode;
                const body = document.body;
                const themeIcon = document.getElementById('theme-icon');
                const themeText = document.getElementById('theme-text');
                
                if (appState.isDarkMode) {
                    body.setAttribute('data-theme', 'dark');
                    if (themeIcon) themeIcon.textContent = 'â˜€ï¸';
                    if (themeText) themeText.textContent = 'æ—¥é—´æ¨¡å¼';
                } else {
                    body.removeAttribute('data-theme');
                    if (themeIcon) themeIcon.textContent = 'ğŸŒ™';
                    if (themeText) themeText.textContent = 'å¤œé—´æ¨¡å¼';
                }
                
                // ä¸»é¢˜åˆ‡æ¢åå¼ºåˆ¶æ›´æ–°ä¸€æ¬¡æ—¶é’Ÿæ˜¾ç¤º
                setTimeout(updateClock, 100);
                
            } catch (error) {
                console.error('ä¸»é¢˜åˆ‡æ¢å‡ºé”™:', error);
                showNotification('âš ï¸ ä¸»é¢˜åˆ‡æ¢å¤±è´¥', 'warning');
            }
        }

        // æ‚£è€…ç±»å‹é€‰æ‹©
        function selectPatientType(type) {
            appState.currentPatientType = type;
            
            // æ›´æ–°UIçŠ¶æ€
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`.category-card.${type}`).classList.add('active');
            
            // éšè—æ‰€æœ‰è¡¨å•
            document.querySelectorAll('.form-container').forEach(form => {
                if (form.id !== 'actionForm') {
                    form.classList.remove('show');
                }
            });
            
            // æ˜¾ç¤ºå¯¹åº”è¡¨å•
            const targetForm = document.getElementById(`${type}Form`);
            if (targetForm) {
                targetForm.classList.add('show');
            }
            
            // é‡ç½®ç»“æœ
            const results = document.getElementById('results');
            results.classList.remove('show');
            appState.currentResults = null;
            
            // æ›´æ–°è¿›åº¦
            updateProgress();
            
            // æ»šåŠ¨åˆ°è¡¨å•åŒºåŸŸ
            setTimeout(() => {
                targetForm.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            // æ¸…é™¤æ‚£è€…ç±»å‹é€‰æ‹©
            appState.currentPatientType = null;
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // éšè—æ‰€æœ‰è¡¨å•
            document.querySelectorAll('.form-container').forEach(form => {
                if (form.id !== 'actionForm') {
                    form.classList.remove('show');
                }
            });
            
            // æ¸…é™¤æ‰€æœ‰è¾“å…¥
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.value = '';
                input.classList.remove('input-error');
            });
            
            // é‡ç½®æ‰€æœ‰é€‰æ‹©æ¡†
            document.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            // æ¸…é™¤éªŒè¯çŠ¶æ€
            document.querySelectorAll('.real-time-validation').forEach(el => {
                el.textContent = '';
            });
            
            // éšè—é”™è¯¯æ¶ˆæ¯
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            
            // éšè—å…¬å¼æ˜¾ç¤º
            document.querySelectorAll('.formula-display').forEach(el => {
                el.style.display = 'none';
            });
            
            // é‡ç½®ç»“æœ
            const results = document.getElementById('results');
            results.classList.remove('show');
            appState.currentResults = null;
            
            // é‡ç½®è¿›åº¦æ¡
            updateProgress();
            
            // ç¦ç”¨æŒ‰é’®
            document.getElementById('calculateBtn').disabled = true;
            document.getElementById('pdfBtn').disabled = true;
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            showNotification('âœ… è¡¨å•å·²é‡ç½®ï¼Œè¯·é‡æ–°é€‰æ‹©æ‚£è€…ç±»å‹', 'success');
        }

        // 2021å¹´CKD-EPI eGFRè®¡ç®—å‡½æ•°
        function calculateEGFR_2021_Corrected(creatinine_umol, age, gender) {
            let eGFR;
            
            if (gender === 'female') {
                if (creatinine_umol <= 62) {
                    eGFR = 142 * Math.pow(creatinine_umol / 62, -0.241) * Math.pow(0.9938, age) * 1.012;
                } else {
                    eGFR = 142 * Math.pow(62 / creatinine_umol, 1.2) * Math.pow(0.9938, age) * 1.012;
                }
            } else {
                if (creatinine_umol <= 80) {
                    eGFR = 142 * Math.pow(creatinine_umol / 80, -0.302) * Math.pow(0.9938, age);
                } else {
                    eGFR = 142 * Math.pow(80 / creatinine_umol, 1.2) * Math.pow(0.9938, age);
                }
            }
            
            return Math.round(eGFR);
        }

        // æ›´æ–°å…¬å¼æ˜¾ç¤º
        function updateRenalFormulaDisplay() {
            updateFormulaDisplay('renal');
        }

        function updateMetforminFormulaDisplay() {
            updateFormulaDisplay('metformin');
        }

        function updateFormulaDisplay(type) {
            const gender = document.getElementById(`${type}Gender`).value;
            const creatinine = parseFloat(document.getElementById(`${type}Creatinine`).value);
            const formulaDisplay = document.getElementById(`${type}FormulaDisplay`);
            
            if (!creatinine || creatinine < 30 || creatinine > 500) {
                formulaDisplay.style.display = 'none';
                return;
            }
            
            let formulaText = '';
            if (gender === 'female') {
                if (creatinine <= 62) {
                    formulaText = `å¥³æ€§ï¼ŒScr â‰¤ 62 Î¼mol/Lï¼šeGFR = 142 Ã— (${creatinine}/62)^(-0.241) Ã— 0.9938^å¹´é¾„ Ã— 1.012`;
                } else {
                    formulaText = `å¥³æ€§ï¼ŒScr > 62 Î¼mol/Lï¼šeGFR = 142 Ã— (62/${creatinine})^1.2 Ã— 0.9938^å¹´é¾„ Ã— 1.012`;
                }
            } else {
                if (creatinine <= 80) {
                    formulaText = `ç”·æ€§ï¼ŒScr â‰¤ 80 Î¼mol/Lï¼šeGFR = 142 Ã— (${creatinine}/80)^(-0.302) Ã— 0.9938^å¹´é¾„`;
                } else {
                    formulaText = `ç”·æ€§ï¼ŒScr > 80 Î¼mol/Lï¼šeGFR = 142 Ã— (80/${creatinine})^1.2 Ã— 0.9938^å¹´é¾„`;
                }
            }
            
            formulaDisplay.innerHTML = formulaText;
            formulaDisplay.style.display = 'block';
        }

        // å¿ƒåŠŸèƒ½ä¸å…¨é£é™©è¯„ä¼°
        function assessHeartFailureRisk(nyha, ef, bnp) {
            let riskLevel = 'low';
            let recommendations = [];
            let clinicalAction = '';
            
            const nyhaValue = parseInt(nyha);
            const efValue = parseFloat(ef);
            
            if (nyhaValue === 1 && efValue >= 50) {
                riskLevel = 'low';
                clinicalAction = 'ä½é£é™©å¤„ç†';
                recommendations = [
                    'å¿ƒåŠŸèƒ½å°šå¯ï¼ŒæŒ‰æ ‡å‡†æµç¨‹æ£€æŸ¥',
                    'é€‚å½“æ§åˆ¶é€ å½±å‰‚ç”¨é‡',
                    'ç›‘æµ‹è¡€æµåŠ¨åŠ›å­¦å˜åŒ–',
                    'æ£€æŸ¥åè§‚å¯Ÿ2å°æ—¶'
                ];
            } else if (nyhaValue <= 2 && efValue >= 40) {
                riskLevel = 'moderate';
                clinicalAction = 'ä¸­åº¦é£é™©ç›‘æµ‹';
                recommendations = [
                    'è½»åº¦å¿ƒåŠŸèƒ½ä¸å…¨ï¼Œéœ€è°¨æ…è¯„ä¼°',
                    'é€ å½±å‰‚ç”¨é‡å‡è‡³æ ‡å‡†ç”¨é‡çš„85%',
                    'æ§åˆ¶æ³¨å°„æµé€Ÿâ‰¤4.5ml/s',
                    'å¯†åˆ‡å…³æ³¨æœ‰æ— è¿‡æ•ååº”',
                    'æ£€æŸ¥å‰åç›‘æµ‹BNPå˜åŒ–',
                    'å¿…è¦æ—¶é¢„é˜²æ€§ä½¿ç”¨åˆ©å°¿å‰‚'
                ];
            } else if (nyhaValue === 3 || efValue < 40) {
                riskLevel = 'high';
                clinicalAction = 'é«˜é£é™©å¤„ç†';
                recommendations = [
                    'æ˜æ˜¾å¿ƒåŠŸèƒ½ä¸å…¨ï¼Œé«˜é£é™©',
                    'é€ å½±å‰‚ç”¨é‡å‡è‡³æ ‡å‡†ç”¨é‡çš„70%',
                    'ä¸¥æ ¼æ§åˆ¶æ³¨å°„æµé€Ÿâ‰¤4.0ml/s',
                    'åˆ†æ¬¡æ³¨å°„ï¼Œé¿å…çŸ­æ—¶é—´å¤§é‡è´Ÿè·',
                    'æ£€æŸ¥å‰ä¼˜åŒ–å¿ƒåŠŸèƒ½æ²»ç–—',
                    'å¿ƒå†…ç§‘ä¼šè¯Šè¯„ä¼°',
                    'å‡†å¤‡æ€¥æ•‘è¯ç‰©å’Œè®¾å¤‡'
                ];
            } else if (nyhaValue === 4 || efValue < 30) {
                riskLevel = 'very-high';
                clinicalAction = 'æé«˜é£é™© - æ…é‡è€ƒè™‘';
                recommendations = [
                    'ä¸¥é‡å¿ƒåŠŸèƒ½ä¸å…¨ï¼Œæé«˜é£é™©',
                    'å¼ºçƒˆå»ºè®®é¿å…æˆ–æ¨è¿Ÿæ£€æŸ¥',
                    'å¦‚å¿…é¡»æ£€æŸ¥ï¼Œéœ€CCUç›‘æŠ¤æ¡ä»¶',
                    'é€ å½±å‰‚ç”¨é‡å‡è‡³æœ€ä½ï¼ˆâ‰¤50mlï¼‰',
                    'è€ƒè™‘æ›¿ä»£æ£€æŸ¥æ–¹æ³•',
                    'å¿…é¡»å¿ƒå†…ç§‘å›¢é˜Ÿåœ¨åœº'
                ];
            }
            
            if (bnp === 'severe') {
                riskLevel = riskLevel === 'low' ? 'moderate' : 
                           riskLevel === 'moderate' ? 'high' : 'very-high';
                recommendations.unshift('BNPä¸¥é‡å‡é«˜ï¼Œæç¤ºå¿ƒåŠŸèƒ½å¤±ä»£å¿é£é™©');
            }
            
            return { 
                riskLevel, 
                recommendations, 
                clinicalAction,
                riskScore: calculateHeartRiskScore(nyhaValue, efValue, bnp)
            };
        }

        function calculateHeartRiskScore(nyha, ef, bnp) {
            let score = 0;
            score += nyha;
            
            if (ef >= 50) score += 1;
            else if (ef >= 40) score += 2;
            else if (ef >= 30) score += 3;
            else score += 4;
            
            switch(bnp) {
                case 'normal': score += 0; break;
                case 'mild': score += 1; break;
                case 'moderate': score += 2; break;
                case 'severe': score += 3; break;
            }
            
            return score;
        }

        // å®æ—¶è¾“å…¥éªŒè¯
        function setupRealTimeValidation() {
            const validationRules = {
                Height: { min: 100, max: 250, message: 'èº«é«˜å¿…é¡»åœ¨100-250cmä¹‹é—´' },
                Weight: { min: 20, max: 200, message: 'ä½“é‡å¿…é¡»åœ¨20-200kgä¹‹é—´' },
                Creatinine: { min: 30, max: 500, message: 'è¡€è‚Œé…å€¼å¿…é¡»åœ¨30-500Î¼mol/Lä¹‹é—´' },
                Age: { min: 18, max: 120, message: 'å¹´é¾„å¿…é¡»åœ¨18-120å²ä¹‹é—´' },
                EF: { min: 10, max: 80, message: 'EFå€¼å¿…é¡»åœ¨10-80%ä¹‹é—´' }
            };

            ['normal', 'renal', 'metformin', 'heart'].forEach(type => {
                Object.keys(validationRules).forEach(fieldType => {
                    const fieldId = type + fieldType;
                    const field = document.getElementById(fieldId);
                    const validation = document.getElementById(`${fieldId}-validation`);
                    const error = document.getElementById(`${fieldId}-error`);
                    
                    if (field) {
                        field.addEventListener('input', function() {
                            validateField(this, validationRules[fieldType], validation, error);
                            updateProgress();
                            
                            if (fieldType === 'Creatinine' && (type === 'renal' || type === 'metformin')) {
                                updateFormulaDisplay(type);
                            }
                        });
                    }
                });
            });
        }

        function validateField(field, rule, validationEl, errorEl) {
            const value = parseFloat(field.value);
            const isValid = !isNaN(value) && value >= rule.min && value <= rule.max;
            
            if (field.value === '') {
                field.classList.remove('input-error');
                if (validationEl) validationEl.textContent = '';
                if (errorEl) errorEl.style.display = 'none';
                return null;
            }
            
            if (isValid) {
                field.classList.remove('input-error');
                if (validationEl) {
                    validationEl.textContent = 'âœ“';
                    validationEl.className = 'real-time-validation validation-success';
                }
                if (errorEl) errorEl.style.display = 'none';
                return true;
            } else {
                field.classList.add('input-error');
                if (validationEl) {
                    validationEl.textContent = 'âœ—';
                    validationEl.className = 'real-time-validation validation-error';
                }
                if (errorEl) errorEl.style.display = 'block';
                return false;
            }
        }

        function updateProgress() {
            if (!appState.currentPatientType) {
                const progressBar = document.getElementById('progress');
                if (progressBar) progressBar.style.width = '0%';
                const calculateBtn = document.getElementById('calculateBtn');
                if (calculateBtn) calculateBtn.disabled = true;
                return;
            }
            
            const requiredFields = getRequiredFields(appState.currentPatientType);
            let completedFields = 0;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value !== '') {
                    completedFields++;
                }
            });
            
            const progress = (completedFields / requiredFields.length) * 100;
            const progressBar = document.getElementById('progress');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
            
            const calculateBtn = document.getElementById('calculateBtn');
            if (calculateBtn) {
                calculateBtn.disabled = progress < 100;
            }
        }

        function getRequiredFields(type) {
            const baseFields = [`${type}Height`, `${type}Weight`];
            
            if (type === 'renal' || type === 'metformin') {
                baseFields.push(`${type}Creatinine`, `${type}Age`);
            } else if (type === 'heart') {
                baseFields.push(`${type}EF`);
            }
            
            return baseFields;
        }

        // äºŒç”²åŒèƒé£é™©è¯„ä¼°
        function assessMetforminRisk(eGFR, dose, age) {
            let riskLevel = 'low';
            let recommendations = [];
            let clinicalAction = '';
            
            if (eGFR >= 60) {
                riskLevel = 'low';
                clinicalAction = 'æ ‡å‡†å¤„ç†';
                recommendations = [
                    'è‚¾åŠŸèƒ½æ­£å¸¸ï¼Œé€ å½±å‰åæš‚åœäºŒç”²åŒèƒ48å°æ—¶',
                    'é€ å½±åç›‘æµ‹è‚¾åŠŸèƒ½ï¼Œæ— å¼‚å¸¸å¯æ¢å¤ç”¨è¯',
                    'å»ºè®®é€ å½±å‰åå……åˆ†æ°´åŒ–'
                ];
            } else if (eGFR >= 45) {
                riskLevel = 'moderate';
                clinicalAction = 'è°¨æ…ç›‘æµ‹';
                recommendations = [
                    'è½»åº¦è‚¾åŠŸèƒ½ä¸å…¨ï¼Œéœ€è°¨æ…è¯„ä¼°',
                    'é€ å½±å‰åæš‚åœäºŒç”²åŒèƒ48-72å°æ—¶',
                    'é€ å½±å48-72å°æ—¶å¤æŸ¥è‚¾åŠŸèƒ½',
                    'å»ºè®®é™è„‰æ°´åŒ–ï¼š0.9% NaCl 1ml/kg/hï¼Œæ£€æŸ¥å‰6-12hå¼€å§‹'
                ];
            } else if (eGFR >= 30) {
                riskLevel = 'high';
                clinicalAction = 'é«˜é£é™©å¤„ç†';
                recommendations = [
                    'ä¸­åº¦è‚¾åŠŸèƒ½ä¸å…¨ï¼Œé«˜é£é™©',
                    'é€ å½±å‰åæš‚åœäºŒç”²åŒèƒ72å°æ—¶',
                    'è€ƒè™‘å‡å°‘é€ å½±å‰‚ç”¨é‡è‡³æ ‡å‡†ç”¨é‡çš„80%',
                    'å¿…é¡»é™è„‰æ°´åŒ–ï¼š0.9% NaCl 1ml/kg/h Ã— 12h',
                    'å¯†åˆ‡å…³æ³¨æœ‰æ— è¿‡æ•ååº”',
                    'é€ å½±å72å°æ—¶å†…å¯†åˆ‡ç›‘æµ‹è‚¾åŠŸèƒ½'
                ];
            } else {
                riskLevel = 'very-high';
                clinicalAction = 'æé«˜é£é™© - é¿å…æ£€æŸ¥';
                recommendations = [
                    'é‡åº¦è‚¾åŠŸèƒ½ä¸å…¨ï¼Œæé«˜é£é™©',
                    'å¼ºçƒˆå»ºè®®é¿å…ä½¿ç”¨é€ å½±å‰‚',
                    'å¦‚å¿…é¡»æ£€æŸ¥ï¼Œéœ€å†…åˆ†æ³Œç§‘å’Œè‚¾å†…ç§‘ä¼šè¯Š',
                    'è€ƒè™‘æ›¿ä»£æ£€æŸ¥æ–¹æ³•ï¼ˆMRIã€è¶…å£°ç­‰ï¼‰',
                    'å¦‚æ— æ³•é¿å…ï¼Œéœ€é€æå‡†å¤‡'
                ];
            }

            if (age >= 75 && eGFR < 60) {
                recommendations.unshift('é«˜é¾„æ‚£è€…ï¼Œå¢åŠ ç›‘æµ‹é¢‘æ¬¡');
            }
            
            return { 
                riskLevel, 
                recommendations, 
                clinicalAction,
                riskScore: calculateRiskScore(eGFR, age, dose)
            };
        }

        function calculateRiskScore(eGFR, age, dose) {
            let score = 0;
            
            if (eGFR >= 60) score += 1;
            else if (eGFR >= 45) score += 2;
            else if (eGFR >= 30) score += 3;
            else score += 4;
            
            if (age >= 75) score += 1;
            else if (age >= 65) score += 0.5;
            
            const doseNum = parseInt(dose);
            if (doseNum >= 2000) score += 1;
            else if (doseNum >= 1500) score += 0.5;
            
            return score;
        }

        // ä¸»è®¡ç®—å‡½æ•°
        function calculate() {
            if (!appState.currentPatientType) {
                showNotification('è¯·å…ˆé€‰æ‹©æ‚£è€…ç±»å‹', 'error');
                return;
            }
            
            const type = appState.currentPatientType;
            
            const heightElement = document.getElementById(`${type}Height`);
            const weightElement = document.getElementById(`${type}Weight`);
            const heartRateElement = type === 'heart' ? 
                document.getElementById('heartRate') : 
                document.getElementById(`${type}HeartRate`);
            const examTypeElement = document.getElementById(`${type}ExamType`);
            
            if (!heightElement || !weightElement || !heartRateElement || !examTypeElement) {
                showNotification('è¡¨å•å…ƒç´ ç¼ºå¤±ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }
            
            const height = parseFloat(heightElement.value);
            const weight = parseFloat(weightElement.value);
            const heartRate = parseInt(heartRateElement.value);
            const examType = examTypeElement.value;

            const validationErrors = [];
            
            if (!height || height < 100 || height > 250) {
                validationErrors.push('èº«é«˜èŒƒå›´åº”åœ¨100-250cmä¹‹é—´');
            }
            if (!weight || weight < 20 || weight > 200) {
                validationErrors.push('ä½“é‡èŒƒå›´åº”åœ¨20-200kgä¹‹é—´');
            }

            let specialData = null;
            
            if (type === 'renal' || type === 'metformin') {
                const creatinine = parseFloat(document.getElementById(`${type}Creatinine`).value);
                const age = parseInt(document.getElementById(`${type}Age`).value);
                const gender = document.getElementById(`${type}Gender`).value;

                if (!creatinine || creatinine < 30 || creatinine > 500) {
                    validationErrors.push('è¡€è‚Œé…å€¼èŒƒå›´åº”åœ¨30-500 Î¼mol/Lä¹‹é—´');
                }
                if (!age || age < 18 || age > 120) {
                    validationErrors.push('å¹´é¾„èŒƒå›´åº”åœ¨18-120å²ä¹‹é—´');
                }

                if (validationErrors.length === 0) {
                    const eGFR = calculateEGFR_2021_Corrected(creatinine, age, gender);
                    
                    specialData = {
                        eGFR,
                        creatinine,
                        age,
                        gender,
                        calculationMethod: '2021ç‰ˆCKD-EPIï¼ˆç›´æ¥è®¡ç®—ï¼‰'
                    };
                    
                    if (type === 'metformin') {
                        const dose = document.getElementById('metforminDose').value;
                        const metforminRisk = assessMetforminRisk(eGFR, dose, age);
                        specialData.metforminRisk = metforminRisk;
                        specialData.dose = dose;
                    }
                }
            } else if (type === 'heart') {
                const nyha = document.getElementById('heartNYHA').value;
                const ef = parseFloat(document.getElementById('heartEF').value);
                const bnp = document.getElementById('heartBNP').value;
                const creatinine = parseFloat(document.getElementById('heartCreatinine').value) || null;

                if (!ef || ef < 10 || ef > 80) {
                    validationErrors.push('EFå€¼èŒƒå›´åº”åœ¨10-80%ä¹‹é—´');
                }

                if (validationErrors.length === 0) {
                    const heartRisk = assessHeartFailureRisk(nyha, ef, bnp);
                    specialData = {
                        nyha,
                        ef,
                        bnp,
                        heartRisk,
                        creatinine
                    };
                }
            }

            if (validationErrors.length > 0) {
                showNotification('è¾“å…¥éªŒè¯å¤±è´¥ï¼š' + validationErrors.join('ï¼Œ'), 'error');
                return;
            }

            const results = performCalculations(height, weight, heartRate, examType, type, specialData);
            displayResults(results);
            
            appState.currentResults = results;
            document.getElementById('pdfBtn').disabled = false;
            
            showNotification('è®¡ç®—å®Œæˆï¼', 'success');
        }

        function performCalculations(height, weight, heartRate, examType, patientType, specialData) {
            const bmi = weight / Math.pow(height / 100, 2);
            
            let contrastVolume;
            let maxVolume;
            
            if (examType === 'coronary') {
                contrastVolume = weight * (heartRate <= 80 ? 0.8 : 0.85);
                maxVolume = 60;
            } else {
                contrastVolume = weight * (heartRate <= 80 ? 0.8 : 0.85) + 15;
                maxVolume = 75;
            }

            let contrastAdjustment = '';
            
            if (patientType === 'renal' && specialData && specialData.eGFR < 45) {
                const originalVolume = contrastVolume;
                contrastVolume = contrastVolume * 0.8;
                contrastAdjustment = `è‚¾åŠŸèƒ½ä¸å…¨è°ƒæ•´ï¼š${originalVolume.toFixed(1)}ml â†’ ${contrastVolume.toFixed(1)}ml`;
            }
            
            if (patientType === 'metformin' && specialData && specialData.eGFR < 60) {
                const reductionFactor = specialData.eGFR < 45 ? 0.8 : 0.9;
                const originalVolume = contrastVolume;
                contrastVolume = contrastVolume * reductionFactor;
                contrastAdjustment = `è‚¾åŠŸèƒ½ä¸å…¨è°ƒæ•´ï¼š${originalVolume.toFixed(1)}ml â†’ ${contrastVolume.toFixed(1)}ml`;
            }
            
            if (patientType === 'heart' && specialData) {
                const risk = specialData.heartRisk;
                let reductionFactor = 1;
                
                if (risk.riskLevel === 'moderate') reductionFactor = 0.85;
                else if (risk.riskLevel === 'high') reductionFactor = 0.70;
                else if (risk.riskLevel === 'very-high') reductionFactor = 0.50;
                
                if (reductionFactor < 1) {
                    const originalVolume = contrastVolume;
                    contrastVolume = contrastVolume * reductionFactor;
                    contrastAdjustment = `å¿ƒåŠŸèƒ½ä¸å…¨è°ƒæ•´ï¼š${originalVolume.toFixed(1)}ml â†’ ${contrastVolume.toFixed(1)}ml`;
                }
            }

            const isVolumeExceeded = contrastVolume > maxVolume;
            const originalVolume = contrastVolume;
            if (isVolumeExceeded) {
                contrastVolume = maxVolume;
            }

            let flowRate = examType === 'coronary' ? 
                contrastVolume / 12 : 
                (contrastVolume - 15) / 12;

            if (patientType === 'heart' && specialData) {
                const risk = specialData.heartRisk;
                let maxFlowRate = 5.0;
                
                if (risk.riskLevel === 'moderate') maxFlowRate = 4.5;
                else if (risk.riskLevel === 'high') maxFlowRate = 4.0;
                else if (risk.riskLevel === 'very-high') maxFlowRate = 3.5;
                
                if (flowRate > maxFlowRate) {
                    flowRate = maxFlowRate;
                }
            }

            const isFlowRateExceeded = flowRate > 5.0;
            const originalFlowRate = flowRate;
            if (isFlowRateExceeded) {
                flowRate = 5.0;
            }

            return {
                height, weight, heartRate, examType, bmi, patientType,
                contrastVolume, flowRate, maxVolume,
                isVolumeExceeded, originalVolume,
                isFlowRateExceeded, originalFlowRate,
                specialData, contrastAdjustment,
                timestamp: new Date()
            };
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('calculationResults');
            
            let bmiStatus, bmiClass;
            if (results.bmi < 18.5) {
                bmiStatus = 'åç˜¦';
                bmiClass = 'info-box renal';
            } else if (results.bmi < 24) {
                bmiStatus = 'æ­£å¸¸';
                bmiClass = 'info-box normal';
            } else if (results.bmi < 28) {
                bmiStatus = 'è¶…é‡';
                bmiClass = 'info-box renal';
            } else {
                bmiStatus = 'è‚¥èƒ–';
                bmiClass = 'info-box renal';
            }

            const examTypeText = results.examType === 'coronary' ? 'å† è„‰CTA' : 'èƒ¸ç—›ä¸‰è”';
            const heartRateText = results.heartRate <= 80 ? 'â‰¤80æ¬¡/åˆ†' : '>80æ¬¡/åˆ†';
            
            let patientTypeText = '';
            switch(results.patientType) {
                case 'normal': patientTypeText = 'æ­£å¸¸æ‚£è€…'; break;
                case 'renal': patientTypeText = 'è‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€…'; break;
                case 'metformin': patientTypeText = 'äºŒç”²åŒèƒç”¨è¯æ‚£è€…'; break;
                case 'heart': patientTypeText = 'å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…'; break;
            }

            let specialAssessment = '';
            
            if (results.patientType === 'normal') {
                specialAssessment = `
                    <div class="info-box normal">
                        <strong>æ­£å¸¸æ‚£è€…å¤„ç†æµç¨‹ï¼š</strong><br>
                        â€¢ è‚¾åŠŸèƒ½æ­£å¸¸ï¼Œæ— éœ€ç‰¹æ®Šè¯„ä¼°<br>
                        â€¢ æŒ‰æ ‡å‡†æµç¨‹è¿›è¡Œé€ å½±æ£€æŸ¥<br>
                        â€¢ å¸¸è§„ç›‘æµ‹ï¼Œæ— ç‰¹æ®Šé£é™©
                    </div>
                `;
            } else if (results.patientType === 'renal' && results.specialData) {
                const data = results.specialData;
                let renalRisk = '';
                let riskClass = '';
                
                if (data.eGFR >= 60) {
                    renalRisk = 'è‚¾åŠŸèƒ½æ­£å¸¸';
                    riskClass = 'normal';
                } else if (data.eGFR >= 45) {
                    renalRisk = 'è½»åº¦è‚¾åŠŸèƒ½ä¸å…¨';
                    riskClass = 'renal';
                } else if (data.eGFR >= 30) {
                    renalRisk = 'ä¸­åº¦è‚¾åŠŸèƒ½ä¸å…¨';
                    riskClass = 'renal';
                } else {
                    renalRisk = 'é‡åº¦è‚¾åŠŸèƒ½ä¸å…¨';
                    riskClass = 'metformin';
                }
                
                const recommendations = [];
                if (data.eGFR >= 60) {
                    recommendations.push('æŒ‰æ ‡å‡†æµç¨‹æ£€æŸ¥', 'å¸¸è§„æ°´åŒ–æ²»ç–—', 'é€ å½±åå¸¸è§„ç›‘æµ‹');
                } else if (data.eGFR >= 45) {
                    recommendations.push('é€‚å½“å‡å°‘é€ å½±å‰‚ç”¨é‡', 'åŠ å¼ºæ°´åŒ–æ²»ç–—', 'é€ å½±å24-48å°æ—¶å¤æŸ¥è‚¾åŠŸèƒ½');
                } else if (data.eGFR >= 30) {
                    recommendations.push('é€ å½±å‰‚ç”¨é‡å‡è‡³80%', 'å……åˆ†é™è„‰æ°´åŒ–', 'å¯†åˆ‡å…³æ³¨æœ‰æ— è¿‡æ•ååº”', 'é€ å½±å48-72å°æ—¶å¯†åˆ‡ç›‘æµ‹');
                } else {
                    recommendations.push('å¼ºçƒˆå»ºè®®é¿å…é€ å½±å‰‚æ£€æŸ¥', 'è€ƒè™‘MRIç­‰æ›¿ä»£æ£€æŸ¥', 'å¦‚å¿…é¡»æ£€æŸ¥éœ€è‚¾å†…ç§‘ä¼šè¯Š');
                }
                
                specialAssessment = `
                    <div class="result-item">
                        <span class="result-label">è¡€è‚Œé…å€¼</span>
                        <span class="result-value">${data.creatinine} Î¼mol/L</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">eGFR</span>
                        <span class="result-value">${data.eGFR} ml/min/1.73mÂ²</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">è‚¾åŠŸèƒ½è¯„ä¼°</span>
                        <span class="result-value" style="color: var(--${riskClass}-color);">${renalRisk}</span>
                    </div>
                    <div class="info-box ${riskClass}">
                        <strong>ä¸´åºŠå¤„ç†å»ºè®®ï¼š</strong><br>
                        ${recommendations.map(rec => `â€¢ ${rec}`).join('<br>')}
                    </div>
                `;
            } else if (results.patientType === 'metformin' && results.specialData) {
                const data = results.specialData;
                const risk = data.metforminRisk;
                
                let riskColor = '';
                switch(risk.riskLevel) {
                    case 'low': riskColor = 'var(--normal-color)'; break;
                    case 'moderate': riskColor = 'var(--renal-color)'; break;
                    case 'high': 
                    case 'very-high': riskColor = 'var(--metformin-color)'; break;
                }
                
                specialAssessment = `
                    <div class="result-item">
                        <span class="result-label">è¡€è‚Œé…å€¼</span>
                        <span class="result-value">${data.creatinine} Î¼mol/L</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">eGFR</span>
                        <span class="result-value">${data.eGFR} ml/min/1.73mÂ²</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">äºŒç”²åŒèƒå‰‚é‡</span>
                        <span class="result-value">${data.dose}mg/æ—¥</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">é£é™©ç­‰çº§</span>
                        <span class="result-value" style="color: ${riskColor};">${risk.clinicalAction}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">é£é™©è¯„åˆ†</span>
                        <span class="result-value">${risk.riskScore.toFixed(1)} åˆ†</span>
                    </div>
                    <div class="info-box ${risk.riskLevel === 'low' ? 'normal' : risk.riskLevel === 'moderate' ? 'renal' : 'metformin'}">
                        <strong>ä¸´åºŠå¤„ç†å»ºè®®ï¼š</strong><br>
                        ${risk.recommendations.map(rec => `â€¢ ${rec}`).join('<br>')}
                    </div>
                `;
            } else if (results.patientType === 'heart' && results.specialData) {
                const data = results.specialData;
                const risk = data.heartRisk;
                
                let riskColor = '';
                switch(risk.riskLevel) {
                    case 'low': riskColor = 'var(--normal-color)'; break;
                    case 'moderate': riskColor = 'var(--heart-color)'; break;
                    case 'high': riskColor = 'var(--renal-color)'; break;
                    case 'very-high': riskColor = 'var(--metformin-color)'; break;
                }
                
                const nyhaText = ['Içº§ - æ´»åŠ¨ä¸å—é™åˆ¶', 'IIçº§ - è½»åº¦æ´»åŠ¨å—é™', 'IIIçº§ - æ˜æ˜¾æ´»åŠ¨å—é™', 'IVçº§ - ä¼‘æ¯æ—¶ä¹Ÿæœ‰ç—‡çŠ¶'][parseInt(data.nyha) - 1];
                
                specialAssessment = `
                    <div class="result-item">
                        <span class="result-label">NYHAåˆ†çº§</span>
                        <span class="result-value">${nyhaText}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">å·¦å®¤å°„è¡€åˆ†æ•°</span>
                        <span class="result-value">${data.ef}%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">BNPæ°´å¹³</span>
                        <span class="result-value">${
                            data.bnp === 'normal' ? 'æ­£å¸¸èŒƒå›´' :
                            data.bnp === 'mild' ? 'è½»åº¦å‡é«˜' :
                            data.bnp === 'moderate' ? 'ä¸­åº¦å‡é«˜' : 'é‡åº¦å‡é«˜'
                        }</span>
                    </div>
                    ${data.creatinine ? `
                        <div class="result-item">
                            <span class="result-label">è¡€è‚Œé…å€¼</span>
                            <span class="result-value">${data.creatinine} Î¼mol/L</span>
                        </div>
                    ` : ''}
                    <div class="result-item">
                        <span class="result-label">é£é™©ç­‰çº§</span>
                        <span class="result-value" style="color: ${riskColor};">${risk.clinicalAction}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">é£é™©è¯„åˆ†</span>
                        <span class="result-value">${risk.riskScore} åˆ†</span>
                    </div>
                    <div class="info-box ${risk.riskLevel === 'low' ? 'normal' : risk.riskLevel === 'moderate' ? 'heart' : risk.riskLevel === 'high' ? 'renal' : 'metformin'}">
                        <strong>ä¸´åºŠå¤„ç†å»ºè®®ï¼š</strong><br>
                        ${risk.recommendations.map(rec => `â€¢ ${rec}`).join('<br>')}
                    </div>
                `;
            }

            let limitWarning = '';
            if (results.isVolumeExceeded) {
                limitWarning += `
                    <div class="info-box renal">
                        <strong>é€ å½±å‰‚ç”¨é‡é™åˆ¶æç¤ºï¼š</strong><br>
                        ç†è®ºè®¡ç®—ç”¨é‡ï¼š${results.originalVolume.toFixed(1)}ml<br>
                        å®‰å…¨é™åˆ¶ç”¨é‡ï¼š${results.contrastVolume.toFixed(1)}mlï¼ˆ${examTypeText}æœ€å¤§ç”¨é‡ï¼š${results.maxVolume}mlï¼‰<br>
                        <strong>å»ºè®®ï¼š</strong>å·²åº”ç”¨å®‰å…¨ä¸Šé™ï¼Œè¯·ç»“åˆæ‚£è€…å…·ä½“æƒ…å†µè¯„ä¼°ã€‚
                    </div>
                `;
            }
            
            if (results.isFlowRateExceeded) {
                limitWarning += `
                    <div class="info-box renal">
                        <strong>æ³¨å°„æµé€Ÿé™åˆ¶æç¤ºï¼š</strong><br>
                        ç†è®ºè®¡ç®—æµé€Ÿï¼š${results.originalFlowRate.toFixed(2)}ml/s<br>
                        å®‰å…¨é™åˆ¶æµé€Ÿï¼š${results.flowRate.toFixed(2)}ml/sï¼ˆæœ€å¤§æµé€Ÿï¼š5.0ml/sï¼‰<br>
                        <strong>å»ºè®®ï¼š</strong>å·²åº”ç”¨å®‰å…¨ä¸Šé™ï¼Œå¯è€ƒè™‘å»¶é•¿æ³¨å°„æ—¶é—´æˆ–è°ƒæ•´æ–¹æ¡ˆã€‚
                    </div>
                `;
            }

            if (results.contrastAdjustment) {
                limitWarning += `
                    <div class="info-box renal">
                        <strong>ç‰¹æ®Šè°ƒæ•´æç¤ºï¼š</strong><br>
                        ${results.contrastAdjustment}<br>
                        <strong>åŸå› ï¼š</strong>${
                            results.patientType === 'heart' ? 'å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…å‡å°‘é€ å½±å‰‚ç”¨é‡ä»¥é™ä½å®¹é‡è´Ÿè·' :
                            'è‚¾åŠŸèƒ½ä¸å…¨æ‚£è€…å‡å°‘é€ å½±å‰‚ç”¨é‡ä»¥é™ä½è‚¾æ¯’æ€§é£é™©'
                        }ã€‚
                    </div>
                `;
            }
            
            resultsContent.innerHTML = `
                <div class="calc-type">
                    <div>æ‚£è€…ç±»å‹ï¼š${patientTypeText} | æ£€æŸ¥ï¼š${examTypeText} | å¿ƒç‡ï¼š${heartRateText}</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">
                        è®¡ç®—æ—¶é—´ï¼š${results.timestamp.toLocaleString()}
                    </div>
                </div>
                
                <div class="result-item">
                    <span class="result-label">èº«é«˜</span>
                    <span class="result-value">${results.height} cm</span>
                </div>
                <div class="result-item">
                    <span class="result-label">ä½“é‡</span>
                    <span class="result-value">${results.weight} kg</span>
                </div>
                <div class="result-item">
                    <span class="result-label">BMIæŒ‡æ•°</span>
                    <span class="result-value">${results.bmi.toFixed(2)}</span>
                </div>
                
                <div class="${bmiClass}">
                    <strong>BMIè¯„ä¼°ï¼š</strong>${bmiStatus}
                </div>
                
                ${specialAssessment}
                
                <div class="result-item">
                    <span class="result-label">é€ å½±å‰‚ç”¨é‡</span>
                    <span class="result-value" style="color: ${results.isVolumeExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.contrastVolume.toFixed(1)} ml
                    </span>
                </div>
                <div class="result-item">
                    <span class="result-label">æ³¨å°„æµé€Ÿ</span>
                    <span class="result-value" style="color: ${results.isFlowRateExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.flowRate.toFixed(2)} ml/s
                    </span>
                </div>
                
                ${limitWarning}
                
                <div class="info-box normal">
                    <strong>è®¡ç®—ä¾æ®ï¼š</strong><br>
                    <strong>eGFRå…¬å¼ï¼š</strong>2021ç‰ˆCKD-EPIè‚¾å°çƒæ»¤è¿‡ç‡æ–¹ç¨‹ï¼ˆæ— ç§æ—ç³»æ•°ï¼Œç›´æ¥ä½¿ç”¨Î¼mol/Lï¼‰<br>
                    <strong>é€ å½±å‰‚ç”¨é‡ï¼š</strong>${results.examType === 'coronary' ? 
                        (results.heartRate <= 80 ? 'å† è„‰CTAå¿ƒç‡â‰¤80ï¼šä½“é‡Ã—0.8ml/kg' : 'å† è„‰CTAå¿ƒç‡>80ï¼šä½“é‡Ã—0.85ml/kg') :
                        (results.heartRate <= 80 ? 'èƒ¸ç—›ä¸‰è”å¿ƒç‡â‰¤80ï¼šä½“é‡Ã—0.8ml/kg + 15ml' : 'èƒ¸ç—›ä¸‰è”å¿ƒç‡>80ï¼šä½“é‡Ã—0.85ml/kg + 15ml')
                    }<br>
                    <strong>æ³¨å°„æµé€Ÿï¼š</strong>${results.examType === 'coronary' ? 'ç”¨é‡Ã·12s' : '(ç”¨é‡-15ml)Ã·12s'}<br>
                    <strong>å®‰å…¨é™åˆ¶ï¼š</strong>${results.examType === 'coronary' ? 'å† è„‰CTAæœ€å¤§60ml' : 'èƒ¸ç—›ä¸‰è”æœ€å¤§75ml'}ï¼Œæµé€Ÿæœ€å¤§5.0ml/s<br>
                    <strong>é™è„‰é€šè·¯ï¼š</strong>å³è‚˜ä¸­é™è„‰ï¼Œæ³¨å°„å‹åŠ›<300psi<br>
                    <strong>è®¾å¤‡ä¾æ®ï¼š</strong>è”å½±CT960+è®¾å¤‡æŠ€æœ¯å‚æ•°<br>
                    <strong>ç¨‹åºç‰ˆæœ¬ï¼š</strong>v3.2ï¼Œé›†æˆå®æ—¶ç”µå­é’Ÿæ˜¾ç¤ºåŠŸèƒ½
                </div>
            `;
            
            resultsDiv.classList.add('show');
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // PDFå¯¼å‡ºåŠŸèƒ½ - å¢å¼ºé”™è¯¯å¤„ç†
        function exportToPDF() {
            if (!appState.currentResults) {
                showNotification('æ²¡æœ‰å¯å¯¼å‡ºçš„è®¡ç®—ç»“æœ', 'warning');
                return;
            }
            
            try {
                const results = appState.currentResults;
                
                // éªŒè¯ç»“æœæ•°æ®å®Œæ•´æ€§
                if (!results.height || !results.weight || !results.bmi || !results.contrastVolume) {
                    throw new Error('è®¡ç®—ç»“æœæ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•ç”ŸæˆPDF');
                }
                
                const reportId = Date.now().toString(36).toUpperCase();
                const reportNumber = `${new Date().getFullYear()}${(new Date().getMonth() + 1).toString().padStart(2, '0')}${new Date().getDate().toString().padStart(2, '0')}_${reportId}`;
                
                // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
                if (typeof window.open !== 'function') {
                    throw new Error('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒPDFå¯¼å‡ºåŠŸèƒ½');
                }
                
                const pdfWindow = window.open('', '_blank', 'width=800,height=600');
                if (!pdfWindow) {
                    showNotification('æµè§ˆå™¨é˜»æ­¢äº†å¼¹çª—ï¼Œè¯·å…è®¸å¼¹çª—åé‡è¯•', 'warning');
                    return;
                }
                
                const pdfContent = generatePDFContent(results, reportNumber);
                
                // å®‰å…¨åœ°å†™å…¥å†…å®¹
                pdfWindow.document.open();
                pdfWindow.document.write(pdfContent);
                pdfWindow.document.close();
                
                // è®¾ç½®é”™è¯¯å¤„ç†
                pdfWindow.onerror = function(error) {
                    console.error('PDFçª—å£é”™è¯¯:', error);
                    showNotification('PDFç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯', 'error');
                    pdfWindow.close();
                };
                
                pdfWindow.onload = function() {
                    setTimeout(() => {
                        try {
                            pdfWindow.print();
                            showNotification('è¯·åœ¨æ‰“å°å¯¹è¯æ¡†ä¸­é€‰æ‹©"ä¿å­˜ä¸ºPDF"', 'info');
                        } catch (printError) {
                            console.error('æ‰“å°åŠŸèƒ½é”™è¯¯:', printError);
                            showNotification('æ— æ³•è°ƒç”¨æ‰“å°åŠŸèƒ½ï¼Œè¯·æ‰‹åŠ¨æ‰“å°é¡µé¢', 'warning');
                        }
                    }, 500);
                };
                
            } catch (error) {
                console.error('PDFå¯¼å‡ºå‡ºé”™:', error);
                showNotification('PDFå¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        function generatePDFContent(results, reportNumber) {
            const currentDate = new Date().toLocaleString();
            
            let bmiStatus = '';
            if (results.bmi < 18.5) bmiStatus = 'åç˜¦';
            else if (results.bmi < 24) bmiStatus = 'æ­£å¸¸';
            else if (results.bmi < 28) bmiStatus = 'è¶…é‡';
            else bmiStatus = 'è‚¥èƒ–';
            
            const examTypeText = results.examType === 'coronary' ? 'å† è„‰CTA' : 'èƒ¸ç—›ä¸‰è”';
            const heartRateText = results.heartRate <= 80 ? 'â‰¤80æ¬¡/åˆ†' : '>80æ¬¡/åˆ†';
            
            let patientTypeText = '';
            switch(results.patientType) {
                case 'normal': patientTypeText = 'æ­£å¸¸æ‚£è€…'; break;
                case 'renal': patientTypeText = 'è‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€…'; break;
                case 'metformin': patientTypeText = 'äºŒç”²åŒèƒç”¨è¯æ‚£è€…'; break;
                case 'heart': patientTypeText = 'å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…'; break;
            }

            // ç”Ÿæˆæ‚£è€…ç‰¹å®šä¿¡æ¯
            let patientSpecificInfo = '';
            
            if (results.patientType === 'normal') {
                patientSpecificInfo = `
                    <div class="data-row">
                        <span class="data-label">ç‰¹æ®Šè¯„ä¼°</span>
                        <span class="data-value">æ— éœ€ç‰¹æ®Šè¯„ä¼°</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">å¤„ç†æ–¹å¼</span>
                        <span class="data-value">æ ‡å‡†æµç¨‹</span>
                    </div>
                `;
            } else if (results.patientType === 'renal' && results.specialData) {
                const data = results.specialData;
                patientSpecificInfo = `
                    <div class="data-row">
                        <span class="data-label">æ€§åˆ«å¹´é¾„</span>
                        <span class="data-value">${data.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'} ${data.age}å²</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">è¡€è‚Œé…</span>
                        <span class="data-value">${data.creatinine} Î¼mol/L</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">eGFR</span>
                        <span class="data-value">${data.eGFR} ml/min/1.73mÂ²</span>
                    </div>
                `;
            } else if (results.patientType === 'metformin' && results.specialData) {
                const data = results.specialData;
                patientSpecificInfo = `
                    <div class="data-row">
                        <span class="data-label">æ€§åˆ«å¹´é¾„</span>
                        <span class="data-value">${data.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'} ${data.age}å²</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">è¡€è‚Œé…</span>
                        <span class="data-value">${data.creatinine} Î¼mol/L</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">eGFR</span>
                        <span class="data-value">${data.eGFR} ml/min/1.73mÂ²</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">äºŒç”²åŒèƒå‰‚é‡</span>
                        <span class="data-value">${data.dose} mg/æ—¥</span>
                    </div>
                `;
            } else if (results.patientType === 'heart' && results.specialData) {
                const data = results.specialData;
                const nyhaTexts = ['Içº§', 'IIçº§', 'IIIçº§', 'IVçº§'];
                const bnpTexts = { 'normal': 'æ­£å¸¸', 'mild': 'è½»åº¦å‡é«˜', 'moderate': 'ä¸­åº¦å‡é«˜', 'severe': 'é‡åº¦å‡é«˜' };
                patientSpecificInfo = `
                    <div class="data-row">
                        <span class="data-label">NYHAåˆ†çº§</span>
                        <span class="data-value">${nyhaTexts[parseInt(data.nyha) - 1]}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">å°„è¡€åˆ†æ•°EF</span>
                        <span class="data-value">${data.ef}%</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">BNPæ°´å¹³</span>
                        <span class="data-value">${bnpTexts[data.bnp]}</span>
                    </div>
                    ${data.creatinine ? `
                    <div class="data-row">
                        <span class="data-label">è¡€è‚Œé…</span>
                        <span class="data-value">${data.creatinine} Î¼mol/L</span>
                    </div>
                    ` : ''}
                `;
            }

            // ç”Ÿæˆä¸“ç§‘è¯„ä¼°ç»“æœ
            let assessmentResults = '';
            
            if (results.patientType === 'normal') {
                assessmentResults = `
                    <div class="assessment-section">
                        <div class="assessment-title">æ­£å¸¸æ‚£è€…å¤„ç†æµç¨‹</div>
                        <div class="assessment-content">è‚¾åŠŸèƒ½æ­£å¸¸ï¼Œæ— ç‰¹æ®Šç”¨è¯å²ï¼ŒæŒ‰æ ‡å‡†æµç¨‹è¿›è¡Œé€ å½±æ£€æŸ¥ï¼Œå¸¸è§„ç›‘æµ‹å³å¯</div>
                    </div>
                `;
            } else if (results.patientType === 'renal' && results.specialData) {
                const data = results.specialData;
                let riskLevel = data.eGFR >= 60 ? 'ä½é£é™©' : data.eGFR >= 45 ? 'ä¸­é£é™©' : data.eGFR >= 30 ? 'é«˜é£é™©' : 'æé«˜é£é™©';
                let riskColor = data.eGFR >= 60 ? '#22c55e' : data.eGFR >= 45 ? '#f59e0b' : '#ef4444';
                
                let clinicalRecommendation = '';
                if (data.eGFR >= 60) {
                    clinicalRecommendation = 'æ ‡å‡†æµç¨‹ï¼Œå¸¸è§„æ°´åŒ–æ²»ç–—ï¼Œé€ å½±åå¸¸è§„ç›‘æµ‹';
                } else if (data.eGFR >= 45) {
                    clinicalRecommendation = 'é€‚å½“å‡é‡ï¼ŒåŠ å¼ºæ°´åŒ–æ²»ç–—ï¼Œé€ å½±å24-48å°æ—¶å¤æŸ¥è‚¾åŠŸèƒ½';
                } else if (data.eGFR >= 30) {
                    clinicalRecommendation = 'é€ å½±å‰‚å‡é‡è‡³80%ï¼Œå……åˆ†é™è„‰æ°´åŒ–ï¼Œå¯†åˆ‡å…³æ³¨æœ‰æ— è¿‡æ•ååº”ï¼Œå¯†åˆ‡ç›‘æµ‹48-72å°æ—¶';
                } else {
                    clinicalRecommendation = 'å¼ºçƒˆå»ºè®®é¿å…é€ å½±å‰‚æ£€æŸ¥ï¼Œè€ƒè™‘MRIã€è¶…å£°ç­‰æ›¿ä»£æ£€æŸ¥æ–¹æ³•';
                }

                assessmentResults = `
                    <div class="assessment-section">
                        <div class="assessment-title">è‚¾åŠŸèƒ½è¯„ä¼°ç»“æœ</div>
                        <div class="assessment-content">
                            <span style="color: ${riskColor}; font-weight: bold;">${riskLevel}</span> | ${clinicalRecommendation}
                        </div>
                    </div>
                `;
            } else if (results.patientType === 'metformin' && results.specialData) {
                const data = results.specialData;
                const risk = data.metforminRisk;
                let riskColor = risk.riskLevel === 'low' ? '#22c55e' : risk.riskLevel === 'moderate' ? '#f59e0b' : '#ef4444';

                assessmentResults = `
                    <div class="assessment-section">
                        <div class="assessment-title">äºŒç”²åŒèƒé£é™©è¯„ä¼°</div>
                        <div class="assessment-content">
                            é£é™©è¯„åˆ†${risk.riskScore.toFixed(1)}åˆ†, <span style="color: ${riskColor}; font-weight: bold;">${risk.clinicalAction}</span><br>
                            ç”¨è¯ç®¡ç†: é€ å½±å‰${data.eGFR >= 60 ? '48å°æ—¶' : '48-72å°æ—¶'}åœè¯ï¼Œé€ å½±å${data.eGFR >= 60 ? '24-48å°æ—¶' : '48-72å°æ—¶'}å¤æŸ¥è‚¾åŠŸèƒ½æ­£å¸¸åæ¢å¤ç”¨è¯
                        </div>
                    </div>
                `;
            } else if (results.patientType === 'heart' && results.specialData) {
                const data = results.specialData;
                const risk = data.heartRisk;
                let riskColor = risk.riskLevel === 'low' ? '#22c55e' : risk.riskLevel === 'moderate' ? '#3b82f6' : risk.riskLevel === 'high' ? '#f59e0b' : '#ef4444';

                let monitoringPlan = '';
                if (risk.riskLevel === 'low') {
                    monitoringPlan = 'æ ‡å‡†å¤„ç†ï¼Œæ£€æŸ¥åè§‚å¯Ÿ2å°æ—¶';
                } else if (risk.riskLevel === 'moderate') {
                    monitoringPlan = 'ç”¨é‡å‡è‡³85%ï¼Œæµé€Ÿâ‰¤4.5ml/sï¼Œæ£€æŸ¥åè§‚å¯Ÿ4å°æ—¶';
                } else if (risk.riskLevel === 'high') {
                    monitoringPlan = 'ç”¨é‡å‡è‡³70%ï¼Œæµé€Ÿâ‰¤4.0ml/sï¼Œå¿ƒå†…ç§‘ä¼šè¯Šï¼Œå‡†å¤‡æ€¥æ•‘è®¾å¤‡';
                } else {
                    monitoringPlan = 'æ…é‡è€ƒè™‘ï¼Œå»ºè®®æ¨è¿Ÿæ£€æŸ¥æˆ–åœ¨CCUç›‘æŠ¤æ¡ä»¶ä¸‹è¿›è¡Œ';
                }

                assessmentResults = `
                    <div class="assessment-section">
                        <div class="assessment-title">å¿ƒåŠŸèƒ½è¯„ä¼°ç»“æœ</div>
                        <div class="assessment-content">
                            é£é™©è¯„åˆ†${risk.riskScore}åˆ†, <span style="color: ${riskColor}; font-weight: bold;">${risk.clinicalAction}</span><br>
                            ç›‘æŠ¤æ–¹æ¡ˆ: ${monitoringPlan}
                        </div>
                    </div>
                `;
            }

            // ç”Ÿæˆå®‰å…¨æç¤ºéƒ¨åˆ†
            let safetySection = '';
            if (results.isVolumeExceeded || results.isFlowRateExceeded || results.contrastAdjustment) {
                let warnings = [];
                
                if (results.isVolumeExceeded) {
                    warnings.push(`ç”¨é‡è¶…é™: ç†è®º${results.originalVolume.toFixed(1)}ml â†’ é™åˆ¶${results.contrastVolume.toFixed(1)}ml`);
                }
                
                if (results.isFlowRateExceeded) {
                    warnings.push(`æµé€Ÿè¶…é™: ç†è®º${results.originalFlowRate.toFixed(2)}ml/s â†’ é™åˆ¶${results.flowRate.toFixed(2)}ml/s`);
                }
                
                if (results.contrastAdjustment) {
                    warnings.push(`${results.contrastAdjustment}`);
                }
                
                safetySection = `
                    <div class="warning-section">
                        <div class="warning-title">å®‰å…¨é™åˆ¶ä¸è°ƒæ•´</div>
                        <div class="warning-content">${warnings.join(' | ')}<br>
                        å·²åº”ç”¨ç¨‹åºå®‰å…¨ä¸Šé™ï¼Œå®é™…ä½¿ç”¨éœ€ç»“åˆæ‚£è€…å…·ä½“æƒ…å†µè¯„ä¼°</div>
                    </div>
                `;
            }
            
            return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å½±åƒå­¦æœ¯ç ”ç©¶è®¡ç®—ç»“æœ_${reportNumber}</title>
    <style>
        @page { size: A4; margin: 1cm; }
        body { 
            font-family: 'Microsoft YaHei', 'SimSun', sans-serif; 
            line-height: 1.3; 
            color: #333; 
            margin: 0; 
            padding: 0; 
            font-size: 11px; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header { 
            text-align: center; 
            border-bottom: 2px solid #4f46e5; 
            padding-bottom: 8px; 
            margin-bottom: 15px; 
        }
        .header h1 { 
            color: #4f46e5; 
            font-size: 18px; 
            margin: 0 0 5px 0; 
            font-weight: 700; 
        }
        .header .subtitle { 
            color: #666; 
            font-size: 12px; 
            margin-bottom: 5px; 
        }
        .header .meta-info { 
            font-size: 9px; 
            color: #888; 
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            flex: 1;
        }
        
        .info-card {
            border: 1.5px solid #ddd;
            border-radius: 6px;
            height: fit-content;
        }
        
        .card-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #ddd;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 11px;
            color: #4f46e5;
        }
        
        .card-body {
            padding: 10px 12px;
        }
        
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 10px;
        }
        
        .data-row:last-child {
            border-bottom: none;
        }
        
        .data-label {
            color: #666;
            font-weight: 500;
        }
        
        .data-value {
            color: #333;
            font-weight: 600;
        }
        
        .result-highlight {
            color: #4f46e5;
            font-size: 11px;
            font-weight: 700;
        }
        
        .assessment-section {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #f8f9fa, #f1f3f4);
            border: 1.5px solid #ddd;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 8px 0;
        }
        
        .assessment-title {
            font-weight: 700;
            font-size: 11px;
            color: #4f46e5;
            margin-bottom: 5px;
        }
        
        .assessment-content {
            font-size: 10px;
            line-height: 1.4;
            color: #333;
        }
        
        .warning-section {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            border: 1.5px solid #f59e0b;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 8px 0;
        }
        
        .warning-title {
            font-weight: 700;
            font-size: 11px;
            color: #92400e;
            margin-bottom: 5px;
        }
        
        .warning-content {
            font-size: 10px;
            line-height: 1.4;
            color: #92400e;
        }
        
        .calculation-summary {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1.5px solid #bfdbfe;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 8px 0;
        }
        
        .calculation-summary h3 {
            color: #1e40af;
            font-size: 11px;
            margin: 0 0 8px 0;
            font-weight: 700;
        }
        
        .calc-formula {
            font-size: 9px;
            line-height: 1.4;
            color: #1e40af;
        }
        
        .tech-specs {
            background: linear-gradient(135deg, #f8f9fa, #f1f3f4);
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 9px;
            line-height: 1.3;
            color: #666;
            margin: 15px 0 10px 0;
            border: 1px solid #e2e8f0;
        }
        
        .footer {
            border-top: 1.5px solid #ddd;
            padding-top: 10px;
            text-align: center;
            font-size: 8px;
            color: #666;
            line-height: 1.3;
            margin-top: auto;
        }
        
        @media print { 
            body { margin: 0; padding: 0; } 
            .no-print { display: none; } 
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>å½±åƒå­¦æœ¯ç ”ç©¶è®¡ç®—ç»“æœ</h1>
        <div class="subtitle">CTAé€ å½±å‰‚ç”¨é‡ä¸BMIå­¦æœ¯å‚è€ƒè®¡ç®— v3.2 - ${patientTypeText}</div>
        <div class="meta-info">
            è®¡ç®—æ—¶é—´: ${results.timestamp.toLocaleString()} | ç”Ÿæˆæ—¶é—´: ${currentDate} | ç¼–å·: ${reportNumber}
        </div>
    </div>
    
    <div class="main-content">
        <div class="info-card">
            <div class="card-header">åŸºæœ¬ä¿¡æ¯ä¸BMIè¯„ä¼°</div>
            <div class="card-body">
                <div class="data-row">
                    <span class="data-label">æ‚£è€…ç±»å‹</span>
                    <span class="data-value">${patientTypeText}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">èº«é«˜/ä½“é‡</span>
                    <span class="data-value">${results.height}cm / ${results.weight}kg</span>
                </div>
                <div class="data-row">
                    <span class="data-label">BMIæŒ‡æ•°</span>
                    <span class="data-value">${results.bmi.toFixed(2)} (${bmiStatus})</span>
                </div>
                <div class="data-row">
                    <span class="data-label">æ£€æŸ¥ç±»å‹</span>
                    <span class="data-value">${examTypeText}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">å¿ƒç‡å‚æ•°</span>
                    <span class="data-value">${heartRateText}</span>
                </div>
            </div>
        </div>
        
        <div class="info-card">
            <div class="card-header">ä¸“ç§‘å‚æ•°ä¸è¯„ä¼°</div>
            <div class="card-body">
                ${patientSpecificInfo}
            </div>
        </div>
        
        <div class="info-card">
            <div class="card-header">è®¡ç®—ç»“æœ</div>
            <div class="card-body">
                <div class="data-row">
                    <span class="data-label">é€ å½±å‰‚ç”¨é‡</span>
                    <span class="data-value result-highlight" style="color: ${results.isVolumeExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.contrastVolume.toFixed(1)} ml
                    </span>
                </div>
                <div class="data-row">
                    <span class="data-label">æ³¨å°„æµé€Ÿ</span>
                    <span class="data-value result-highlight" style="color: ${results.isFlowRateExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.flowRate.toFixed(2)} ml/s
                    </span>
                </div>
                <div class="data-row">
                    <span class="data-label">æ³¨å°„æ—¶é—´</span>
                    <span class="data-value">${results.examType === 'coronary' ? '12ç§’' : 'çº¦' + Math.ceil((results.contrastVolume - (results.examType === 'triple' ? 15 : 0)) / results.flowRate) + 'ç§’'}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">å®‰å…¨ä¸Šé™</span>
                    <span class="data-value">â‰¤${results.maxVolume}ml, â‰¤5.0ml/s</span>
                </div>
            </div>
        </div>
        
        <div class="info-card">
            <div class="card-header">æ³¨å°„æ–¹æ¡ˆä¸ç›‘æŠ¤</div>
            <div class="card-body">
                <div class="data-row">
                    <span class="data-label">é™è„‰é€šè·¯</span>
                    <span class="data-value">å³è‚˜ä¸­é™è„‰</span>
                </div>
                <div class="data-row">
                    <span class="data-label">æ³¨å°„å‹åŠ›</span>
                    <span class="data-value"><300psi</span>
                </div>
                <div class="data-row">
                    <span class="data-label">è¿‡æ•ç›‘æµ‹</span>
                    <span class="data-value">å¯†åˆ‡å…³æ³¨æœ‰æ— è¿‡æ•ååº”</span>
                </div>
                <div class="data-row">
                    <span class="data-label">ç›‘æŠ¤æ—¶é—´</span>
                    <span class="data-value">${results.patientType === 'heart' ? '4-6å°æ—¶' : '2-4å°æ—¶'}</span>
                </div>
            </div>
        </div>
        
        ${assessmentResults}
        
        ${safetySection}
        
        <div class="calculation-summary">
            <h3>è®¡ç®—å…¬å¼ä¸ç†è®ºä¾æ®</h3>
            <div class="calc-formula">
                <strong>BMIè®¡ç®—:</strong> ${results.weight} Ã· (${results.height/100})Â² = ${results.bmi.toFixed(2)} | 
                <strong>é€ å½±å‰‚ç”¨é‡:</strong> ${results.examType === 'coronary' ? 
                    (results.heartRate <= 80 ? 'ä½“é‡Ã—0.8ml/kg' : 'ä½“é‡Ã—0.85ml/kg') :
                    (results.heartRate <= 80 ? 'ä½“é‡Ã—0.8+15ml' : 'ä½“é‡Ã—0.85+15ml')
                } | 
                <strong>æ³¨å°„æµé€Ÿ:</strong> ${results.examType === 'coronary' ? 'ç”¨é‡Ã·12s' : '(ç”¨é‡-15ml)Ã·12s'}
                ${results.contrastAdjustment ? `<br><strong>è°ƒæ•´ä¾æ®:</strong> ${results.contrastAdjustment}` : ''}
                ${results.specialData && (results.patientType === 'renal' || results.patientType === 'metformin') ? 
                `<br><strong>eGFRè®¡ç®—:</strong> 2021ç‰ˆCKD-EPIå…¬å¼ï¼ˆæ— ç§æ—ç³»æ•°ï¼‰ï¼Œ${results.specialData.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'}${results.specialData.age}å²æ‚£è€…` : ''}
            </div>
        </div>
    </div>
    
    <div class="tech-specs">
        <strong>æŠ€æœ¯è§„èŒƒ:</strong> è”å½±CT960+è®¾å¤‡å‚æ•° | 
        <strong>é™è„‰é€šè·¯:</strong> å³è‚˜ä¸­é™è„‰ | 
        <strong>æ³¨å°„å‹åŠ›:</strong> <300psi | 
        <strong>ç¨‹åºç‰ˆæœ¬:</strong> v3.2 | 
        <strong>å¼€å‘è€…:</strong> å½±åƒæ¶›å“¥ | 
        <strong>è®¡ç®—æ ‡å‡†:</strong> åŸºäºè”å½±è®¾å¤‡æŠ€æœ¯å‚æ•°ä¸ä¸´åºŠç ”ç©¶æ•°æ®
    </div>
    
    <div class="footer">
        <p><strong>é‡è¦å£°æ˜:</strong> æœ¬è®¡ç®—ç»“æœä»…ä¾›å½±åƒæŠ€æœ¯æ•™å­¦å’Œå­¦æœ¯ç ”ç©¶å‚è€ƒï¼Œä¸¥ç¦ç”¨äºä¸´åºŠè¯Šæ–­æˆ–æ²»ç–—å†³ç­–ã€‚å®é™…ä½¿ç”¨æ—¶å¿…é¡»ç»“åˆæ‚£è€…å…·ä½“ç—…å²ã€å®éªŒå®¤æ£€æŸ¥ç»“æœå’Œä¸´åºŠåŒ»å¸ˆåˆ¤æ–­ã€‚å¼€å‘è€…ä¸æ‰¿æ‹…ä»»ä½•æ³•å¾‹è´£ä»»ã€‚</p>
        <p><strong>ç»“æœç¼–å·:</strong> ${reportNumber} | <strong>æŠ€æœ¯æ”¯æŒ:</strong> è”å½±CT960+å¹³å° | <strong>ä½¿ç”¨è®¸å¯:</strong> ä»…é™å­¦æœ¯ç ”ç©¶ç”¨é€”</p>
    </div>
</body>
</html>`;
        }

        // é€šçŸ¥æ˜¾ç¤ºå‡½æ•°
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 15px 20px;
                border-radius: 8px; color: white; font-weight: 500; z-index: 1000;
                opacity: 0; transition: opacity 0.3s ease; max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            switch(type) {
                case 'success': notification.style.background = '#22c55e'; break;
                case 'error': notification.style.background = '#ef4444'; break;
                case 'warning': notification.style.background = '#f59e0b'; break;
                default: notification.style.background = '#3b82f6';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.opacity = '1', 10);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // åˆå§‹åŒ–ç”µå­é’Ÿ
                updateClock();
                setInterval(updateClock, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡
                
                setupRealTimeValidation();
                updateProgress();
                
                document.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !document.getElementById('calculateBtn').disabled) {
                        calculate();
                    }
                });
                
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å‡ºé”™:', error);
                showNotification('âš ï¸ é¡µé¢åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨', 'warning');
            }
        });

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            console.error('å…¨å±€é”™è¯¯:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
        });
    </script>
</body>
</html>

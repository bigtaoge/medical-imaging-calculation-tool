<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½±åƒå­¦æœ¯ç ”ç©¶è®¡ç®—å·¥å…· v4.2 </title>
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #7c3aed;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg: #ffffff;
            --text: #1e293b;
            --card: #f8fafc;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --normal-color: #22c55e;
            --renal-color: #f59e0b;
            --metformin-color: #ef4444;
            --heart-color: #3b82f6;
            --allergy-color: #8b5cf6;
        }

        [data-theme="dark"] {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #f87171;
            --bg: #0f172a;
            --text: #e2e8f0;
            --card: #1e293b;
            --border: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --heart-color: #60a5fa;
            --allergy-color: #a78bfa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text);
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        h1 {
            font-size: 2.8em;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .subtitle {
            font-size: 1.2em;
            color: var(--text);
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .developer-info {
            margin: 15px 0;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
        }

        .clock-container {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border: 2px solid transparent;
            background-clip: padding-box;
            border-radius: 16px;
            padding: 20px;
            margin: 25px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 
                0 8px 32px rgba(79, 70, 229, 0.1),
                inset 0 1px 3px rgba(255, 255, 255, 0.8),
                inset 0 -1px 2px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .clock-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 2px;
            background: linear-gradient(135deg, var(--primary), var(--secondary), #22c55e, var(--primary));
            border-radius: 16px;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            z-index: -1;
            animation: borderGlow 3s ease-in-out infinite alternate;
        }

        @keyframes borderGlow {
            0% { opacity: 0.6; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.02); }
        }

        .digits-container {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .digit-group {
            display: flex;
            gap: 8px;
        }

        .digit {
            position: relative;
            width: 60px;
            height: 100px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 2px rgba(255, 255, 255, 0.8),
                inset 0 -1px 1px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(79, 70, 229, 0.1);
            transition: all 0.3s ease;
        }

        .digit:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.15),
                inset 0 1px 2px rgba(255, 255, 255, 0.9),
                inset 0 -1px 1px rgba(0, 0, 0, 0.05);
        }

        .segment {
            position: absolute;
            background: transparent;
            border-radius: 3px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .segment.active {
            background: #333333;
            box-shadow: 
                0 0 4px rgba(51, 51, 51, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .segment.active {
            background: #ffffff !important;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.4) !important;
        }

        .segment-a { top: 8px; left: 12px; width: 36px; height: 8px; }
        .segment-d { bottom: 8px; left: 12px; width: 36px; height: 8px; }
        .segment-g { top: 50%; left: 12px; width: 36px; height: 8px; transform: translateY(-50%); }
        .segment-b { top: 12px; right: 8px; width: 8px; height: 36px; }
        .segment-c { bottom: 12px; right: 8px; width: 8px; height: 36px; }
        .segment-e { bottom: 12px; left: 8px; width: 8px; height: 36px; }
        .segment-f { top: 12px; left: 8px; width: 8px; height: 36px; }

        .clock-colon {
            font-size: 2.5rem;
            color: #333333;
            margin: 0 8px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(51, 51, 51, 0.2);
            transition: all 0.3s ease;
        }

        .clock-label {
            font-size: 13px;
            color: var(--primary);
            text-align: center;
            margin-top: 12px;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .clock-container {
            background: linear-gradient(145deg, #1e293b, #334155);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 3px rgba(255, 255, 255, 0.1),
                inset 0 -1px 2px rgba(0, 0, 0, 0.2);
        }

        [data-theme="dark"] .digit {
            background: linear-gradient(145deg, #334155, #475569);
            border: 1px solid rgba(99, 102, 241, 0.2);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.3),
                inset 0 1px 2px rgba(255, 255, 255, 0.1),
                inset 0 -1px 1px rgba(0, 0, 0, 0.2);
        }

        [data-theme="dark"] .clock-colon {
            color: #ffffff !important;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.4) !important;
        }

        .patient-category-selector {
            background: var(--card);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border);
        }

        .category-title {
            text-align: center;
            font-size: 1.8em;
            color: var(--primary);
            margin-bottom: 25px;
            font-weight: 700;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
        }

        .category-card {
            background: var(--bg);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            transition: all 0.3s ease;
        }

        .category-card.normal::before { background: var(--normal-color); }
        .category-card.renal::before { background: var(--renal-color); }
        .category-card.metformin::before { background: var(--metformin-color); }
        .category-card.heart::before { background: var(--heart-color); }
        .category-card.allergy::before { background: var(--allergy-color); }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .category-card.active {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(79, 70, 229, 0.2);
        }

        .category-card.normal.active {
            border-color: var(--normal-color);
            box-shadow: 0 8px 30px rgba(34, 197, 94, 0.2);
        }

        .category-card.renal.active {
            border-color: var(--renal-color);
            box-shadow: 0 8px 30px rgba(245, 158, 11, 0.2);
        }

        .category-card.metformin.active {
            border-color: var(--metformin-color);
            box-shadow: 0 8px 30px rgba(239, 68, 68, 0.2);
        }

        .category-card.heart.active {
            border-color: var(--heart-color);
            box-shadow: 0 8px 30px rgba(59, 130, 246, 0.2);
        }

        .category-card.allergy.active {
            border-color: var(--allergy-color);
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.2);
        }

        .category-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }

        .category-name {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .category-description {
            font-size: 0.95em;
            color: var(--text);
            opacity: 0.7;
            line-height: 1.5;
        }

        .category-card.normal .category-name { color: var(--normal-color); }
        .category-card.renal .category-name { color: var(--renal-color); }
        .category-card.metformin .category-name { color: var(--metformin-color); }
        .category-card.heart .category-name { color: var(--heart-color); }
        .category-card.allergy .category-name { color: var(--allergy-color); }

        .form-container {
            display: none;
            animation: slideIn 0.5s ease;
        }

        .form-container.show {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            background: var(--card);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .form-section:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title.normal { color: var(--normal-color); }
        .section-title.renal { color: var(--renal-color); }
        .section-title.metformin { color: var(--metformin-color); }
        .section-title.heart { color: var(--heart-color); }
        .section-title.allergy { color: var(--allergy-color); }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        label {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .required {
            color: var(--error);
        }

        input, select {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .input-hint {
            font-size: 12px;
            color: var(--text);
            opacity: 0.6;
            margin-top: 4px;
        }

        .input-error {
            border-color: var(--error) !important;
            background-color: rgba(239, 68, 68, 0.05);
        }

        .error-message {
            color: var(--error);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .real-time-validation {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }

        .validation-success { color: var(--success); }
        .validation-error { color: var(--error); }

        .formula-display {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--text);
            opacity: 0.8;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: var(--card);
        }

        .checkbox-item.checked {
            background: rgba(79, 70, 229, 0.1);
            border-color: var(--primary);
        }

        .checkbox-item input[type="checkbox"], .checkbox-item input[type="radio"] {
            margin: 0;
            width: auto;
            height: auto;
        }

        .info-box {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.6;
            border-left: 4px solid;
        }

        .info-box.normal {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #065f46;
            border-left-color: var(--normal-color);
        }

        .info-box.renal {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            color: #92400e;
            border-left-color: var(--renal-color);
        }

        .info-box.metformin {
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            color: #991b1b;
            border-left-color: var(--metformin-color);
        }

        .info-box.heart {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e3a8a;
            border-left-color: var(--heart-color);
        }

        .info-box.allergy {
            background: linear-gradient(135deg, #e9d5ff, #d8b4fe);
            color: #581c87;
            border-left-color: var(--allergy-color);
        }

        .grading-table {
            width: 100%;
            margin: 15px 0;
            border-collapse: collapse;
            font-size: 12px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .grading-table th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 11px;
        }

        .grading-table td {
            padding: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
            font-size: 11px;
        }

        .grading-table .grade-level {
            font-weight: 700;
            white-space: nowrap;
        }

        .grade-minimal { color: var(--success); }
        .grade-low { color: var(--normal-color); }
        .grade-moderate { color: var(--renal-color); }
        .grade-high { color: var(--metformin-color); }
        .grade-very-high { color: var(--error); }

        .risk-score-display {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .score-value {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .score-minimal { color: var(--success); }
        .score-low { color: var(--normal-color); }
        .score-moderate { color: var(--renal-color); }
        .score-high { color: var(--metformin-color); }
        .score-very-high { color: var(--error); }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-secondary {
            background: var(--card);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--border);
        }

        .results {
            background: var(--card);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid var(--border);
            margin-top: 25px;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .results.show { display: block; }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 12px;
            background: var(--bg);
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .result-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .result-label {
            font-weight: 500;
            color: var(--text);
        }

        .result-value {
            font-size: 1.2em;
            color: var(--primary);
            font-weight: 700;
        }

        .calc-type {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
        }

        .disclaimer {
            background: linear-gradient(135deg, #fef7cd, #fed7aa);
            color: #92400e;
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid var(--warning);
            margin-top: 25px;
            font-size: 13px;
            line-height: 1.6;
        }

        .disclaimer h3 {
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 700;
        }

        .highlight {
            font-weight: 700;
            color: #b45309;
        }

        [data-theme="dark"] .grading-table {
            background: #1e293b;
        }

        [data-theme="dark"] .grading-table td {
            border-color: #374151;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; }
            h1 { font-size: 2.2em; }
            .form-row { grid-template-columns: 1fr; gap: 15px; }
            .theme-toggle { 
                position: relative; 
                margin-bottom: 20px; 
                top: auto;
                right: auto;
                align-self: center;
            }
            .btn-group { flex-direction: column; }
            
            .category-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }

            .grading-table {
                font-size: 10px;
            }

            .grading-table th,
            .grading-table td {
                padding: 6px 4px;
            }

            .clock-container {
                padding: 15px 10px;
                margin: 20px 0;
            }
            
            .digits-container {
                gap: 6px;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding: 0 10px;
            }
            
            .digit-group {
                gap: 4px;
                flex-shrink: 0;
            }
            
            .digit {
                width: 45px;
                height: 75px;
                min-width: 45px;
            }
            
            .segment-a, .segment-d, .segment-g {
                width: 29px;
                height: 5px;
                left: 8px;
            }
            
            .segment-b, .segment-c, .segment-e, .segment-f {
                width: 5px;
                height: 26px;
            }
            
            .clock-colon {
                font-size: 1.8rem;
                margin: 0 4px;
            }
        }

        @media print {
            body { background: white; color: black; }
            .container { background: white; box-shadow: none; }
            .btn, .theme-toggle, .patient-category-selector, .clock-container { display: none; }
            .no-print { display: none; }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="theme-toggle" onclick="toggleTheme()">
                <span id="theme-icon">ğŸŒ™</span>
                <span id="theme-text">å¤œé—´æ¨¡å¼</span>
            </div>
            <h1>å½±åƒå­¦æœ¯ç ”ç©¶è®¡ç®—å·¥å…·</h1>
            <div class="subtitle">CTAé€ å½±å‰‚ç”¨é‡è®¡ç®— + è¿‡æ•é£é™©è¯„ä¼° + å¤šä¸“ç§‘è¯„ä¼° v4.2</div>
            <div class="developer-info">
                ğŸ’» ç¨‹åºå¼€å‘è€…:å½±åƒæ¶›å“¥ 
            </div>
            
            <div class="clock-container">
                <div class="digits-container">
                    <div class="digit-group">
                        <div class="digit" id="hour-tens">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                        <div class="digit" id="hour-ones">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                    </div>
                    
                    <div class="clock-colon">:</div>
                    
                    <div class="digit-group">
                        <div class="digit" id="min-tens">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                        <div class="digit" id="min-ones">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                    </div>
                    
                    <div class="clock-colon">:</div>
                    
                    <div class="digit-group">
                        <div class="digit" id="sec-tens">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                        <div class="digit" id="sec-ones">
                            <div class="segment segment-a"></div>
                            <div class="segment segment-b"></div>
                            <div class="segment segment-c"></div>
                            <div class="segment segment-d"></div>
                            <div class="segment segment-e"></div>
                            <div class="segment segment-f"></div>
                            <div class="segment segment-g"></div>
                        </div>
                    </div>
                </div>
                <div class="clock-label">å½“å‰æ—¶é—´</div>
            </div>
        </div>
        
        <div class="patient-category-selector">
            <div class="category-title">é€‰æ‹©è¯„ä¼°ç±»å‹ - äº”å¤§ä¸“ä¸šè¯„ä¼°ç³»ç»Ÿ</div>
            <div class="category-grid">
                <div class="category-card normal" onclick="selectPatientType('normal')">
                    <div class="category-icon">ğŸ‘¤</div>
                    <div class="category-name">æ­£å¸¸æ‚£è€…</div>
                    <div class="category-description">
                        è‚¾åŠŸèƒ½æ­£å¸¸<br>
                        æ— ç‰¹æ®Šç”¨è¯å²<br>
                        æ ‡å‡†è®¡ç®—æµç¨‹
                    </div>
                </div>
                
                <div class="category-card renal" onclick="selectPatientType('renal')">
                    <div class="category-icon">ğŸ«˜</div>
                    <div class="category-name">è‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€…</div>
                    <div class="category-description">
                        è‚¾åŠŸèƒ½ä¸å…¨<br>
                        éœ€è¦eGFRè¯„ä¼°<br>
                        é€ å½±å‰‚ç”¨é‡è°ƒæ•´
                    </div>
                </div>
                
                <div class="category-card metformin" onclick="selectPatientType('metformin')">
                    <div class="category-icon">ğŸ’Š</div>
                    <div class="category-name">äºŒç”²åŒèƒç”¨è¯æ‚£è€…</div>
                    <div class="category-description">
                        æœç”¨äºŒç”²åŒèƒ<br>
                        éœ€è¦é£é™©è¯„ä¼°<br>
                        ç‰¹æ®Šå¤„ç†æ–¹æ¡ˆ
                    </div>
                </div>

                <div class="category-card heart" onclick="selectPatientType('heart')">
                    <div class="category-icon">â¤ï¸</div>
                    <div class="category-name">å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…</div>
                    <div class="category-description">
                        å¿ƒåŠŸèƒ½å¼‚å¸¸<br>
                        éœ€è¦NYHAåˆ†çº§è¯„ä¼°<br>
                        é€ å½±å‰‚ç”¨é‡é™åˆ¶
                    </div>
                </div>

                <div class="category-card allergy" onclick="selectPatientType('allergy')">
                    <div class="category-icon">âš ï¸</div>
                    <div class="category-name">è¿‡æ•é£é™©è¯„ä¼°</div>
                    <div class="category-description">
                        é€ å½±å‰‚è¿‡æ•é£é™©è¯„ä¼°<br>
                        2024ç‰ˆè¯„ä¼°æ ‡å‡†<br>
                        é¢„å¤„ç†æ–¹æ¡ˆæŒ‡å¯¼
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­£å¸¸æ‚£è€…è¡¨å• -->
        <div class="form-container" id="normalForm">
            <div class="form-section">
                <h2 class="section-title normal">
                    <span>ğŸ‘¤</span>
                    æ­£å¸¸æ‚£è€… - åŸºç¡€å‚æ•°è®¾ç½®
                </h2>
                <div class="info-box normal">
                    <strong>âœ… æ­£å¸¸æ‚£è€…è®¡ç®—æµç¨‹:</strong><br>
                    â€¢ è‚¾åŠŸèƒ½æ­£å¸¸,æ— éœ€eGFRè¯„ä¼°<br>
                    â€¢ æ— äºŒç”²åŒèƒç”¨è¯é£é™©<br>
                    â€¢ æŒ‰æ ‡å‡†å…¬å¼è®¡ç®—é€ å½±å‰‚ç”¨é‡<br>
                    â€¢ å®‰å…¨é™åˆ¶:å† è„‰CTA â‰¤60ml,èƒ¸ç—›ä¸‰è” â‰¤75ml
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="normalHeight">èº«é«˜ (cm) <span class="required">*</span></label>
                        <input type="number" id="normalHeight" placeholder="è¯·è¾“å…¥èº«é«˜,å¦‚:170" min="100" max="250" step="0.1" required>
                        <span class="real-time-validation" id="normalHeight-validation"></span>
                        <div class="input-hint">èŒƒå›´:100-250cm</div>
                        <div class="error-message" id="normalHeight-error">èº«é«˜å¿…é¡»åœ¨100-250cmä¹‹é—´</div>
                    </div>
                    <div class="form-group">
                        <label for="normalWeight">ä½“é‡ (kg) <span class="required">*</span></label>
                        <input type="number" id="normalWeight" placeholder="è¯·è¾“å…¥ä½“é‡,å¦‚:70" min="20" max="200" step="0.1" required>
                        <span class="real-time-validation" id="normalWeight-validation"></span>
                        <div class="input-hint">èŒƒå›´:20-200kg</div>
                        <div class="error-message" id="normalWeight-error">ä½“é‡å¿…é¡»åœ¨20-200kgä¹‹é—´</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="normalHeartRate">å¿ƒç‡å‚æ•°</label>
                        <select id="normalHeartRate">
                            <option value="80">â‰¤80 æ¬¡/åˆ†</option>
                            <option value="81">>80 æ¬¡/åˆ†</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="normalExamType">æ£€æŸ¥ç±»å‹</label>
                        <select id="normalExamType">
                            <option value="coronary">å† è„‰CTA</option>
                            <option value="triple">èƒ¸ç—›ä¸‰è”</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- è‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€…è¡¨å• -->
        <div class="form-container" id="renalForm">
            <div class="form-section">
                <h2 class="section-title renal">
                    <span>ğŸ«˜</span>
                    è‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€… - åŸºç¡€å‚æ•°è®¾ç½®
                </h2>
                <div class="info-box renal">
                    <strong>âš ï¸ è‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€…ç‰¹æ®Šå¤„ç†:</strong><br>
                    â€¢ éœ€è¦è¯„ä¼°eGFR(2021ç‰ˆCKD-EPIå…¬å¼)<br>
                    â€¢ æ ¹æ®è‚¾åŠŸèƒ½åˆ†çº§è°ƒæ•´é€ å½±å‰‚ç”¨é‡<br>
                    â€¢ eGFR <45 ml/min/1.73mÂ² æ—¶å‡é‡è‡³80%<br>
                    â€¢ å¿…é¡»è¿›è¡Œå……åˆ†æ°´åŒ–æ²»ç–—
                </div>

                <div class="info-box normal">
                    <strong>ğŸ“Š è‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€…åˆ†çº§æ ‡å‡†(åŸºäºeGFR):</strong><br>
                    <table class="grading-table">
                        <thead>
                            <tr>
                                <th>ç­‰çº§</th>
                                <th>eGFRèŒƒå›´<br>(ml/min/1.73mÂ²)</th>
                                <th>è‚¾åŠŸèƒ½çŠ¶æ€</th>
                                <th>å¤„ç†ç­–ç•¥</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="grade-level grade-low">ä¸€çº§</td>
                                <td>â‰¥ 60</td>
                                <td>æ­£å¸¸/è½»åº¦ä¸‹é™</td>
                                <td>æ ‡å‡†æµç¨‹</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-moderate">äºŒçº§</td>
                                <td>45-59</td>
                                <td>è½»ä¸­åº¦ä¸å…¨</td>
                                <td>åŠ å¼ºç›‘æµ‹</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-moderate">ä¸‰çº§</td>
                                <td>30-44</td>
                                <td>ä¸­é‡åº¦ä¸å…¨</td>
                                <td>å‡é‡è‡³80%</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-high">å››çº§</td>
                                <td>< 30</td>
                                <td>é‡åº¦ä¸å…¨</td>
                                <td>é¿å…æ£€æŸ¥</td>
                            </tr>
                        </tbody>
                    </table>
                    <strong>è¯„ä¼°æµç¨‹:</strong>è¡€è‚Œé… â†’ 2021 CKD-EPI â†’ eGFRåˆ†çº§ â†’ é€ å½±å‰‚è°ƒæ•´
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="renalHeight">èº«é«˜ (cm) <span class="required">*</span></label>
                        <input type="number" id="renalHeight" placeholder="è¯·è¾“å…¥èº«é«˜,å¦‚:170" min="100" max="250" step="0.1" required>
                        <span class="real-time-validation" id="renalHeight-validation"></span>
                        <div class="input-hint">èŒƒå›´:100-250cm</div>
                        <div class="error-message" id="renalHeight-error">èº«é«˜å¿…é¡»åœ¨100-250cmä¹‹é—´</div>
                    </div>
                    <div class="form-group">
                        <label for="renalWeight">ä½“é‡ (kg) <span class="required">*</span></label>
                        <input type="number" id="renalWeight" placeholder="è¯·è¾“å…¥ä½“é‡,å¦‚:70" min="20" max="200" step="0.1" required>
                        <span class="real-time-validation" id="renalWeight-validation"></span>
                        <div class="input-hint">èŒƒå›´:20-200kg</div>
                        <div class="error-message" id="renalWeight-error">ä½“é‡å¿…é¡»åœ¨20-200kgä¹‹é—´</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="renalCreatinine">è¡€è‚Œé…å€¼ (Î¼mol/L) <span class="required">*</span></label>
                        <input type="number" id="renalCreatinine" placeholder="è¯·è¾“å…¥è¡€è‚Œé…å€¼,å¦‚:120" min="30" max="500" step="1" required>
                        <span class="real-time-validation" id="renalCreatinine-validation"></span>
                        <div class="input-hint">èŒƒå›´:30-500 Î¼mol/L,ç”¨äºè®¡ç®—eGFR</div>
                        <div class="error-message" id="renalCreatinine-error">è¡€è‚Œé…å€¼å¿…é¡»åœ¨30-500 Î¼mol/Lä¹‹é—´</div>
                        <div class="formula-display" id="renalFormulaDisplay" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="renalAge">å¹´é¾„ (å²) <span class="required">*</span></label>
                        <input type="number" id="renalAge" placeholder="è¯·è¾“å…¥å¹´é¾„,å¦‚:65" min="18" max="120" step="1" required>
                        <span class="real-time-validation" id="renalAge-validation"></span>
                        <div class="input-hint">èŒƒå›´:18-120å²</div>
                        <div class="error-message" id="renalAge-error">å¹´é¾„å¿…é¡»åœ¨18-120å²ä¹‹é—´</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="renalGender">æ€§åˆ« <span class="required">*</span></label>
                        <select id="renalGender" onchange="updateRenalFormulaDisplay()">
                            <option value="male">ç”·æ€§</option>
                            <option value="female">å¥³æ€§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="renalHeartRate">å¿ƒç‡å‚æ•°</label>
                        <select id="renalHeartRate">
                            <option value="80">â‰¤80 æ¬¡/åˆ†</option>
                            <option value="81">>80 æ¬¡/åˆ†</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="renalExamType">æ£€æŸ¥ç±»å‹</label>
                        <select id="renalExamType">
                            <option value="coronary">å† è„‰CTA</option>
                            <option value="triple">èƒ¸ç—›ä¸‰è”</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- äºŒç”²åŒèƒæ‚£è€…è¡¨å• -->
        <div class="form-container" id="metforminForm">
            <div class="form-section">
                <h2 class="section-title metformin">
                    <span>ğŸ’Š</span>
                    äºŒç”²åŒèƒç”¨è¯æ‚£è€… - åŸºç¡€å‚æ•°è®¾ç½®
                </h2>
                <div class="info-box metformin">
                    <strong>ğŸš¨ äºŒç”²åŒèƒæ‚£è€…é£é™©æç¤º:</strong><br>
                    â€¢ é€ å½±å‰‚å¯èƒ½å¢åŠ ä¹³é…¸é…¸ä¸­æ¯’é£é™©<br>
                    â€¢ éœ€è¦è¯¦ç»†è¯„ä¼°è‚¾åŠŸèƒ½(eGFR)<br>
                    â€¢ é€ å½±å‰å48-72å°æ—¶æš‚åœç”¨è¯<br>
                    â€¢ å¿…è¦æ—¶å†…åˆ†æ³Œç§‘ä¼šè¯Š
                </div>

                <div class="info-box normal">
                    <strong>ğŸ’Š äºŒç”²åŒèƒæ‚£è€…é£é™©åˆ†ç»„æ ‡å‡†:</strong><br>
                    <table class="grading-table">
                        <thead>
                            <tr>
                                <th>é£é™©ç»„</th>
                                <th>è¯„åˆ†æ ‡å‡†</th>
                                <th>è¯„ä¼°è¦ç´ </th>
                                <th>ä¸´åºŠå¤„ç†</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="grade-level grade-low">ä½é£é™©ç»„</td>
                                <td>1.0-2.0åˆ†</td>
                                <td>eGFRâ‰¥60 + å¹´é¾„<65 + å‰‚é‡<1500mg</td>
                                <td>æ ‡å‡†å¤„ç†</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-moderate">ä¸­é£é™©ç»„</td>
                                <td>2.5-3.5åˆ†</td>
                                <td>eGFR 45-59 + å¹´é¾„65-75 + å‰‚é‡é€‚ä¸­</td>
                                <td>è°¨æ…ç›‘æµ‹</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-high">é«˜é£é™©ç»„</td>
                                <td>4.0-5.5åˆ†</td>
                                <td>eGFR 30-44 + å¹´é¾„>75 + å‰‚é‡â‰¥1500mg</td>
                                <td>é«˜é£é™©å¤„ç†</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-very-high">æé«˜é£é™©ç»„</td>
                                <td>â‰¥6.0åˆ†</td>
                                <td>eGFR<30 + é«˜é¾„ + é«˜å‰‚é‡</td>
                                <td>é¿å…æ£€æŸ¥</td>
                            </tr>
                        </tbody>
                    </table>
                    <strong>è¯„åˆ†ç»†åˆ™:</strong>eGFR(â‰¥60=1åˆ†,45-59=2åˆ†,30-44=3åˆ†,<30=4åˆ†) + å¹´é¾„(65-74=0.5åˆ†,â‰¥75=1åˆ†) + å‰‚é‡(1500-1999mg=0.5åˆ†,â‰¥2000mg=1åˆ†)<br>
                    <strong>è¯„ä¼°è¦ç´ :</strong>è‚¾åŠŸèƒ½ + å¹´é¾„ + å‰‚é‡ â†’ ä¹³é…¸é…¸ä¸­æ¯’é£é™©è¯„ä¼°
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="metforminHeight">èº«é«˜ (cm) <span class="required">*</span></label>
                        <input type="number" id="metforminHeight" placeholder="è¯·è¾“å…¥èº«é«˜,å¦‚:170" min="100" max="250" step="0.1" required>
                        <span class="real-time-validation" id="metforminHeight-validation"></span>
                        <div class="input-hint">èŒƒå›´:100-250cm</div>
                        <div class="error-message" id="metforminHeight-error">èº«é«˜å¿…é¡»åœ¨100-250cmä¹‹é—´</div>
                    </div>
                    <div class="form-group">
                        <label for="metforminWeight">ä½“é‡ (kg) <span class="required">*</span></label>
                        <input type="number" id="metforminWeight" placeholder="è¯·è¾“å…¥ä½“é‡,å¦‚:70" min="20" max="200" step="0.1" required>
                        <span class="real-time-validation" id="metforminWeight-validation"></span>
                        <div class="input-hint">èŒƒå›´:20-200kg</div>
                        <div class="error-message" id="metforminWeight-error">ä½“é‡å¿…é¡»åœ¨20-200kgä¹‹é—´</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="metforminCreatinine">è¡€è‚Œé…å€¼ (Î¼mol/L) <span class="required">*</span></label>
                        <input type="number" id="metforminCreatinine" placeholder="è¯·è¾“å…¥è¡€è‚Œé…å€¼,å¦‚:80" min="30" max="500" step="1" required>
                        <span class="real-time-validation" id="metforminCreatinine-validation"></span>
                        <div class="input-hint">èŒƒå›´:30-500 Î¼mol/L,ç”¨äºé£é™©è¯„ä¼°</div>
                        <div class="error-message" id="metforminCreatinine-error">è¡€è‚Œé…å€¼å¿…é¡»åœ¨30-500 Î¼mol/Lä¹‹é—´</div>
                        <div class="formula-display" id="metforminFormulaDisplay" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="metforminAge">å¹´é¾„ (å²) <span class="required">*</span></label>
                        <input type="number" id="metforminAge" placeholder="è¯·è¾“å…¥å¹´é¾„,å¦‚:60" min="18" max="120" step="1" required>
                        <span class="real-time-validation" id="metforminAge-validation"></span>
                        <div class="input-hint">èŒƒå›´:18-120å²</div>
                        <div class="error-message" id="metforminAge-error">å¹´é¾„å¿…é¡»åœ¨18-120å²ä¹‹é—´</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="metforminGender">æ€§åˆ« <span class="required">*</span></label>
                        <select id="metforminGender" onchange="updateMetforminFormulaDisplay()">
                            <option value="male">ç”·æ€§</option>
                            <option value="female">å¥³æ€§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="metforminDose">äºŒç”²åŒèƒå‰‚é‡(mg/æ—¥)</label>
                        <select id="metforminDose">
                            <option value="500">500mg/æ—¥</option>
                            <option value="850">850mg/æ—¥</option>
                            <option value="1000">1000mg/æ—¥</option>
                            <option value="1500">1500mg/æ—¥</option>
                            <option value="2000">2000mg/æ—¥</option>
                            <option value="other">å…¶ä»–å‰‚é‡</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="metforminHeartRate">å¿ƒç‡å‚æ•°</label>
                        <select id="metforminHeartRate">
                            <option value="80">â‰¤80 æ¬¡/åˆ†</option>
                            <option value="81">>80 æ¬¡/åˆ†</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="metforminExamType">æ£€æŸ¥ç±»å‹</label>
                        <select id="metforminExamType">
                            <option value="coronary">å† è„‰CTA</option>
                            <option value="triple">èƒ¸ç—›ä¸‰è”</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…è¡¨å• -->
        <div class="form-container" id="heartForm">
            <div class="form-section">
                <h2 class="section-title heart">
                    <span>â¤ï¸</span>
                    å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€… - åŸºç¡€å‚æ•°è®¾ç½®
                </h2>
                <div class="info-box heart">
                    <strong>ğŸ’™ å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…ç‰¹æ®Šå¤„ç†:</strong><br>
                    â€¢ éœ€è¦è¯„ä¼°NYHAå¿ƒåŠŸèƒ½åˆ†çº§<br>
                    â€¢ æ ¹æ®å°„è¡€åˆ†æ•°(EF)è°ƒæ•´é€ å½±å‰‚ç”¨é‡<br>
                    â€¢ ä¸¥æ ¼æ§åˆ¶é€ å½±å‰‚æ€»é‡,é¿å…å®¹é‡è´Ÿè·è¿‡é‡<br>
                    â€¢ ç›‘æµ‹BNP/NT-proBNPæ°´å¹³<br>
                    â€¢ <strong>æ–°å¢:å¦‚æä¾›è‚Œé…å€¼,å°†è¯„ä¼°å¿ƒè‚¾ç»¼åˆå¾é£é™©</strong>
                </div>

                <div class="info-box normal">
                    <strong>â¤ï¸ å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…é£é™©åˆ†çº§æ ‡å‡†:</strong><br>
                    <table class="grading-table">
                        <thead>
                            <tr>
                                <th>é£é™©ç­‰çº§</th>
                                <th>NYHAåˆ†çº§</th>
                                <th>EFå€¼èŒƒå›´</th>
                                <th>å¤„ç†ç­–ç•¥</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="grade-level grade-low">ä½é£é™©</td>
                                <td>NYHA Içº§</td>
                                <td>EF â‰¥ 50%</td>
                                <td>æ ‡å‡†æµç¨‹</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-moderate">ä¸­é£é™©</td>
                                <td>NYHA IIçº§</td>
                                <td>EF 40-49%</td>
                                <td>ä¸­åº¦ç›‘æµ‹</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-high">é«˜é£é™©</td>
                                <td>NYHA IIIçº§</td>
                                <td>EF 30-39%</td>
                                <td>é«˜é£é™©å¤„ç†</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-very-high">æé«˜é£é™©</td>
                                <td>NYHA IVçº§</td>
                                <td>EF < 30%</td>
                                <td>æ…é‡è€ƒè™‘</td>
                            </tr>
                        </tbody>
                    </table>
                    <strong>è¯„ä¼°è¦ç´ :</strong>NYHAåˆ†çº§ + å°„è¡€åˆ†æ•° + BNP + <strong>è‚¾åŠŸèƒ½</strong> â†’ å®¹é‡è´Ÿè·é£é™©è¯„ä¼°
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="heartHeight">èº«é«˜ (cm) <span class="required">*</span></label>
                        <input type="number" id="heartHeight" placeholder="è¯·è¾“å…¥èº«é«˜,å¦‚:170" min="100" max="250" step="0.1" required>
                        <span class="real-time-validation" id="heartHeight-validation"></span>
                        <div class="input-hint">èŒƒå›´:100-250cm</div>
                        <div class="error-message" id="heartHeight-error">èº«é«˜å¿…é¡»åœ¨100-250cmä¹‹é—´</div>
                    </div>
                    <div class="form-group">
                        <label for="heartWeight">ä½“é‡ (kg) <span class="required">*</span></label>
                        <input type="number" id="heartWeight" placeholder="è¯·è¾“å…¥ä½“é‡,å¦‚:70" min="20" max="200" step="0.1" required>
                        <span class="real-time-validation" id="heartWeight-validation"></span>
                        <div class="input-hint">èŒƒå›´:20-200kg</div>
                        <div class="error-message" id="heartWeight-error">ä½“é‡å¿…é¡»åœ¨20-200kgä¹‹é—´</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="heartNYHA">NYHAå¿ƒåŠŸèƒ½åˆ†çº§ <span class="required">*</span></label>
                        <select id="heartNYHA">
                            <option value="1">Içº§ - æ´»åŠ¨ä¸å—é™åˆ¶</option>
                            <option value="2">IIçº§ - è½»åº¦æ´»åŠ¨å—é™</option>
                            <option value="3">IIIçº§ - æ˜æ˜¾æ´»åŠ¨å—é™</option>
                            <option value="4">IVçº§ - ä¼‘æ¯æ—¶ä¹Ÿæœ‰ç—‡çŠ¶</option>
                        </select>
                        <div class="input-hint">è¯·é€‰æ‹©æ‚£è€…çš„NYHAå¿ƒåŠŸèƒ½åˆ†çº§</div>
                    </div>
                    <div class="form-group">
                        <label for="heartEF">å·¦å®¤å°„è¡€åˆ†æ•°(EF) % <span class="required">*</span></label>
                        <input type="number" id="heartEF" placeholder="è¯·è¾“å…¥EFå€¼,å¦‚:45" min="10" max="80" step="1" required>
                        <span class="real-time-validation" id="heartEF-validation"></span>
                        <div class="input-hint">èŒƒå›´:10-80%</div>
                        <div class="error-message" id="heartEF-error">EFå€¼å¿…é¡»åœ¨10-80%ä¹‹é—´</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="heartBNP">BNP/NT-proBNPæ°´å¹³</label>
                        <select id="heartBNP">
                            <option value="normal">æ­£å¸¸èŒƒå›´</option>
                            <option value="mild">è½»åº¦å‡é«˜(1-2å€)</option>
                            <option value="moderate">ä¸­åº¦å‡é«˜(2-5å€)</option>
                            <option value="severe">é‡åº¦å‡é«˜(>5å€)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="heartCreatinine">è¡€è‚Œé…å€¼ (Î¼mol/L) - å¯é€‰</label>
                        <input type="number" id="heartCreatinine" placeholder="å¦‚æœ‰æ•°æ®è¯·è¾“å…¥" min="30" max="500" step="1">
                        <span class="real-time-validation" id="heartCreatinine-validation"></span>
                        <div class="input-hint">å¯é€‰å¡«,ç”¨äºè¯„ä¼°å¿ƒè‚¾ç»¼åˆå¾åŠè°ƒæ•´é€ å½±å‰‚</div>
                        <div class="error-message" id="heartCreatinine-error">è¡€è‚Œé…å€¼å¿…é¡»åœ¨30-500 Î¼mol/Lä¹‹é—´</div>
                        <div class="formula-display" id="heartFormulaDisplay" style="display: none;"></div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="heartAge">å¹´é¾„ (å²) - ç”¨äºeGFRè®¡ç®—</label>
                        <input type="number" id="heartAge" placeholder="å¦‚æœ‰è‚Œé…å€¼éœ€å¡«å†™" min="18" max="120" step="1">
                        <span class="real-time-validation" id="heartAge-validation"></span>
                        <div class="input-hint">ä¸è‚Œé…å€¼é…åˆè®¡ç®—eGFR</div>
                        <div class="error-message" id="heartAge-error">å¹´é¾„å¿…é¡»åœ¨18-120å²ä¹‹é—´</div>
                    </div>
                    <div class="form-group">
                        <label for="heartGender">æ€§åˆ« - ç”¨äºeGFRè®¡ç®—</label>
                        <select id="heartGender" onchange="updateHeartFormulaDisplay()">
                            <option value="male">ç”·æ€§</option>
                            <option value="female">å¥³æ€§</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="heartRate">å¿ƒç‡å‚æ•°</label>
                        <select id="heartRate">
                            <option value="80">â‰¤80 æ¬¡/åˆ†</option>
                            <option value="81">>80 æ¬¡/åˆ†</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="heartExamType">æ£€æŸ¥ç±»å‹</label>
                        <select id="heartExamType">
                            <option value="coronary">å† è„‰CTA</option>
                            <option value="triple">èƒ¸ç—›ä¸‰è”</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¿‡æ•é£é™©è¯„ä¼°è¡¨å• -->
        <div class="form-container" id="allergyForm">
            <div class="form-section">
                <h2 class="section-title allergy">
                    <span>âš ï¸</span>
                    é€ å½±å‰‚è¿‡æ•é£é™©è¯„ä¼° - 2024ç‰ˆæ ‡å‡†
                </h2>
                <div class="info-box allergy">
                    <strong>ğŸ”¬ 2024ç‰ˆé€ å½±å‰‚è¿‡æ•é£é™©è¯„ä¼°ç³»ç»Ÿ:</strong><br>
                    â€¢ åŸºäºå¤šå› ç´ è¯„åˆ†æ¨¡å‹è¿›è¡Œé£é™©åˆ†å±‚<br>
                    â€¢ ä¸»è¦é£é™©å› ç´ (3åˆ†)ã€æ¬¡è¦é£é™©å› ç´ (2åˆ†)ã€è½»å¾®é£é™©å› ç´ (1åˆ†)<br>
                    â€¢ æ€»åˆ†â‰¥6åˆ†ä¸ºæé«˜é£é™©,4-5åˆ†ä¸ºé«˜é£é™©,2-3åˆ†ä¸ºä¸­ç­‰é£é™©<br>
                    â€¢ æä¾›ä¸ªæ€§åŒ–é¢„å¤„ç†æ–¹æ¡ˆå’Œç›‘æŠ¤å»ºè®®
                </div>

                <div class="info-box normal">
                    <strong>ğŸ“Š é£é™©è¯„ä¼°åˆ†çº§æ ‡å‡†:</strong><br>
                    <table class="grading-table">
                        <thead>
                            <tr>
                                <th>é£é™©ç­‰çº§</th>
                                <th>æ€»åˆ†èŒƒå›´</th>
                                <th>ååº”å‘ç”Ÿç‡</th>
                                <th>å¤„ç†ç­–ç•¥</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="grade-level grade-minimal">æ— æ˜æ˜¾é£é™©</td>
                                <td>0åˆ†</td>
                                <td>0.1-0.5%</td>
                                <td>æ ‡å‡†ç›‘æµ‹</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-low">ä½é£é™©</td>
                                <td>1åˆ†</td>
                                <td>1-2%</td>
                                <td>è€ƒè™‘é¢„å¤„ç†</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-moderate">ä¸­ç­‰é£é™©</td>
                                <td>2-3åˆ†</td>
                                <td>2-5%</td>
                                <td>æ ‡å‡†é¢„å¤„ç†</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-high">é«˜é£é™©</td>
                                <td>4-5åˆ†</td>
                                <td>5-10%</td>
                                <td>å¼ºåŒ–é¢„å¤„ç†</td>
                            </tr>
                            <tr>
                                <td class="grade-level grade-very-high">æé«˜é£é™©</td>
                                <td>â‰¥6åˆ†</td>
                                <td>10-30%</td>
                                <td>é¿å…ä½¿ç”¨</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- A. é€ å½±å‰‚ä½¿ç”¨å²è¯„ä¼° -->
                <div class="form-section">
                    <h3 style="color: var(--allergy-color); margin-bottom: 15px;">A. é€ å½±å‰‚ä½¿ç”¨å²è¯„ä¼°</h3>
                    
                    <div class="form-group">
                        <label>1. æ˜¯å¦æ›¾ç»ä½¿ç”¨è¿‡é€ å½±å‰‚? <span class="required">*</span></label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="radio" name="previousContrast" value="no" id="prevContrast-no">
                                <label for="prevContrast-no">å¦,ä»æœªä½¿ç”¨è¿‡</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="radio" name="previousContrast" value="yes" id="prevContrast-yes">
                                <label for="prevContrast-yes">æ˜¯,æ›¾ç»ä½¿ç”¨è¿‡</label>
                            </div>
                        </div>
                    </div>

                    <div id="contrastHistoryDetails" style="display: none;">
                        <div class="form-group">
                            <label>2. ä¸Šæ¬¡ä½¿ç”¨é€ å½±å‰‚æ—¶çš„ååº”æƒ…å†µ? <span class="required">*</span></label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="radio" name="previousReaction" value="none" id="reaction-none">
                                    <label for="reaction-none">æ— ä»»ä½•ååº”</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="previousReaction" value="mild" id="reaction-mild">
                                    <label for="reaction-mild">è½»å¾®ååº”(+1åˆ†)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="previousReaction" value="moderate" id="reaction-moderate">
                                    <label for="reaction-moderate">ä¸­åº¦ååº”(+3åˆ†)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="previousReaction" value="severe" id="reaction-severe">
                                    <label for="reaction-severe">ä¸¥é‡ååº”(+3åˆ†)</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>3. å…·ä½“ååº”ç—‡çŠ¶(å¯å¤šé€‰):</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-rash">
                                    <label for="symptom-rash">çš®ç–¹/è¨éº»ç–¹</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-itch">
                                    <label for="symptom-itch">å…¨èº«ç˜™ç—’</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-nausea">
                                    <label for="symptom-nausea">æ¶å¿ƒå‘•å</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-dizzy">
                                    <label for="symptom-dizzy">å¤´æ™•å¤´ç—›</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-dyspnea">
                                    <label for="symptom-dyspnea">å‘¼å¸å›°éš¾</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-edema">
                                    <label for="symptom-edema">å–‰å¤´æ°´è‚¿</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-hypotension">
                                    <label for="symptom-hypotension">è¡€å‹ä¸‹é™</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="symptom-consciousness">
                                    <label for="symptom-consciousness">æ„è¯†æ”¹å˜</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- B. è¿‡æ•å²è¯„ä¼° -->
                <div class="form-section">
                    <h3 style="color: var(--allergy-color); margin-bottom: 15px;">B. è¿‡æ•å²è¯„ä¼°</h3>
                    
                    <div class="form-group">
                        <label>1. è¯ç‰©è¿‡æ•å²(å¯å¤šé€‰):</label>
                        <div class="checkbox-group" id="drugAllergyGroup">
                            <div class="checkbox-item">
                                <input type="checkbox" id="drug-none" data-group="drug">
                                <label for="drug-none">æ— è¯ç‰©è¿‡æ•å²</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="drug-penicillin" data-group="drug">
                                <label for="drug-penicillin">é’éœ‰ç´ ç±»</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="drug-cephalosporin" data-group="drug">
                                <label for="drug-cephalosporin">å¤´å­¢ç±»</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="drug-sulfa" data-group="drug">
                                <label for="drug-sulfa">ç£ºèƒºç±»</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="drug-aspirin" data-group="drug">
                                <label for="drug-aspirin">é˜¿å¸åŒ¹æ—</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="drug-multiple" data-group="drug">
                                <label for="drug-multiple">â‰¥3ç§ä¸ç›¸å…³è¯ç‰©(+2åˆ†)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="drug-severe-allergy" data-group="drug">
                                <label for="drug-severe-allergy">ä¸¥é‡è¿‡æ•ååº”å²(+3åˆ†)</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>2. é£Ÿç‰©è¿‡æ•å²(å¯å¤šé€‰):</label>
                        <div class="checkbox-group" id="foodAllergyGroup">
                            <div class="checkbox-item">
                                <input type="checkbox" id="food-none" data-group="food">
                                <label for="food-none">æ— é£Ÿç‰©è¿‡æ•å²</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="food-seafood" data-group="food">
                                <label for="food-seafood">æµ·é²œç±»(+1åˆ†)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="food-nuts" data-group="food">
                                <label for="food-nuts">åšæœç±»(+1åˆ†)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="food-milk" data-group="food">
                                <label for="food-milk">ç‰›å¥¶è›‹ç™½</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="food-egg" data-group="food">
                                <label for="food-egg">é¸¡è›‹</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="food-others" data-group="food">
                                <label for="food-others">å…¶ä»–é£Ÿç‰©</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>3. å“®å–˜è¯„ä¼°:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="radio" name="asthma" value="none" id="asthma-none">
                                <label for="asthma-none">æ— å“®å–˜ç—…å²</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="radio" name="asthma" value="mild" id="asthma-mild">
                                <label for="asthma-mild">è½»åº¦å“®å–˜(+1åˆ†)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="radio" name="asthma" value="severe" id="asthma-severe">
                                <label for="asthma-severe">é‡åº¦å“®å–˜(+2åˆ†)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="radio" name="asthma" value="allergic" id="asthma-allergic">
                                <label for="asthma-allergic">å“®å–˜ä¼´è¿‡æ•å²(+3åˆ†)</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>4. å…¶ä»–è¿‡æ•æ€§ç–¾ç—…(å¯å¤šé€‰):</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="other-rhinitis">
                                <label for="other-rhinitis">è¿‡æ•æ€§é¼»ç‚(+1åˆ†)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="other-eczema">
                                <label for="other-eczema">æ¹¿ç–¹/ç‰¹åº”æ€§çš®ç‚(+1åˆ†)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="other-urticaria">
                                <label for="other-urticaria">æ…¢æ€§è¨éº»ç–¹</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="other-contact">
                                <label for="other-contact">æ¥è§¦æ€§çš®ç‚</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- C. ç‰¹æ®Šæƒ…å†µè¯„ä¼° -->
                <div class="form-section">
                    <h3 style="color: var(--allergy-color); margin-bottom: 15px;">C. ç‰¹æ®Šæƒ…å†µè¯„ä¼°</h3>
                    
                    <div class="form-group">
                        <label>1. ç‰¹æ®Šç–¾ç—…å²(å¯å¤šé€‰):</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="special-mastocytosis">
                                <label for="special-mastocytosis">è‚¥å¤§ç»†èƒå¢å¤šç—‡(+2åˆ†)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="special-heart">
                                <label for="special-heart">ä¸¥é‡å¿ƒè„ç—…</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="special-thyroid">
                                <label for="special-thyroid">ç”²çŠ¶è…ºåŠŸèƒ½äº¢è¿›</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>2. å½“å‰ç”¨è¯æƒ…å†µ(å¯å¤šé€‰):</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="med-beta-blocker">
                                <label for="med-beta-blocker">Î²å—ä½“é˜»æ»å‰‚</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="med-ace">
                                <label for="med-ace">ACEæŠ‘åˆ¶å‰‚</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="med-metformin">
                                <label for="med-metformin">äºŒç”²åŒèƒ</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="med-antihistamine">
                                <label for="med-antihistamine">æŠ—ç»„èƒºè¯ç‰©</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="risk-score-display" id="allergyRiskScore" style="display: none;">
                    <div class="score-value" id="riskScoreValue">0</div>
                    <div id="riskLevelText">é£é™©ç­‰çº§è¯„ä¼°ä¸­...</div>
                </div>
            </div>
        </div>

        <div class="form-container show" id="actionForm">
            <div class="form-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress"></div>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="calculate()" id="calculateBtn" disabled>
                        <span>ğŸ§®</span> å¼€å§‹è¯„ä¼°è®¡ç®—
                    </button>
                    <button class="btn btn-secondary" onclick="exportToPDF()" id="pdfBtn" disabled>
                        <span>ğŸ“„</span> å¯¼å‡ºè¯„ä¼°æŠ¥å‘Š
                    </button>
                    <button class="btn btn-secondary" onclick="resetForm()" id="resetBtn">
                        <span>ğŸ”„</span> é‡æ–°é€‰æ‹©
                    </button>
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <h2 class="section-title">
                <span>ğŸ“Š</span>
                è¯„ä¼°ç»“æœ
            </h2>
            <div id="calculationResults"></div>
        </div>

        <div class="disclaimer">
            <h3>âš ï¸ é‡è¦ä½¿ç”¨å£°æ˜</h3>
            <p><span class="highlight">ä¸“ä¸šèƒŒæ™¯è¦æ±‚:</span>ä½¿ç”¨è€…é¡»æ˜¯åœ¨åŒ»å­¦å½±åƒç§‘å·¥ä½œçš„ä¸“ä¸šäººå‘˜,ç†Ÿæ‚‰CTæ£€æŸ¥æµç¨‹å’Œé€ å½±å‰‚ä½¿ç”¨è§„èŒƒã€‚</p>
            <p><span class="highlight">è®¾å¤‡ä¾æ®:</span>æœ¬å·¥å…·è®¡ç®—å…¬å¼åŸºäºè”å½±CT960+è®¾å¤‡çš„æŠ€æœ¯å‚æ•°å’Œä¸´åºŠç ”ç©¶æ•°æ®ã€‚</p>
            <p><span class="highlight">å­¦æœ¯ç”¨é€”:</span>ä»…ä¾›å½±åƒæŠ€æœ¯æ•™å­¦ã€å­¦æœ¯ç ”ç©¶ä½¿ç”¨,ä¸¥ç¦ç”¨äºä¸´åºŠè¯Šæ–­æˆ–æ²»ç–—å†³ç­–ã€‚</p>
            <p><span class="highlight">äº”å¤§è¯„ä¼°ç³»ç»Ÿ:</span>æ­£å¸¸æ‚£è€…æ ‡å‡†è®¡ç®—ã€è‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€…eGFRè¯„ä¼°ã€äºŒç”²åŒèƒæ‚£è€…é£é™©è¯„ä¼°ã€å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…NYHAåˆ†çº§è¯„ä¼°ã€é€ å½±å‰‚è¿‡æ•é£é™©è¯„ä¼°ã€‚</p>
            <p><span class="highlight">è¿‡æ•è¯„ä¼°ç³»ç»Ÿ:</span>åŸºäº2024ç‰ˆå›½é™…æŒ‡å—,ä½†ä¸èƒ½100%é¢„æµ‹è¿‡æ•ååº”,ä¸´åºŠä½¿ç”¨æ—¶å¿…é¡»é…å¤‡å®Œå–„çš„æŠ¢æ•‘æªæ–½ã€‚</p>
            <p><span class="highlight">eGFRè®¡ç®—:</span>é‡‡ç”¨2021ç‰ˆCKD-EPIå…¬å¼(æ— ç§æ—ç³»æ•°),é€‚ç”¨äºä¸­å›½äººç¾¤ã€‚</p>
            <p><span class="highlight">å®‰å…¨é™åˆ¶:</span>ç¨‹åºå·²è®¾ç½®é€ å½±å‰‚ç”¨é‡å’Œæ³¨å°„æµé€Ÿçš„å®‰å…¨ä¸Šé™,ä½†å®é™…ä½¿ç”¨éœ€ç»“åˆæ‚£è€…å…·ä½“æƒ…å†µå……åˆ†è¯„ä¼°ã€‚</p>
            <p><span class="highlight">v4.2æ··åˆç‰ˆæ›´æ–°:</span>å‰å››ç±»æ‚£è€…ä½¿ç”¨è¯¦ç»†PDFæ ¼å¼,è¿‡æ•è¯„ä¼°ä½¿ç”¨ä¸“é—¨PDFæ ¼å¼,ä¼˜åŒ–ç”¨æˆ·ä½“éªŒã€‚</p>
            <p style="margin-top: 15px; font-weight: 700; color: #b45309; border-top: 1px solid #fed7aa; padding-top: 15px;">
                å¼€å‘è€…ä¸æ‰¿æ‹…ä»»ä½•ç›´æ¥æˆ–é—´æ¥çš„æ³•å¾‹è´£ä»»;ä½¿ç”¨å³è¡¨ç¤ºåŒæ„æœ¬å£°æ˜ã€‚ç¨‹åºä½¿ç”¨è¿‡ç¨‹ä¸­å¦‚é‡åˆ°é—®é¢˜åŠåé¦ˆ,è¯·è”ç³»é‚®ç®±:lucky@taothink.com
            </p>
        </div>
    </div>

    <script>
        const digitConfig = {
            '0': [1, 1, 1, 1, 1, 1, 0],
            '1': [0, 1, 1, 0, 0, 0, 0],
            '2': [1, 1, 0, 1, 1, 0, 1],
            '3': [1, 1, 1, 1, 0, 0, 1],
            '4': [0, 1, 1, 0, 0, 1, 1],
            '5': [1, 0, 1, 1, 0, 1, 1],
            '6': [1, 0, 1, 1, 1, 1, 1],
            '7': [1, 1, 1, 0, 0, 0, 0],
            '8': [1, 1, 1, 1, 1, 1, 1],
            '9': [1, 1, 1, 1, 0, 1, 1]
        };

        const appState = {
            isDarkMode: false,
            currentPatientType: null,
            currentResults: null,
            allergyRiskScore: 0
        };

        function updateClock() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            const hoursStr = hours.toString().padStart(2, '0');
            const minutesStr = minutes.toString().padStart(2, '0');
            const secondsStr = seconds.toString().padStart(2, '0');

            displayDigit(document.getElementById('hour-tens'), hoursStr[0]);
            displayDigit(document.getElementById('hour-ones'), hoursStr[1]);
            displayDigit(document.getElementById('min-tens'), minutesStr[0]);
            displayDigit(document.getElementById('min-ones'), minutesStr[1]);
            displayDigit(document.getElementById('sec-tens'), secondsStr[0]);
            displayDigit(document.getElementById('sec-ones'), secondsStr[1]);
        }

        function displayDigit(digitElement, number) {
            if (!digitElement) return;
            
            const segments = digitElement.querySelectorAll('.segment');
            const config = digitConfig[number] || digitConfig['0'];

            segments.forEach((segment, index) => {
                segment.classList.remove('active');
                if (config[index] === 1) {
                    segment.classList.add('active');
                }
            });
        }

        function toggleTheme() {
            try {
                appState.isDarkMode = !appState.isDarkMode;
                const body = document.body;
                const themeIcon = document.getElementById('theme-icon');
                const themeText = document.getElementById('theme-text');
                
                if (appState.isDarkMode) {
                    body.setAttribute('data-theme', 'dark');
                    if (themeIcon) themeIcon.textContent = 'â˜€ï¸';
                    if (themeText) themeText.textContent = 'æ—¥é—´æ¨¡å¼';
                } else {
                    body.removeAttribute('data-theme');
                    if (themeIcon) themeIcon.textContent = 'ğŸŒ™';
                    if (themeText) themeText.textContent = 'å¤œé—´æ¨¡å¼';
                }
                
                setTimeout(updateClock, 100);
                
            } catch (error) {
                console.error('ä¸»é¢˜åˆ‡æ¢å‡ºé”™:', error);
                showNotification('âš ï¸ ä¸»é¢˜åˆ‡æ¢å¤±è´¥', 'warning');
            }
        }

        function selectPatientType(type) {
            appState.currentPatientType = type;
            
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`.category-card.${type}`).classList.add('active');
            
            document.querySelectorAll('.form-container').forEach(form => {
                if (form.id !== 'actionForm') {
                    form.classList.remove('show');
                }
            });
            
            const targetForm = document.getElementById(`${type}Form`);
            if (targetForm) {
                targetForm.classList.add('show');
            }
            
            const results = document.getElementById('results');
            results.classList.remove('show');
            appState.currentResults = null;
            
            updateProgress();
            
            setTimeout(() => {
                targetForm.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function resetForm() {
            appState.currentPatientType = null;
            appState.allergyRiskScore = 0;
            
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('active');
            });
            
            document.querySelectorAll('.form-container').forEach(form => {
                if (form.id !== 'actionForm') {
                    form.classList.remove('show');
                }
            });
            
            document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
                input.value = '';
                input.classList.remove('input-error');
            });
            
            document.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
                input.checked = false;
            });
            
            document.querySelectorAll('.real-time-validation').forEach(el => {
                el.textContent = '';
            });
            
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            
            document.querySelectorAll('.formula-display').forEach(el => {
                el.style.display = 'none';
            });
            
            const historyDetails = document.getElementById('contrastHistoryDetails');
            if (historyDetails) historyDetails.style.display = 'none';
            
            const riskScoreDisplay = document.getElementById('allergyRiskScore');
            if (riskScoreDisplay) riskScoreDisplay.style.display = 'none';
            
            const results = document.getElementById('results');
            results.classList.remove('show');
            appState.currentResults = null;
            
            updateProgress();
            
            document.getElementById('calculateBtn').disabled = true;
            document.getElementById('pdfBtn').disabled = true;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            showNotification('âœ… è¡¨å•å·²é‡ç½®,è¯·é‡æ–°é€‰æ‹©è¯„ä¼°ç±»å‹', 'success');
        }

        function calculateEGFR_2021_Corrected(creatinine_umol, age, gender) {
            let eGFR;
            
            if (gender === 'female') {
                if (creatinine_umol <= 62) {
                    eGFR = 142 * Math.pow(creatinine_umol / 62, -0.241) * Math.pow(0.9938, age) * 1.012;
                } else {
                    eGFR = 142 * Math.pow(creatinine_umol / 62, -1.2) * Math.pow(0.9938, age) * 1.012;
                }
            } else {
                if (creatinine_umol <= 80) {
                    eGFR = 142 * Math.pow(creatinine_umol / 80, -0.302) * Math.pow(0.9938, age);
                } else {
                    eGFR = 142 * Math.pow(creatinine_umol / 80, -1.2) * Math.pow(0.9938, age);
                }
            }
            
            return Math.round(eGFR);
        }

        function generateSimplifiedEGFRCalculation(creatinine_umol, age, gender) {
            let formula = '';
            let result = '';
            
            if (gender === 'female') {
                if (creatinine_umol <= 62) {
                    formula = `å¥³æ€§,Scr â‰¤ 62 Î¼mol/L:eGFR = 142 Ã— (${creatinine_umol}/62)^(-0.241) Ã— 0.9938^${age} Ã— 1.012`;
                } else {
                    formula = `å¥³æ€§,Scr > 62 Î¼mol/L:eGFR = 142 Ã— (${creatinine_umol}/62)^(-1.2) Ã— 0.9938^${age} Ã— 1.012`;
                }
            } else {
                if (creatinine_umol <= 80) {
                    formula = `ç”·æ€§,Scr â‰¤ 80 Î¼mol/L:eGFR = 142 Ã— (${creatinine_umol}/80)^(-0.302) Ã— 0.9938^${age}`;
                } else {
                    formula = `ç”·æ€§,Scr > 80 Î¼mol/L:eGFR = 142 Ã— (${creatinine_umol}/80)^(-1.2) Ã— 0.9938^${age}`;
                }
            }
            
            result = calculateEGFR_2021_Corrected(creatinine_umol, age, gender);
            
            return {
                formula: formula,
                result: result,
                simplifiedCalculation: `${formula} = ${result}`
            };
        }

        function updateRenalFormulaDisplay() {
            updateFormulaDisplay('renal');
        }

        function updateMetforminFormulaDisplay() {
            updateFormulaDisplay('metformin');
        }

        function updateHeartFormulaDisplay() {
            const creatinine = parseFloat(document.getElementById('heartCreatinine').value);
            const age = parseFloat(document.getElementById('heartAge').value);
            const gender = document.getElementById('heartGender').value;
            const formulaDisplay = document.getElementById('heartFormulaDisplay');
            
            if (!creatinine || creatinine < 30 || creatinine > 500 || !age) {
                formulaDisplay.style.display = 'none';
                return;
            }
            
            let formulaText = '';
            if (gender === 'female') {
                if (creatinine <= 62) {
                    formulaText = `å¥³æ€§,Scr â‰¤ 62 Î¼mol/L:eGFR = 142 Ã— (${creatinine}/62)^(-0.241) Ã— 0.9938^${age} Ã— 1.012`;
                } else {
                    formulaText = `å¥³æ€§,Scr > 62 Î¼mol/L:eGFR = 142 Ã— (${creatinine}/62)^(-1.2) Ã— 0.9938^${age} Ã— 1.012`;
                }
            } else {
                if (creatinine <= 80) {
                    formulaText = `ç”·æ€§,Scr â‰¤ 80 Î¼mol/L:eGFR = 142 Ã— (${creatinine}/80)^(-0.302) Ã— 0.9938^${age}`;
                } else {
                    formulaText = `ç”·æ€§,Scr > 80 Î¼mol/L:eGFR = 142 Ã— (${creatinine}/80)^(-1.2) Ã— 0.9938^${age}`;
                }
            }
            
            const eGFR = calculateEGFR_2021_Corrected(creatinine, age, gender);
            formulaText += ` = ${eGFR} ml/min/1.73mÂ²`;
            
            formulaDisplay.innerHTML = formulaText;
            formulaDisplay.style.display = 'block';
        }

        function updateFormulaDisplay(type) {
            const gender = document.getElementById(`${type}Gender`).value;
            const creatinine = parseFloat(document.getElementById(`${type}Creatinine`).value);
            const formulaDisplay = document.getElementById(`${type}FormulaDisplay`);
            
            if (!creatinine || creatinine < 30 || creatinine > 500) {
                formulaDisplay.style.display = 'none';
                return;
            }
            
            let formulaText = '';
            if (gender === 'female') {
                if (creatinine <= 62) {
                    formulaText = `å¥³æ€§,Scr â‰¤ 62 Î¼mol/L:eGFR = 142 Ã— (${creatinine}/62)^(-0.241) Ã— 0.9938^å¹´é¾„ Ã— 1.012`;
                } else {
                    formulaText = `å¥³æ€§,Scr > 62 Î¼mol/L:eGFR = 142 Ã— (${creatinine}/62)^(-1.2) Ã— 0.9938^å¹´é¾„ Ã— 1.012`;
                }
            } else {
                if (creatinine <= 80) {
                    formulaText = `ç”·æ€§,Scr â‰¤ 80 Î¼mol/L:eGFR = 142 Ã— (${creatinine}/80)^(-0.302) Ã— 0.9938^å¹´é¾„`;
                } else {
                    formulaText = `ç”·æ€§,Scr > 80 Î¼mol/L:eGFR = 142 Ã— (${creatinine}/80)^(-1.2) Ã— 0.9938^å¹´é¾„`;
                }
            }
            
            formulaDisplay.innerHTML = formulaText;
            formulaDisplay.style.display = 'block';
        }

        function assessHeartFailureRisk(nyha, ef, bnp, eGFR = null) {
            let riskLevel = 'low';
            let recommendations = [];
            let clinicalAction = '';
            
            const nyhaValue = parseInt(nyha);
            const efValue = parseFloat(ef);
            
            if (nyhaValue === 1 && efValue >= 50) {
                riskLevel = 'low';
                clinicalAction = 'ä½é£é™©å¤„ç†';
                recommendations = [
                    'å¿ƒåŠŸèƒ½å°šå¯,æŒ‰æ ‡å‡†æµç¨‹æ£€æŸ¥',
                    'é€‚å½“æ§åˆ¶é€ å½±å‰‚ç”¨é‡',
                    'ç›‘æµ‹è¡€æµåŠ¨åŠ›å­¦å˜åŒ–',
                    'æ£€æŸ¥åè§‚å¯Ÿ2å°æ—¶'
                ];
            } else if (nyhaValue <= 2 && efValue >= 40) {
                riskLevel = 'moderate';
                clinicalAction = 'ä¸­åº¦é£é™©ç›‘æµ‹';
                recommendations = [
                    'è½»åº¦å¿ƒåŠŸèƒ½ä¸å…¨,éœ€è°¨æ…è¯„ä¼°',
                    'é€ å½±å‰‚ç”¨é‡å‡è‡³æ ‡å‡†ç”¨é‡çš„85%',
                    'æ§åˆ¶æ³¨å°„æµé€Ÿâ‰¤4.5ml/s',
                    'å¯†åˆ‡å…³æ³¨æœ‰æ— è¿‡æ•ååº”',
                    'æ£€æŸ¥å‰åç›‘æµ‹BNPå˜åŒ–',
                    'å¿…è¦æ—¶é¢„é˜²æ€§ä½¿ç”¨åˆ©å°¿å‰‚'
                ];
            } else if (nyhaValue === 3 || efValue < 40) {
                riskLevel = 'high';
                clinicalAction = 'é«˜é£é™©å¤„ç†';
                recommendations = [
                    'æ˜æ˜¾å¿ƒåŠŸèƒ½ä¸å…¨,é«˜é£é™©',
                    'é€ å½±å‰‚ç”¨é‡å‡è‡³æ ‡å‡†ç”¨é‡çš„70%',
                    'ä¸¥æ ¼æ§åˆ¶æ³¨å°„æµé€Ÿâ‰¤4.0ml/s',
                    'åˆ†æ¬¡æ³¨å°„,é¿å…çŸ­æ—¶é—´å¤§é‡è´Ÿè·',
                    'æ£€æŸ¥å‰ä¼˜åŒ–å¿ƒåŠŸèƒ½æ²»ç–—',
                    'å¿ƒå†…ç§‘ä¼šè¯Šè¯„ä¼°',
                    'å‡†å¤‡æ€¥æ•‘è¯ç‰©å’Œè®¾å¤‡'
                ];
            } else if (nyhaValue === 4 || efValue < 30) {
                riskLevel = 'very-high';
                clinicalAction = 'æé«˜é£é™© - æ…é‡è€ƒè™‘';
                recommendations = [
                    'ä¸¥é‡å¿ƒåŠŸèƒ½ä¸å…¨,æé«˜é£é™©',
                    'å¼ºçƒˆå»ºè®®é¿å…æˆ–æ¨è¿Ÿæ£€æŸ¥',
                    'å¦‚å¿…é¡»æ£€æŸ¥,éœ€CCUç›‘æŠ¤æ¡ä»¶',
                    'é€ å½±å‰‚ç”¨é‡å‡è‡³æœ€ä½(â‰¤50ml)',
                    'è€ƒè™‘æ›¿ä»£æ£€æŸ¥æ–¹æ³•',
                    'å¿…é¡»å¿ƒå†…ç§‘å›¢é˜Ÿåœ¨åœº'
                ];
            }
            
            if (eGFR !== null && eGFR < 60) {
                if (eGFR < 30) {
                    riskLevel = 'very-high';
                    recommendations.unshift('âš ï¸ ä¸¥é‡å¿ƒè‚¾ç»¼åˆå¾é£é™©,eGFR<30,å¼ºçƒˆå»ºè®®é¿å…é€ å½±å‰‚');
                } else if (eGFR < 45) {
                    if (riskLevel === 'low') riskLevel = 'moderate';
                    else if (riskLevel === 'moderate') riskLevel = 'high';
                    recommendations.unshift('âš ï¸ å¿ƒè‚¾ç»¼åˆå¾é£é™©,éœ€åŒé‡è€ƒè™‘,é€ å½±å‰‚å†å‡é‡20%');
                } else {
                    recommendations.unshift('âš ï¸ è½»åº¦è‚¾åŠŸèƒ½ä¸å…¨,æ³¨æ„å¿ƒè‚¾ç»¼åˆå¾é£é™©');
                }
            }
            
            if (bnp === 'severe') {
                riskLevel = riskLevel === 'low' ? 'moderate' : 
                           riskLevel === 'moderate' ? 'high' : 'very-high';
                recommendations.unshift('BNPä¸¥é‡å‡é«˜,æç¤ºå¿ƒåŠŸèƒ½å¤±ä»£å¿é£é™©');
            }
            
            return { 
                riskLevel, 
                recommendations, 
                clinicalAction,
                riskScore: calculateHeartRiskScore(nyhaValue, efValue, bnp, eGFR)
            };
        }

        function calculateHeartRiskScore(nyha, ef, bnp, eGFR = null) {
            let score = 0;
            score += nyha;
            
            if (ef >= 50) score += 1;
            else if (ef >= 40) score += 2;
            else if (ef >= 30) score += 3;
            else score += 4;
            
            switch(bnp) {
                case 'normal': score += 0; break;
                case 'mild': score += 1; break;
                case 'moderate': score += 2; break;
                case 'severe': score += 3; break;
            }
            
            if (eGFR !== null) {
                if (eGFR < 30) score += 3;
                else if (eGFR < 45) score += 2;
                else if (eGFR < 60) score += 1;
            }
            
            return score;
        }

        function assessMetforminRisk(eGFR, dose, age) {
            let riskLevel = 'low';
            let recommendations = [];
            let clinicalAction = '';
            
            if (eGFR >= 60) {
                riskLevel = 'low';
                clinicalAction = 'æ ‡å‡†å¤„ç†';
                recommendations = [
                    'è‚¾åŠŸèƒ½æ­£å¸¸,é€ å½±å‰åæš‚åœäºŒç”²åŒèƒ48å°æ—¶',
                    'é€ å½±åç›‘æµ‹è‚¾åŠŸèƒ½,æ— å¼‚å¸¸å¯æ¢å¤ç”¨è¯',
                    'å»ºè®®é€ å½±å‰åå……åˆ†æ°´åŒ–'
                ];
            } else if (eGFR >= 45) {
                riskLevel = 'moderate';
                clinicalAction = 'è°¨æ…ç›‘æµ‹';
                recommendations = [
                    'è½»åº¦è‚¾åŠŸèƒ½ä¸å…¨,éœ€è°¨æ…è¯„ä¼°',
                    'é€ å½±å‰åæš‚åœäºŒç”²åŒèƒ48-72å°æ—¶',
                    'é€ å½±å48-72å°æ—¶å¤æŸ¥è‚¾åŠŸèƒ½',
                    'å»ºè®®é™è„‰æ°´åŒ–:0.9% NaCl 1ml/kg/h,æ£€æŸ¥å‰6-12hå¼€å§‹'
                ];
            } else if (eGFR >= 30) {
                riskLevel = 'high';
                clinicalAction = 'é«˜é£é™©å¤„ç†';
                recommendations = [
                    'ä¸­åº¦è‚¾åŠŸèƒ½ä¸å…¨,é«˜é£é™©',
                    'é€ å½±å‰åæš‚åœäºŒç”²åŒèƒ72å°æ—¶',
                    'è€ƒè™‘å‡å°‘é€ å½±å‰‚ç”¨é‡è‡³æ ‡å‡†ç”¨é‡çš„80%',
                    'å¿…é¡»é™è„‰æ°´åŒ–:0.9% NaCl 1ml/kg/h Ã— 12h',
                    'å¯†åˆ‡å…³æ³¨æœ‰æ— è¿‡æ•ååº”',
                    'é€ å½±å72å°æ—¶å†…å¯†åˆ‡ç›‘æµ‹è‚¾åŠŸèƒ½'
                ];
            } else {
                riskLevel = 'very-high';
                clinicalAction = 'æé«˜é£é™© - é¿å…æ£€æŸ¥';
                recommendations = [
                    'é‡åº¦è‚¾åŠŸèƒ½ä¸å…¨,æé«˜é£é™©',
                    'å¼ºçƒˆå»ºè®®é¿å…ä½¿ç”¨é€ å½±å‰‚',
                    'å¦‚å¿…é¡»æ£€æŸ¥,éœ€å†…åˆ†æ³Œç§‘å’Œè‚¾å†…ç§‘ä¼šè¯Š',
                    'è€ƒè™‘æ›¿ä»£æ£€æŸ¥æ–¹æ³•(MRIã€è¶…å£°ç­‰)',
                    'å¦‚æ— æ³•é¿å…,éœ€é€æå‡†å¤‡'
                ];
            }

            if (age >= 75 && eGFR < 60) {
                recommendations.unshift('é«˜é¾„æ‚£è€…,å¢åŠ ç›‘æµ‹é¢‘æ¬¡');
            }
            
            return { 
                riskLevel, 
                recommendations, 
                clinicalAction,
                riskScore: calculateRiskScore(eGFR, age, dose)
            };
        }

        function calculateRiskScore(eGFR, age, dose) {
            let score = 0;
            
            if (eGFR >= 60) score += 1;
            else if (eGFR >= 45) score += 2;
            else if (eGFR >= 30) score += 3;
            else score += 4;
            
            if (age >= 75) score += 1;
            else if (age >= 65) score += 0.5;
            
            const doseNum = parseInt(dose);
            if (doseNum >= 2000) score += 1;
            else if (doseNum >= 1500) score += 0.5;
            
            return score;
        }

        function calculateAllergyRiskScore() {
            let score = 0;
            
            const previousReaction = document.querySelector('input[name="previousReaction"]:checked');
            if (previousReaction) {
                switch(previousReaction.value) {
                    case 'mild': score += 1; break;
                    case 'moderate': 
                    case 'severe': score += 3; break;
                }
            }
            
            if (document.getElementById('drug-multiple')?.checked) score += 2;
            if (document.getElementById('drug-severe-allergy')?.checked) score += 3;
            
            if (document.getElementById('food-seafood')?.checked || 
                document.getElementById('food-nuts')?.checked) score += 1;
            
            const asthma = document.querySelector('input[name="asthma"]:checked');
            if (asthma) {
                switch(asthma.value) {
                    case 'mild': score += 1; break;
                    case 'severe': score += 2; break;
                    case 'allergic': score += 3; break;
                }
            }
            
            if (document.getElementById('other-rhinitis')?.checked) score += 1;
            if (document.getElementById('other-eczema')?.checked) score += 1;
            if (document.getElementById('special-mastocytosis')?.checked) score += 2;
            
            return score;
        }

        function assessAllergyRisk(score) {
            let riskLevel, riskText, riskColor, reactionRate, strategy, premedication;
            
            if (score === 0) {
                riskLevel = 'minimal';
                riskText = 'æ— æ˜æ˜¾é£é™©';
                riskColor = 'score-minimal';
                reactionRate = '0.1-0.5%';
                strategy = 'æ ‡å‡†ç›‘æµ‹';
                premedication = 'æ— éœ€é¢„å¤„ç†,å¸¸è§„ç›‘æµ‹å³å¯';
            } else if (score === 1) {
                riskLevel = 'low';
                riskText = 'ä½é£é™©';
                riskColor = 'score-low';
                reactionRate = '1-2%';
                strategy = 'è€ƒè™‘é¢„å¤„ç†';
                premedication = 'å¯è€ƒè™‘æ£€æŸ¥å‰1å°æ—¶ç»™äºˆè‹¯æµ·æ‹‰æ˜25mgå£æœ';
            } else if (score >= 2 && score <= 3) {
                riskLevel = 'moderate';
                riskText = 'ä¸­ç­‰é£é™©';
                riskColor = 'score-moderate';
                reactionRate = '2-5%';
                strategy = 'æ ‡å‡†é¢„å¤„ç†æ–¹æ¡ˆ';
                premedication = `æ£€æŸ¥å‰13å°æ—¶:å¼ºçš„æ¾50mgå£æœ\næ£€æŸ¥å‰1å°æ—¶:è‹¯æµ·æ‹‰æ˜50mgè‚Œæ³¨æˆ–å£æœ`;
            } else if (score >= 4 && score <= 5) {
                riskLevel = 'high';
                riskText = 'é«˜é£é™©';
                riskColor = 'score-high';
                reactionRate = '5-10%';
                strategy = 'å¼ºåŒ–é¢„å¤„ç†+ä¸“ç§‘è¯„ä¼°';
                premedication = `æ£€æŸ¥å‰13å°æ—¶å’Œ7å°æ—¶:ç”²æ³¼å°¼é¾™40mg IV\næ£€æŸ¥å‰1å°æ—¶:è‹¯æµ·æ‹‰æ˜50mg IV + é›·å°¼æ›¿ä¸50mg IV\nå»ºè®®è¿‡æ•ç§‘ä¼šè¯Šè¯„ä¼°`;
            } else {
                riskLevel = 'very-high';
                riskText = 'æé«˜é£é™©';
                riskColor = 'score-very-high';
                reactionRate = '10-30%';
                strategy = 'é¿å…ä½¿ç”¨æˆ–è¿‡æ•ç§‘ä¼šè¯Š';
                premedication = `å¼ºçƒˆå»ºè®®é¿å…é€ å½±å‰‚æ£€æŸ¥\nå¦‚å¿…é¡»æ£€æŸ¥:è¿‡æ•ç§‘ä¼šè¯Š,ICUç›‘æŠ¤æ¡ä»¶ä¸‹è¿›è¡Œ\nç´§æ€¥é¢„å¤„ç†:æ£€æŸ¥å‰4-6å°æ—¶,ç”²æ³¼å°¼é¾™40mg IV,æ¯4å°æ—¶ä¸€æ¬¡,å…±3æ¬¡`;
            }
            
            const recommendations = generateAllergyRecommendations(score);
            const emergencyPrep = generateEmergencyPreparation(riskLevel);
            
            return {
                riskLevel,
                riskText,
                riskColor,
                reactionRate,
                strategy,
                premedication,
                recommendations,
                emergencyPrep,
                contrastChoice: generateContrastChoice(riskLevel)
            };
        }

        function generateAllergyRecommendations(score) {
            const recommendations = [];
            
            if (score === 0) {
                recommendations.push(
                    'å¸¸è§„ç”Ÿå‘½ä½“å¾ç›‘æµ‹',
                    'è§‚å¯Ÿçš®è‚¤å’Œå‘¼å¸é“å˜åŒ–',
                    'æ£€æŸ¥åè§‚å¯Ÿ30åˆ†é’Ÿ'
                );
            } else if (score === 1) {
                recommendations.push(
                    'å¯†åˆ‡è§‚å¯Ÿå‰30åˆ†é’Ÿ',
                    'å‡†å¤‡æŠ—è¿‡æ•è¯ç‰©',
                    'æ‚£è€…æ•™è‚²:åŠæ—¶æŠ¥å‘Šä¸é€‚'
                );
            } else if (score >= 2 && score <= 3) {
                recommendations.push(
                    'å»ºç«‹å¯é é™è„‰é€šè·¯',
                    'è¿ç»­å¿ƒç”µç›‘æŠ¤',
                    'è¡€å‹ã€è¡€æ°§é¥±å’Œåº¦ç›‘æµ‹',
                    'å‡†å¤‡è‚¾ä¸Šè…ºç´ ã€æ¿€ç´ ç­‰æ€¥æ•‘è¯ç‰©',
                    'æ£€æŸ¥åè§‚å¯Ÿ1-2å°æ—¶'
                );
            } else if (score >= 4 && score <= 5) {
                recommendations.push(
                    'å¤šè·¯é™è„‰é€šè·¯',
                    'è¿ç»­ç›‘æŠ¤è®¾å¤‡',
                    'éº»é†‰ç§‘æˆ–ICUåŒ»å¸ˆåœ¨åœº',
                    'æ°”ç®¡æ’ç®¡è®¾å¤‡å‡†å¤‡',
                    'å®Œå–„çš„è¿‡æ•ååº”æŠ¢æ•‘æ–¹æ¡ˆ',
                    'æ£€æŸ¥åè§‚å¯Ÿ4-6å°æ—¶'
                );
            } else {
                recommendations.push(
                    'å¼ºçƒˆå»ºè®®é‡æ–°è¯„ä¼°æ£€æŸ¥å¿…è¦æ€§',
                    'è€ƒè™‘MRIã€è¶…å£°ç­‰æ›¿ä»£æ–¹æ³•',
                    'å¦‚æ— æ³•é¿å…:è¿‡æ•ç§‘è”åˆä¼šè¯Š',
                    'ICUç›‘æŠ¤æ¡ä»¶ä¸‹è¿›è¡Œ',
                    'å®Œæ•´çš„è¿‡æ•ååº”æŠ¢æ•‘å›¢é˜Ÿ'
                );
            }
            
            return recommendations;
        }

        function generateEmergencyPreparation(riskLevel) {
            const prep = {
                medications: [],
                equipment: [],
                personnel: []
            };
            
            prep.medications.push(
                'è‚¾ä¸Šè…ºç´  1:1000',
                'ç”²æ³¼å°¼é¾™ 40-125mg',
                'è‹¯æµ·æ‹‰æ˜ 25-50mg',
                'é›·å°¼æ›¿ä¸ 50mg'
            );
            
            prep.equipment.push(
                'å¿ƒç”µç›‘æŠ¤è®¾å¤‡',
                'è¡€å‹ç›‘æµ‹',
                'è„‰æè¡€æ°§ä»ª',
                'æ°§æ°”ä¾›åº”ç³»ç»Ÿ',
                'é™è„‰è¾“æ¶²ç”¨å“'
            );
            
            if (riskLevel === 'high' || riskLevel === 'very-high') {
                prep.medications.push(
                    'å¤šå·´èƒº',
                    'å»ç”²è‚¾ä¸Šè…ºç´ ',
                    'æ°¨èŒ¶ç¢±',
                    'åœ°å¡ç±³æ¾'
                );
                
                prep.equipment.push(
                    'æ°”ç®¡æ’ç®¡è®¾å¤‡',
                    'ç®€æ˜“å‘¼å¸å™¨',
                    'é™¤é¢¤å™¨',
                    'ä¸­å¿ƒé™è„‰ç½®ç®¡åŒ…'
                );
                
                prep.personnel.push(
                    'ç»éªŒä¸°å¯Œçš„æ”¾å°„ç§‘åŒ»å¸ˆ',
                    'éº»é†‰ç§‘åŒ»å¸ˆ',
                    'æ€¥æ•‘æŠ¤å£«'
                );
            }
            
            if (riskLevel === 'very-high') {
                prep.personnel.push(
                    'è¿‡æ•ç§‘åŒ»å¸ˆ',
                    'ICUåŒ»å¸ˆ',
                    'æ€¥æ•‘å›¢é˜Ÿ'
                );
            }
            
            return prep;
        }

        function generateContrastChoice(riskLevel) {
            let choice = '';
            
            switch(riskLevel) {
                case 'minimal':
                case 'low':
                    choice = 'æ ‡å‡†ä½æ¸—é€ å½±å‰‚(å¦‚ç¢˜æµ·é†‡ã€ç¢˜æ™®ç½—èƒº)';
                    break;
                case 'moderate':
                    choice = 'ä½æ¸—é€ å½±å‰‚,é¦–é€‰ç¢˜å…‹æ²™é†‡(ç­‰æ¸—)';
                    break;
                case 'high':
                    choice = 'ç­‰æ¸—é€ å½±å‰‚(ç¢˜å…‹æ²™é†‡),è€ƒè™‘çš®è¯•';
                    break;
                case 'very-high':
                    choice = 'å¼ºçƒˆå»ºè®®é¿å…ä½¿ç”¨,è€ƒè™‘MRIå¢å¼ºæˆ–è¶…å£°æ£€æŸ¥';
                    break;
            }
            
            return choice;
        }

        function setupCheckboxExclusivity() {
            const drugGroup = document.getElementById('drugAllergyGroup');
            const foodGroup = document.getElementById('foodAllergyGroup');
            
            if (drugGroup) {
                drugGroup.addEventListener('change', function(e) {
                    if (e.target.type === 'checkbox' && e.target.dataset.group === 'drug') {
                        if (e.target.id === 'drug-none' && e.target.checked) {
                            drugGroup.querySelectorAll('input[type="checkbox"]:not(#drug-none)').forEach(cb => {
                                cb.checked = false;
                            });
                        } else if (e.target.id !== 'drug-none' && e.target.checked) {
                            document.getElementById('drug-none').checked = false;
                        }
                    }
                });
            }
            
            if (foodGroup) {
                foodGroup.addEventListener('change', function(e) {
                    if (e.target.type === 'checkbox' && e.target.dataset.group === 'food') {
                        if (e.target.id === 'food-none' && e.target.checked) {
                            foodGroup.querySelectorAll('input[type="checkbox"]:not(#food-none)').forEach(cb => {
                                cb.checked = false;
                            });
                        } else if (e.target.id !== 'food-none' && e.target.checked) {
                            document.getElementById('food-none').checked = false;
                        }
                    }
                });
            }
        }

        function setupRealTimeValidation() {
            const validationRules = {
                Height: { min: 100, max: 250, message: 'èº«é«˜å¿…é¡»åœ¨100-250cmä¹‹é—´' },
                Weight: { min: 20, max: 200, message: 'ä½“é‡å¿…é¡»åœ¨20-200kgä¹‹é—´' },
                Creatinine: { min: 30, max: 500, message: 'è¡€è‚Œé…å€¼å¿…é¡»åœ¨30-500Î¼mol/Lä¹‹é—´' },
                Age: { min: 18, max: 120, message: 'å¹´é¾„å¿…é¡»åœ¨18-120å²ä¹‹é—´' },
                EF: { min: 10, max: 80, message: 'EFå€¼å¿…é¡»åœ¨10-80%ä¹‹é—´' }
            };

            ['normal', 'renal', 'metformin', 'heart'].forEach(type => {
                Object.keys(validationRules).forEach(fieldType => {
                    const fieldId = type + fieldType;
                    const field = document.getElementById(fieldId);
                    const validation = document.getElementById(`${fieldId}-validation`);
                    const error = document.getElementById(`${fieldId}-error`);
                    
                    if (field) {
                        field.addEventListener('input', function() {
                            validateField(this, validationRules[fieldType], validation, error);
                            updateProgress();
                            
                            if (fieldType === 'Creatinine' && (type === 'renal' || type === 'metformin')) {
                                updateFormulaDisplay(type);
                            }
                            
                            if (type === 'heart' && (fieldType === 'Creatinine' || fieldType === 'Age')) {
                                updateHeartFormulaDisplay();
                            }
                        });
                    }
                });
            });
        }

        function validateField(field, rule, validationEl, errorEl) {
            const value = parseFloat(field.value);
            const isValid = !isNaN(value) && value >= rule.min && value <= rule.max;
            
            if (field.value === '') {
                field.classList.remove('input-error');
                if (validationEl) validationEl.textContent = '';
                if (errorEl) errorEl.style.display = 'none';
                return null;
            }
            
            if (isValid) {
                field.classList.remove('input-error');
                if (validationEl) {
                    validationEl.textContent = 'âœ“';
                    validationEl.className = 'real-time-validation validation-success';
                }
                if (errorEl) errorEl.style.display = 'none';
                return true;
            } else {
                field.classList.add('input-error');
                if (validationEl) {
                    validationEl.textContent = 'âœ—';
                    validationEl.className = 'real-time-validation validation-error';
                }
                if (errorEl) errorEl.style.display = 'block';
                return false;
            }
        }

        document.addEventListener('change', function(e) {
            if (e.target.name === 'previousContrast') {
                const historyDetails = document.getElementById('contrastHistoryDetails');
                if (e.target.value === 'yes') {
                    historyDetails.style.display = 'block';
                } else {
                    historyDetails.style.display = 'none';
                    document.querySelectorAll('input[name="previousReaction"]').forEach(r => r.checked = false);
                }
                updateAllergyRiskScore();
            }
            
            if (e.target.closest('#allergyForm')) {
                updateAllergyRiskScore();
            }
        });

        function updateAllergyRiskScore() {
            if (appState.currentPatientType !== 'allergy') return;
            
            const score = calculateAllergyRiskScore();
            appState.allergyRiskScore = score;
            
            const riskAssessment = assessAllergyRisk(score);
            const scoreDisplay = document.getElementById('allergyRiskScore');
            const scoreValue = document.getElementById('riskScoreValue');
            const riskLevelText = document.getElementById('riskLevelText');
            
            if (scoreDisplay && scoreValue && riskLevelText) {
                scoreValue.textContent = score;
                scoreValue.className = `score-value ${riskAssessment.riskColor}`;
                riskLevelText.innerHTML = `
                    <div style="font-size: 1.2em; margin-bottom: 5px; font-weight: 600;">${riskAssessment.riskText} (${riskAssessment.reactionRate})</div>
                    <div style="font-size: 0.9em; opacity: 0.8;">${riskAssessment.strategy}</div>
                `;
                scoreDisplay.style.display = 'block';
            }
            
            updateProgress();
        }

        function updateProgress() {
            if (!appState.currentPatientType) {
                const progressBar = document.getElementById('progress');
                if (progressBar) progressBar.style.width = '0%';
                const calculateBtn = document.getElementById('calculateBtn');
                if (calculateBtn) calculateBtn.disabled = true;
                return;
            }
            
            let progress = 0;
            
            if (appState.currentPatientType === 'allergy') {
                let totalFields = 3;
                let completedFields = 0;
                
                const previousContrast = document.querySelector('input[name="previousContrast"]:checked');
                if (previousContrast) {
                    if (previousContrast.value === 'no') {
                        completedFields += 1;
                    } else if (previousContrast.value === 'yes') {
                        const previousReaction = document.querySelector('input[name="previousReaction"]:checked');
                        if (previousReaction) {
                            completedFields += 1;
                        }
                    }
                }
                
                if (document.querySelector('#drugAllergyGroup input:checked')) {
                    completedFields += 1;
                }
                
                if (document.querySelector('input[name="asthma"]:checked')) {
                    completedFields += 1;
                }
                
                progress = (completedFields / totalFields) * 100;
            } else {
                const requiredFields = getRequiredFields(appState.currentPatientType);
                let completedFields = 0;
                
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && field.value !== '') {
                        completedFields++;
                    }
                });
                
                progress = (completedFields / requiredFields.length) * 100;
            }
            
            const progressBar = document.getElementById('progress');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
            
            const calculateBtn = document.getElementById('calculateBtn');
            if (calculateBtn) {
                const threshold = appState.currentPatientType === 'allergy' ? 66 : 80;
                calculateBtn.disabled = progress < threshold;
            }
        }

        function getRequiredFields(type) {
            const baseFields = [`${type}Height`, `${type}Weight`];
            
            if (type === 'renal' || type === 'metformin') {
                baseFields.push(`${type}Creatinine`, `${type}Age`);
            } else if (type === 'heart') {
                baseFields.push(`${type}EF`);
            }
            
            return baseFields;
        }

        function calculate() {
            if (!appState.currentPatientType) {
                showNotification('è¯·å…ˆé€‰æ‹©è¯„ä¼°ç±»å‹', 'error');
                return;
            }
            
            try {
                let results;
                
                if (appState.currentPatientType === 'allergy') {
                    results = calculateAllergyAssessment();
                } else {
                    results = calculateContrastDosage();
                }
                
                displayResults(results);
                appState.currentResults = results;
                document.getElementById('pdfBtn').disabled = false;
                showNotification('è¯„ä¼°è®¡ç®—å®Œæˆ!', 'success');
            } catch (error) {
                console.error('è®¡ç®—è¿‡ç¨‹å‡ºé”™:', error);
                showNotification('è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:' + error.message, 'error');
            }
        }

        function calculateAllergyAssessment() {
            const score = calculateAllergyRiskScore();
            const riskAssessment = assessAllergyRisk(score);
            
            const previousContrast = document.querySelector('input[name="previousContrast"]:checked')?.value || 'unknown';
            const previousReaction = document.querySelector('input[name="previousReaction"]:checked')?.value || 'none';
            const asthma = document.querySelector('input[name="asthma"]:checked')?.value || 'none';
            
            const selectedRiskFactors = [];
            document.querySelectorAll('#allergyForm input:checked').forEach(input => {
                const label = document.querySelector(`label[for="${input.id}"]`);
                if (label && !input.name) {
                    selectedRiskFactors.push(label.textContent.trim());
                }
            });
            
            return {
                patientType: 'allergy',
                score,
                riskAssessment,
                previousContrast,
                previousReaction,
                asthma,
                selectedRiskFactors,
                timestamp: new Date()
            };
        }

        function calculateContrastDosage() {
            const type = appState.currentPatientType;
            
            const heightElement = document.getElementById(`${type}Height`);
            const weightElement = document.getElementById(`${type}Weight`);
            const heartRateElement = type === 'heart' ? 
                document.getElementById('heartRate') : 
                document.getElementById(`${type}HeartRate`);
            const examTypeElement = document.getElementById(`${type}ExamType`);
            
            if (!heightElement || !weightElement || !heartRateElement || !examTypeElement) {
                throw new Error('è¡¨å•å…ƒç´ ç¼ºå¤±,è¯·æ£€æŸ¥è¾“å…¥');
            }
            
            const height = parseFloat(heightElement.value);
            const weight = parseFloat(weightElement.value);
            const heartRate = parseInt(heartRateElement.value);
            const examType = examTypeElement.value;

            if (!height || height < 100 || height > 250) {
                throw new Error('èº«é«˜èŒƒå›´åº”åœ¨100-250cmä¹‹é—´');
            }
            if (!weight || weight < 20 || weight > 200) {
                throw new Error('ä½“é‡èŒƒå›´åº”åœ¨20-200kgä¹‹é—´');
            }

            let specialData = null;
            
            if (type === 'renal' || type === 'metformin') {
                const creatinine = parseFloat(document.getElementById(`${type}Creatinine`).value);
                const age = parseInt(document.getElementById(`${type}Age`).value);
                const gender = document.getElementById(`${type}Gender`).value;

                if (!creatinine || creatinine < 30 || creatinine > 500) {
                    throw new Error('è¡€è‚Œé…å€¼èŒƒå›´åº”åœ¨30-500 Î¼mol/Lä¹‹é—´');
                }
                if (!age || age < 18 || age > 120) {
                    throw new Error('å¹´é¾„èŒƒå›´åº”åœ¨18-120å²ä¹‹é—´');
                }

                const eGFR = calculateEGFR_2021_Corrected(creatinine, age, gender);
                const eGFRDetails = generateSimplifiedEGFRCalculation(creatinine, age, gender);
                
                specialData = {
                    eGFR,
                    creatinine,
                    age,
                    gender,
                    calculationMethod: '2021ç‰ˆCKD-EPIå…¬å¼',
                    eGFRDetails
                };
                
                if (type === 'metformin') {
                    const dose = document.getElementById('metforminDose').value;
                    const metforminRisk = assessMetforminRisk(eGFR, dose, age);
                    specialData.metforminRisk = metforminRisk;
                    specialData.dose = dose;
                }
            } else if (type === 'heart') {
                const nyha = document.getElementById('heartNYHA').value;
                const ef = parseFloat(document.getElementById('heartEF').value);
                const bnp = document.getElementById('heartBNP').value;
                const creatinine = parseFloat(document.getElementById('heartCreatinine').value) || null;
                const age = parseInt(document.getElementById('heartAge').value) || null;
                const gender = document.getElementById('heartGender').value;

                if (!ef || ef < 10 || ef > 80) {
                    throw new Error('EFå€¼èŒƒå›´åº”åœ¨10-80%ä¹‹é—´');
                }

                let eGFR = null;
                let eGFRDetails = null;
                if (creatinine && creatinine >= 30 && creatinine <= 500 && age) {
                    eGFR = calculateEGFR_2021_Corrected(creatinine, age, gender);
                    eGFRDetails = generateSimplifiedEGFRCalculation(creatinine, age, gender);
                }

                const heartRisk = assessHeartFailureRisk(nyha, ef, bnp, eGFR);
                specialData = {
                    nyha,
                    ef,
                    bnp,
                    heartRisk,
                    creatinine,
                    age,
                    gender,
                    eGFR,
                    eGFRDetails
                };
            }

            return performCalculations(height, weight, heartRate, examType, type, specialData);
        }

        function performCalculations(height, weight, heartRate, examType, patientType, specialData) {
            const bmi = weight / Math.pow(height / 100, 2);
            
            let contrastVolume;
            let maxVolume;
            
            if (examType === 'coronary') {
                contrastVolume = weight * (heartRate <= 80 ? 0.8 : 0.85);
                maxVolume = 60;
            } else {
                contrastVolume = weight * (heartRate <= 80 ? 0.8 : 0.85) + 15;
                maxVolume = 75;
            }

            let contrastAdjustments = [];
            
            if ((patientType === 'renal' || patientType === 'metformin') && specialData && specialData.eGFR < 45) {
                const originalVolume = contrastVolume;
                contrastVolume = contrastVolume * 0.8;
                contrastAdjustments.push(`è‚¾åŠŸèƒ½ä¸å…¨è°ƒæ•´:${originalVolume.toFixed(1)}ml â†’ ${contrastVolume.toFixed(1)}ml (å‡é‡20%)`);
            }
            
            if (patientType === 'heart' && specialData) {
                const risk = specialData.heartRisk;
                let reductionFactor = 1;
                
                if (risk.riskLevel === 'moderate') reductionFactor = 0.85;
                else if (risk.riskLevel === 'high') reductionFactor = 0.70;
                else if (risk.riskLevel === 'very-high') reductionFactor = 0.50;
                
                if (reductionFactor < 1) {
                    const originalVolume = contrastVolume;
                    contrastVolume = contrastVolume * reductionFactor;
                    contrastAdjustments.push(`å¿ƒåŠŸèƒ½ä¸å…¨è°ƒæ•´:${originalVolume.toFixed(1)}ml â†’ ${contrastVolume.toFixed(1)}ml (å‡é‡${((1-reductionFactor)*100).toFixed(0)}%)`);
                }
                
                if (specialData.eGFR && specialData.eGFR < 45) {
                    const originalVolume = contrastVolume;
                    contrastVolume = contrastVolume * 0.8;
                    contrastAdjustments.push(`å¿ƒè‚¾ç»¼åˆå¾é¢å¤–è°ƒæ•´:${originalVolume.toFixed(1)}ml â†’ ${contrastVolume.toFixed(1)}ml (å†å‡é‡20%)`);
                }
            }

            const isVolumeExceeded = contrastVolume > maxVolume;
            const originalVolume = contrastVolume;
            if (isVolumeExceeded) {
                contrastVolume = maxVolume;
            }

            let flowRate;
            if (examType === 'coronary') {
                flowRate = contrastVolume / 12;
            } else {
                flowRate = Math.max(contrastVolume - 15, 0) / 12;
            }

            if (patientType === 'heart' && specialData) {
                const risk = specialData.heartRisk;
                let maxFlowRate = 5.0;
                
                if (risk.riskLevel === 'moderate') maxFlowRate = 4.5;
                else if (risk.riskLevel === 'high') maxFlowRate = 4.0;
                else if (risk.riskLevel === 'very-high') maxFlowRate = 3.5;
                
                if (flowRate > maxFlowRate) {
                    flowRate = maxFlowRate;
                }
            }

            const isFlowRateExceeded = flowRate > 5.0;
            const originalFlowRate = flowRate;
            if (isFlowRateExceeded) {
                flowRate = 5.0;
            }

            return {
                height, weight, heartRate, examType, bmi, patientType,
                contrastVolume, flowRate, maxVolume,
                isVolumeExceeded, originalVolume,
                isFlowRateExceeded, originalFlowRate,
                specialData, 
                contrastAdjustments,
                timestamp: new Date()
            };
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('calculationResults');
            
            if (results.patientType === 'allergy') {
                displayAllergyResults(results, resultsContent);
            } else {
                displayContrastResults(results, resultsContent);
            }
            
            resultsDiv.classList.add('show');
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function displayAllergyResults(results, container) {
            const assessment = results.riskAssessment;
            const riskColorClass = assessment.riskColor.replace('score-', 'grade-');
            
            let previousContrastText = '';
            if (results.previousContrast === 'yes') {
                const reactionTexts = {
                    'none': 'æ— ååº”',
                    'mild': 'è½»å¾®ååº”',
                    'moderate': 'ä¸­åº¦ååº”',
                    'severe': 'ä¸¥é‡ååº”'
                };
                previousContrastText = `æ—¢å¾€ä½¿ç”¨è¿‡é€ å½±å‰‚,ååº”æƒ…å†µ:${reactionTexts[results.previousReaction] || 'æœªçŸ¥'}`;
            } else {
                previousContrastText = 'æ—¢å¾€æœªä½¿ç”¨è¿‡é€ å½±å‰‚';
            }

            const asthmaTexts = {
                'none': 'æ— å“®å–˜ç—…å²',
                'mild': 'è½»åº¦å“®å–˜',
                'severe': 'é‡åº¦å“®å–˜', 
                'allergic': 'å“®å–˜ä¼´è¿‡æ•å²'
            };

            container.innerHTML = `
                <div class="calc-type">
                    <div>é€ å½±å‰‚è¿‡æ•é£é™©è¯„ä¼° | 2024ç‰ˆè¯„ä¼°æ ‡å‡†</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">
                        è¯„ä¼°æ—¶é—´:${results.timestamp.toLocaleString()}
                    </div>
                </div>
                
                <div class="risk-score-display">
                    <div class="score-value ${assessment.riskColor}">${results.score}</div>
                    <div style="font-size: 1.2em; margin-bottom: 5px; font-weight: 600; color: var(--${riskColorClass}-color);">${assessment.riskText}</div>
                    <div style="font-size: 0.9em; opacity: 0.8;">ååº”å‘ç”Ÿç‡:${assessment.reactionRate}</div>
                </div>

                <div class="result-item">
                    <span class="result-label">æ—¢å¾€é€ å½±å‰‚ä½¿ç”¨å²</span>
                    <span class="result-value">${previousContrastText}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">å“®å–˜ç—…å²</span>
                    <span class="result-value">${asthmaTexts[results.asthma] || 'æœªè¯„ä¼°'}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">é£é™©è¯„åˆ†</span>
                    <span class="result-value" style="color: var(--${riskColorClass}-color);">${results.score} åˆ†</span>
                </div>
                <div class="result-item">
                    <span class="result-label">é£é™©ç­‰çº§</span>
                    <span class="result-value" style="color: var(--${riskColorClass}-color);">${assessment.riskText}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">å¤„ç†ç­–ç•¥</span>
                    <span class="result-value">${assessment.strategy}</span>
                </div>

                ${results.selectedRiskFactors.length > 0 ? `
                <div class="info-box allergy">
                    <strong>å·²è¯†åˆ«çš„é£é™©å› ç´ :</strong><br>
                    ${results.selectedRiskFactors.map(factor => `â€¢ ${factor}`).join('<br>')}
                </div>
                ` : ''}

                <div class="info-box ${riskColorClass}">
                    <strong>é¢„å¤„ç†æ–¹æ¡ˆ:</strong><br>
                    ${assessment.premedication.split('\n').join('<br>')}
                </div>

                <div class="info-box normal">
                    <strong>ä¸´åºŠç›‘æŠ¤å»ºè®®:</strong><br>
                    ${assessment.recommendations.map(rec => `â€¢ ${rec}`).join('<br>')}
                </div>

                <div class="info-box normal">
                    <strong>é€ å½±å‰‚é€‰æ‹©å»ºè®®:</strong><br>
                    ${assessment.contrastChoice}
                </div>

                <div class="info-box normal">
                    <strong>åº”æ€¥è¯ç‰©å‡†å¤‡:</strong><br>
                    <strong>å¿…å¤‡è¯ç‰©:</strong>${assessment.emergencyPrep.medications.join('ã€')}<br>
                    <strong>å¿…å¤‡è®¾å¤‡:</strong>${assessment.emergencyPrep.equipment.join('ã€')}
                    ${assessment.emergencyPrep.personnel.length > 0 ? `<br><strong>äººå‘˜è¦æ±‚:</strong>${assessment.emergencyPrep.personnel.join('ã€')}` : ''}
                </div>
            `;
        }

        function displayContrastResults(results, container) {
            let bmiStatus, bmiClass;
            if (results.bmi < 18.5) {
                bmiStatus = 'åç˜¦';
                bmiClass = 'info-box renal';
            } else if (results.bmi < 24) {
                bmiStatus = 'æ­£å¸¸';
                bmiClass = 'info-box normal';
            } else if (results.bmi < 28) {
                bmiStatus = 'è¶…é‡';
                bmiClass = 'info-box renal';
            } else {
                bmiStatus = 'è‚¥èƒ–';
                bmiClass = 'info-box renal';
            }

            const examTypeText = results.examType === 'coronary' ? 'å† è„‰CTA' : 'èƒ¸ç—›ä¸‰è”';
            const heartRateText = results.heartRate <= 80 ? 'â‰¤80æ¬¡/åˆ†' : '>80æ¬¡/åˆ†';
            
            let patientTypeText = '';
            switch(results.patientType) {
                case 'normal': patientTypeText = 'æ­£å¸¸æ‚£è€…'; break;
                case 'renal': patientTypeText = 'è‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€…'; break;
                case 'metformin': patientTypeText = 'äºŒç”²åŒèƒç”¨è¯æ‚£è€…'; break;
                case 'heart': patientTypeText = 'å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…'; break;
            }

            let specialAssessment = '';
            
            if (results.patientType === 'normal') {
                specialAssessment = `
                    <div class="info-box normal">
                        <strong>æ­£å¸¸æ‚£è€…å¤„ç†æµç¨‹:</strong><br>
                        â€¢ è‚¾åŠŸèƒ½æ­£å¸¸,æ— éœ€ç‰¹æ®Šè¯„ä¼°<br>
                        â€¢ æŒ‰æ ‡å‡†æµç¨‹è¿›è¡Œé€ å½±æ£€æŸ¥<br>
                        â€¢ å¸¸è§„ç›‘æµ‹,æ— ç‰¹æ®Šé£é™©
                    </div>
                `;
            } else if (results.patientType === 'renal' && results.specialData) {
                const data = results.specialData;
                let renalRisk = '';
                let riskClass = '';
                
                if (data.eGFR >= 60) {
                    renalRisk = 'è‚¾åŠŸèƒ½æ­£å¸¸';
                    riskClass = 'normal';
                } else if (data.eGFR >= 45) {
                    renalRisk = 'è½»åº¦è‚¾åŠŸèƒ½ä¸å…¨';
                    riskClass = 'renal';
                } else if (data.eGFR >= 30) {
                    renalRisk = 'ä¸­åº¦è‚¾åŠŸèƒ½ä¸å…¨';
                    riskClass = 'renal';
                } else {
                    renalRisk = 'é‡åº¦è‚¾åŠŸèƒ½ä¸å…¨';
                    riskClass = 'metformin';
                }
                
                const recommendations = [];
                if (data.eGFR >= 60) {
                    recommendations.push('æŒ‰æ ‡å‡†æµç¨‹æ£€æŸ¥', 'å¸¸è§„æ°´åŒ–æ²»ç–—', 'é€ å½±åå¸¸è§„ç›‘æµ‹');
                } else if (data.eGFR >= 45) {
                    recommendations.push('é€‚å½“å‡å°‘é€ å½±å‰‚ç”¨é‡', 'åŠ å¼ºæ°´åŒ–æ²»ç–—', 'é€ å½±å24-48å°æ—¶å¤æŸ¥è‚¾åŠŸèƒ½');
                } else if (data.eGFR >= 30) {
                    recommendations.push('é€ å½±å‰‚ç”¨é‡å‡è‡³80%', 'å……åˆ†é™è„‰æ°´åŒ–', 'å¯†åˆ‡å…³æ³¨æœ‰æ— è¿‡æ•ååº”', 'å¯†åˆ‡ç›‘æµ‹48-72å°æ—¶');
                } else {
                    recommendations.push('å¼ºçƒˆå»ºè®®é¿å…é€ å½±å‰‚æ£€æŸ¥', 'è€ƒè™‘MRIã€è¶…å£°ç­‰æ›¿ä»£æ£€æŸ¥', 'å¦‚å¿…é¡»æ£€æŸ¥éœ€è‚¾å†…ç§‘ä¼šè¯Š');
                }
                
                specialAssessment = `
                    <div class="result-item">
                        <span class="result-label">è¡€è‚Œé…å€¼</span>
                        <span class="result-value">${data.creatinine} Î¼mol/L</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">eGFR</span>
                        <span class="result-value">${data.eGFR} ml/min/1.73mÂ²</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">è‚¾åŠŸèƒ½è¯„ä¼°</span>
                        <span class="result-value" style="color: var(--${riskClass}-color);">${renalRisk}</span>
                    </div>
                    <div class="info-box ${riskClass}">
                        <strong>ä¸´åºŠå¤„ç†å»ºè®®:</strong><br>
                        ${recommendations.map(rec => `â€¢ ${rec}`).join('<br>')}
                    </div>
                `;
            } else if (results.patientType === 'metformin' && results.specialData) {
                const data = results.specialData;
                const risk = data.metforminRisk;
                
                let riskColor = '';
                switch(risk.riskLevel) {
                    case 'low': riskColor = 'var(--normal-color)'; break;
                    case 'moderate': riskColor = 'var(--renal-color)'; break;
                    case 'high': 
                    case 'very-high': riskColor = 'var(--metformin-color)'; break;
                }
                
                specialAssessment = `
                    <div class="result-item">
                        <span class="result-label">è¡€è‚Œé…å€¼</span>
                        <span class="result-value">${data.creatinine} Î¼mol/L</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">eGFR</span>
                        <span class="result-value">${data.eGFR} ml/min/1.73mÂ²</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">äºŒç”²åŒèƒå‰‚é‡</span>
                        <span class="result-value">${data.dose}mg/æ—¥</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">é£é™©ç­‰çº§</span>
                        <span class="result-value" style="color: ${riskColor};">${risk.clinicalAction}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">é£é™©è¯„åˆ†</span>
                        <span class="result-value">${risk.riskScore.toFixed(1)} åˆ†</span>
                    </div>
                    <div class="info-box ${risk.riskLevel === 'low' ? 'normal' : risk.riskLevel === 'moderate' ? 'renal' : 'metformin'}">
                        <strong>ä¸´åºŠå¤„ç†å»ºè®®:</strong><br>
                        ${risk.recommendations.map(rec => `â€¢ ${rec}`).join('<br>')}
                    </div>
                `;
            } else if (results.patientType === 'heart' && results.specialData) {
                const data = results.specialData;
                const risk = data.heartRisk;
                
                let riskColor = '';
                switch(risk.riskLevel) {
                    case 'low': riskColor = 'var(--normal-color)'; break;
                    case 'moderate': riskColor = 'var(--heart-color)'; break;
                    case 'high': riskColor = 'var(--renal-color)'; break;
                    case 'very-high': riskColor = 'var(--metformin-color)'; break;
                }
                
                const nyhaText = ['Içº§ - æ´»åŠ¨ä¸å—é™åˆ¶', 'IIçº§ - è½»åº¦æ´»åŠ¨å—é™', 'IIIçº§ - æ˜æ˜¾æ´»åŠ¨å—é™', 'IVçº§ - ä¼‘æ¯æ—¶ä¹Ÿæœ‰ç—‡çŠ¶'][parseInt(data.nyha) - 1];
                
                specialAssessment = `
                    <div class="result-item">
                        <span class="result-label">NYHAåˆ†çº§</span>
                        <span class="result-value">${nyhaText}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">å·¦å®¤å°„è¡€åˆ†æ•°</span>
                        <span class="result-value">${data.ef}%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">BNPæ°´å¹³</span>
                        <span class="result-value">${
                            data.bnp === 'normal' ? 'æ­£å¸¸èŒƒå›´' :
                            data.bnp === 'mild' ? 'è½»åº¦å‡é«˜' :
                            data.bnp === 'moderate' ? 'ä¸­åº¦å‡é«˜' : 'é‡åº¦å‡é«˜'
                        }</span>
                    </div>
                    ${data.creatinine ? `
                        <div class="result-item">
                            <span class="result-label">è¡€è‚Œé…å€¼</span>
                            <span class="result-value">${data.creatinine} Î¼mol/L</span>
                        </div>
                    ` : ''}
                    ${data.eGFR ? `
                        <div class="result-item">
                            <span class="result-label">eGFR (å¿ƒè‚¾è¯„ä¼°)</span>
                            <span class="result-value">${data.eGFR} ml/min/1.73mÂ²</span>
                        </div>
                    ` : ''}
                    <div class="result-item">
                        <span class="result-label">é£é™©ç­‰çº§</span>
                        <span class="result-value" style="color: ${riskColor};">${risk.clinicalAction}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">é£é™©è¯„åˆ†</span>
                        <span class="result-value">${risk.riskScore} åˆ†</span>
                    </div>
                    <div class="info-box ${risk.riskLevel === 'low' ? 'normal' : risk.riskLevel === 'moderate' ? 'heart' : risk.riskLevel === 'high' ? 'renal' : 'metformin'}">
                        <strong>ä¸´åºŠå¤„ç†å»ºè®®:</strong><br>
                        ${risk.recommendations.map(rec => `â€¢ ${rec}`).join('<br>')}
                    </div>
                `;
            }

            let limitWarning = '';
            if (results.isVolumeExceeded) {
                limitWarning += `
                    <div class="info-box renal">
                        <strong>é€ å½±å‰‚ç”¨é‡é™åˆ¶æç¤º:</strong><br>
                        ç†è®ºè®¡ç®—ç”¨é‡:${results.originalVolume.toFixed(1)}ml<br>
                        å®‰å…¨é™åˆ¶ç”¨é‡:${results.contrastVolume.toFixed(1)}ml(${examTypeText}æœ€å¤§ç”¨é‡:${results.maxVolume}ml)<br>
                        <strong>å»ºè®®:</strong>å·²åº”ç”¨å®‰å…¨ä¸Šé™,è¯·ç»“åˆæ‚£è€…å…·ä½“æƒ…å†µè¯„ä¼°ã€‚
                    </div>
                `;
            }
            
            if (results.isFlowRateExceeded) {
                limitWarning += `
                    <div class="info-box renal">
                        <strong>æ³¨å°„æµé€Ÿé™åˆ¶æç¤º:</strong><br>
                        ç†è®ºè®¡ç®—æµé€Ÿ:${results.originalFlowRate.toFixed(2)}ml/s<br>
                        å®‰å…¨é™åˆ¶æµé€Ÿ:${results.flowRate.toFixed(2)}ml/s(æœ€å¤§æµé€Ÿ:5.0ml/s)<br>
                        <strong>å»ºè®®:</strong>å·²åº”ç”¨å®‰å…¨ä¸Šé™,å¯è€ƒè™‘å»¶é•¿æ³¨å°„æ—¶é—´æˆ–è°ƒæ•´æ–¹æ¡ˆã€‚
                    </div>
                `;
            }

            if (results.contrastAdjustments && results.contrastAdjustments.length > 0) {
                limitWarning += `
                    <div class="info-box renal">
                        <strong>ç‰¹æ®Šè°ƒæ•´æç¤º:</strong><br>
                        ${results.contrastAdjustments.map(adj => `â€¢ ${adj}`).join('<br>')}<br>
                        <strong>åŸå› :</strong>${
                            results.patientType === 'heart' ? 'å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…å‡å°‘é€ å½±å‰‚ç”¨é‡ä»¥é™ä½å®¹é‡è´Ÿè·' :
                            'è‚¾åŠŸèƒ½ä¸å…¨æ‚£è€…å‡å°‘é€ å½±å‰‚ç”¨é‡ä»¥é™ä½è‚¾æ¯’æ€§é£é™©'
                        }ã€‚
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="calc-type">
                    <div>æ‚£è€…ç±»å‹:${patientTypeText} | æ£€æŸ¥:${examTypeText} | å¿ƒç‡:${heartRateText}</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">
                        è®¡ç®—æ—¶é—´:${results.timestamp.toLocaleString()}
                    </div>
                </div>
                
                <div class="result-item">
                    <span class="result-label">èº«é«˜</span>
                    <span class="result-value">${results.height} cm</span>
                </div>
                <div class="result-item">
                    <span class="result-label">ä½“é‡</span>
                    <span class="result-value">${results.weight} kg</span>
                </div>
                <div class="result-item">
                    <span class="result-label">BMIæŒ‡æ•°</span>
                    <span class="result-value">${results.bmi.toFixed(2)}</span>
                </div>
                
                <div class="${bmiClass}">
                    <strong>BMIè¯„ä¼°:</strong>${bmiStatus}
                </div>
                
                ${specialAssessment}
                
                <div class="result-item">
                    <span class="result-label">é€ å½±å‰‚ç”¨é‡</span>
                    <span class="result-value" style="color: ${results.isVolumeExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.contrastVolume.toFixed(1)} ml
                    </span>
                </div>
                <div class="result-item">
                    <span class="result-label">æ³¨å°„æµé€Ÿ</span>
                    <span class="result-value" style="color: ${results.isFlowRateExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.flowRate.toFixed(2)} ml/s
                    </span>
                </div>
                
                ${limitWarning}
                
                <div class="info-box normal">
                    <strong>è®¡ç®—ä¾æ®:</strong><br>
                    <strong>eGFRå…¬å¼:</strong>2021ç‰ˆCKD-EPIè‚¾å°çƒæ»¤è¿‡ç‡æ–¹ç¨‹(æ— ç§æ—ç³»æ•°)<br>
                    <strong>é€ å½±å‰‚ç”¨é‡:</strong>${results.examType === 'coronary' ? 
                        (results.heartRate <= 80 ? 'å† è„‰CTAå¿ƒç‡â‰¤80:ä½“é‡Ã—0.8ml/kg' : 'å† è„‰CTAå¿ƒç‡>80:ä½“é‡Ã—0.85ml/kg') :
                        (results.heartRate <= 80 ? 'èƒ¸ç—›ä¸‰è”å¿ƒç‡â‰¤80:ä½“é‡Ã—0.8ml/kg + 15ml' : 'èƒ¸ç—›ä¸‰è”å¿ƒç‡>80:ä½“é‡Ã—0.85ml/kg + 15ml')
                    }<br>
                    <strong>æ³¨å°„æµé€Ÿ:</strong>${results.examType === 'coronary' ? 'ç”¨é‡Ã·12s' : '(ç”¨é‡-15ml)Ã·12s (æ‰€æœ‰è°ƒæ•´åçš„æœ€ç»ˆç”¨é‡)'}<br>
                    <strong>å®‰å…¨é™åˆ¶:</strong>${results.examType === 'coronary' ? 'å† è„‰CTAæœ€å¤§60ml' : 'èƒ¸ç—›ä¸‰è”æœ€å¤§75ml'},æµé€Ÿæœ€å¤§5.0ml/s<br>
                    <strong>ç¨‹åºç‰ˆæœ¬:</strong>v4.2æ··åˆç‰ˆæœ¬
                </div>
            `;
        }

        function exportToPDF() {
            if (!appState.currentResults) {
                showNotification('æ²¡æœ‰å¯å¯¼å‡ºçš„è¯„ä¼°ç»“æœ', 'warning');
                return;
            }
            
            try {
                const results = appState.currentResults;
                const reportId = Date.now().toString(36).toUpperCase();
                const reportNumber = `${new Date().getFullYear()}${(new Date().getMonth() + 1).toString().padStart(2, '0')}${new Date().getDate().toString().padStart(2, '0')}_${reportId}`;
                
                const pdfWindow = window.open('', '_blank', 'width=800,height=600');
                if (!pdfWindow) {
                    showNotification('æµè§ˆå™¨é˜»æ­¢äº†å¼¹çª—,è¯·å…è®¸å¼¹çª—åé‡è¯•', 'warning');
                    return;
                }
                
                // å…³é”®:è¿‡æ•è¯„ä¼°ä½¿ç”¨ä¸“é—¨PDFæ ¼å¼,å…¶ä»–ä½¿ç”¨è¯¦ç»†PDFæ ¼å¼
                const pdfContent = results.patientType === 'allergy' ? 
                    generateAllergyPDFContent(results, reportNumber) : 
                    generateDetailedPDFContent(results, reportNumber);
                
                pdfWindow.document.write(pdfContent);
                pdfWindow.document.close();
                
                if (pdfWindow.document.readyState === 'complete') {
                    setTimeout(() => pdfWindow.print(), 500);
                } else {
                    pdfWindow.addEventListener('load', function() {
                        setTimeout(() => pdfWindow.print(), 500);
                    });
                }
                
                showNotification('è¯·åœ¨æ‰“å°å¯¹è¯æ¡†ä¸­é€‰æ‹©"ä¿å­˜ä¸ºPDF"', 'info');
                
            } catch (error) {
                console.error('PDFå¯¼å‡ºå‡ºé”™:', error);
                showNotification('PDFå¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // è¿‡æ•è¯„ä¼°ä¸“ç”¨PDFæ ¼å¼
        function generateAllergyPDFContent(results, reportNumber) {
            const currentDate = new Date().toLocaleString();
            const assessment = results.riskAssessment;
            
            return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>é€ å½±å‰‚è¿‡æ•é£é™©è¯„ä¼°æŠ¥å‘Š_${reportNumber}</title>
    <style>
        @page { size: A4; margin: 1cm; }
        body { 
            font-family: 'Microsoft YaHei', 'SimSun', sans-serif; 
            line-height: 1.4; 
            color: #333; 
            margin: 0; 
            padding: 0; 
            font-size: 11px; 
        }
        .header { 
            text-align: center; 
            border-bottom: 2px solid #8b5cf6; 
            padding-bottom: 10px; 
            margin-bottom: 20px; 
        }
        .header h1 { 
            color: #8b5cf6; 
            font-size: 20px; 
            margin: 0 0 8px 0; 
            font-weight: 700; 
        }
        .risk-score-section {
            text-align: center;
            background: linear-gradient(135deg, #e9d5ff, #d8b4fe);
            border: 2px solid #8b5cf6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .risk-score {
            font-size: 48px;
            font-weight: 700;
            color: #581c87;
            margin-bottom: 10px;
        }
        .risk-level {
            font-size: 16px;
            font-weight: 600;
            color: #581c87;
        }
        .section {
            margin: 15px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .section-title {
            font-weight: 700;
            color: #8b5cf6;
            font-size: 13px;
            margin-bottom: 8px;
        }
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 10px;
        }
        .recommendation-box {
            background: linear-gradient(135deg, #f8f9fa, #f1f3f4);
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
        }
        .footer {
            border-top: 1px solid #ddd;
            padding-top: 10px;
            text-align: center;
            font-size: 8px;
            color: #666;
            margin-top: 20px;
        }
        @media print { body { margin: 0; padding: 0; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>é€ å½±å‰‚è¿‡æ•é£é™©è¯„ä¼°æŠ¥å‘Š</h1>
        <div>2024ç‰ˆè¯„ä¼°æ ‡å‡† | è¯„ä¼°æ—¶é—´: ${results.timestamp.toLocaleString()}</div>
        <div>ç”Ÿæˆæ—¶é—´: ${currentDate} | ç¼–å·: ${reportNumber}</div>
    </div>
    
    <div class="risk-score-section">
        <div class="risk-score">${results.score}</div>
        <div class="risk-level">${assessment.riskText} | ååº”å‘ç”Ÿç‡: ${assessment.reactionRate}</div>
    </div>
    
    <div class="section">
        <div class="section-title">é£é™©è¯„ä¼°ç»“æœ</div>
        <div class="data-row">
            <span>é£é™©è¯„åˆ†</span>
            <span>${results.score} åˆ†</span>
        </div>
        <div class="data-row">
            <span>é£é™©ç­‰çº§</span>
            <span>${assessment.riskText}</span>
        </div>
        <div class="data-row">
            <span>ååº”å‘ç”Ÿç‡</span>
            <span>${assessment.reactionRate}</span>
        </div>
        <div class="data-row">
            <span>å¤„ç†ç­–ç•¥</span>
            <span>${assessment.strategy}</span>
        </div>
    </div>
    
    <div class="recommendation-box">
        <div class="section-title">é¢„å¤„ç†æ–¹æ¡ˆ</div>
        <div style="font-size: 10px; line-height: 1.4;">
            ${assessment.premedication.split('\n').join('<br>')}
        </div>
    </div>
    
    <div class="recommendation-box">
        <div class="section-title">ä¸´åºŠç›‘æŠ¤å»ºè®®</div>
        <div style="font-size: 10px; line-height: 1.4;">
            ${assessment.recommendations.map(rec => `â€¢ ${rec}`).join('<br>')}
        </div>
    </div>
    
    <div class="recommendation-box">
        <div class="section-title">é€ å½±å‰‚é€‰æ‹©å»ºè®®</div>
        <div style="font-size: 10px; line-height: 1.4;">
            ${assessment.contrastChoice}
        </div>
    </div>
    
    <div class="recommendation-box">
        <div class="section-title">åº”æ€¥å‡†å¤‡</div>
        <div style="font-size: 10px; line-height: 1.4;">
            <strong>å¿…å¤‡è¯ç‰©:</strong>${assessment.emergencyPrep.medications.join('ã€')}<br>
            <strong>å¿…å¤‡è®¾å¤‡:</strong>${assessment.emergencyPrep.equipment.join('ã€')}
            ${assessment.emergencyPrep.personnel.length > 0 ? `<br><strong>äººå‘˜è¦æ±‚:</strong>${assessment.emergencyPrep.personnel.join('ã€')}` : ''}
        </div>
    </div>
    
    <div class="footer">
        <p><strong>é‡è¦å£°æ˜:</strong> æœ¬è¯„ä¼°ç»“æœä»…ä¾›å­¦æœ¯ç ”ç©¶å‚è€ƒ,ä¸èƒ½100%é¢„æµ‹è¿‡æ•ååº”ã€‚ä¸´åºŠä½¿ç”¨æ—¶å¿…é¡»ç»“åˆæ‚£è€…å…·ä½“æƒ…å†µ,é…å¤‡å®Œå–„çš„æŠ¢æ•‘æªæ–½ã€‚</p>
        <p><strong>æŠ¥å‘Šç¼–å·:</strong> ${reportNumber} | <strong>ç¨‹åºç‰ˆæœ¬:</strong> v4.2æ··åˆç‰ˆ | <strong>å¼€å‘è€…:</strong> å½±åƒæ¶›å“¥</p>
    </div>
</body>
</html>`;
        }

        // å‰å››ç±»æ‚£è€…è¯¦ç»†PDFæ ¼å¼(æ²¿ç”¨v3.4æ ·å¼)
        function generateDetailedPDFContent(results, reportNumber) {
            const currentDate = new Date().toLocaleString();
            
            let bmiStatus = '';
            if (results.bmi < 18.5) bmiStatus = 'åç˜¦';
            else if (results.bmi < 24) bmiStatus = 'æ­£å¸¸';
            else if (results.bmi < 28) bmiStatus = 'è¶…é‡';
            else bmiStatus = 'è‚¥èƒ–';
            
            const examTypeText = results.examType === 'coronary' ? 'å† è„‰CTA' : 'èƒ¸ç—›ä¸‰è”';
            const heartRateText = results.heartRate <= 80 ? 'â‰¤80æ¬¡/åˆ†' : '>80æ¬¡/åˆ†';
            
            let patientTypeText = '';
            switch(results.patientType) {
                case 'normal': patientTypeText = 'æ­£å¸¸æ‚£è€…'; break;
                case 'renal': patientTypeText = 'è‚¾åŠŸèƒ½å¼‚å¸¸æ‚£è€…'; break;
                case 'metformin': patientTypeText = 'äºŒç”²åŒèƒç”¨è¯æ‚£è€…'; break;
                case 'heart': patientTypeText = 'å¿ƒåŠŸèƒ½ä¸å…¨æ‚£è€…'; break;
            }

            let patientSpecificInfo = '';
            
            if (results.patientType === 'normal') {
                patientSpecificInfo = `
                    <div class="data-row">
                        <span class="data-label">ç‰¹æ®Šè¯„ä¼°</span>
                        <span class="data-value">æ— éœ€ç‰¹æ®Šè¯„ä¼°</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">å¤„ç†æ–¹å¼</span>
                        <span class="data-value">æ ‡å‡†æµç¨‹</span>
                    </div>
                `;
            } else if (results.patientType === 'renal' && results.specialData) {
                const data = results.specialData;
                patientSpecificInfo = `
                    <div class="data-row">
                        <span class="data-label">æ€§åˆ«å¹´é¾„</span>
                        <span class="data-value">${data.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'} ${data.age}å²</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">è¡€è‚Œé…</span>
                        <span class="data-value">${data.creatinine} Î¼mol/L</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">eGFR</span>
                        <span class="data-value">${data.eGFR} ml/min/1.73mÂ²</span>
                    </div>
                `;
            } else if (results.patientType === 'metformin' && results.specialData) {
                const data = results.specialData;
                patientSpecificInfo = `
                    <div class="data-row">
                        <span class="data-label">æ€§åˆ«å¹´é¾„</span>
                        <span class="data-value">${data.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'} ${data.age}å²</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">è¡€è‚Œé…</span>
                        <span class="data-value">${data.creatinine} Î¼mol/L</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">eGFR</span>
                        <span class="data-value">${data.eGFR} ml/min/1.73mÂ²</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">äºŒç”²åŒèƒå‰‚é‡</span>
                        <span class="data-value">${data.dose} mg/æ—¥</span>
                    </div>
                `;
            } else if (results.patientType === 'heart' && results.specialData) {
                const data = results.specialData;
                const nyhaTexts = ['Içº§', 'IIçº§', 'IIIçº§', 'IVçº§'];
                const bnpTexts = { 'normal': 'æ­£å¸¸', 'mild': 'è½»åº¦å‡é«˜', 'moderate': 'ä¸­åº¦å‡é«˜', 'severe': 'é‡åº¦å‡é«˜' };
                patientSpecificInfo = `
                    <div class="data-row">
                        <span class="data-label">NYHAåˆ†çº§</span>
                        <span class="data-value">${nyhaTexts[parseInt(data.nyha) - 1]}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">å°„è¡€åˆ†æ•°EF</span>
                        <span class="data-value">${data.ef}%</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">BNPæ°´å¹³</span>
                        <span class="data-value">${bnpTexts[data.bnp]}</span>
                    </div>
                    ${data.creatinine ? `
                    <div class="data-row">
                        <span class="data-label">è¡€è‚Œé…</span>
                        <span class="data-value">${data.creatinine} Î¼mol/L</span>
                    </div>
                    ` : ''}
                `;
            }

            let assessmentResults = '';
            
            if (results.patientType === 'normal') {
                assessmentResults = `
                    <div class="assessment-section">
                        <div class="assessment-title">æ­£å¸¸æ‚£è€…å¤„ç†æµç¨‹</div>
                        <div class="assessment-content">è‚¾åŠŸèƒ½æ­£å¸¸,æ— ç‰¹æ®Šç”¨è¯å²,æŒ‰æ ‡å‡†æµç¨‹è¿›è¡Œé€ å½±æ£€æŸ¥,å¸¸è§„ç›‘æµ‹å³å¯</div>
                    </div>
                `;
            } else if (results.patientType === 'renal' && results.specialData) {
                const data = results.specialData;
                let riskLevel = data.eGFR >= 60 ? 'ä½é£é™©' : data.eGFR >= 45 ? 'ä¸­é£é™©' : data.eGFR >= 30 ? 'é«˜é£é™©' : 'æé«˜é£é™©';
                let riskColor = data.eGFR >= 60 ? '#22c55e' : data.eGFR >= 45 ? '#f59e0b' : '#ef4444';
                
                let clinicalRecommendation = '';
                if (data.eGFR >= 60) {
                    clinicalRecommendation = 'æ ‡å‡†æµç¨‹,å¸¸è§„æ°´åŒ–æ²»ç–—,é€ å½±åå¸¸è§„ç›‘æµ‹';
                } else if (data.eGFR >= 45) {
                    clinicalRecommendation = 'é€‚å½“å‡é‡,åŠ å¼ºæ°´åŒ–æ²»ç–—,é€ å½±å24-48å°æ—¶å¤æŸ¥è‚¾åŠŸèƒ½';
                } else if (data.eGFR >= 30) {
                    clinicalRecommendation = 'é€ å½±å‰‚å‡é‡è‡³80%,å……åˆ†é™è„‰æ°´åŒ–,å¯†åˆ‡å…³æ³¨æœ‰æ— è¿‡æ•ååº”,å¯†åˆ‡ç›‘æµ‹48-72å°æ—¶';
                } else {
                    clinicalRecommendation = 'å¼ºçƒˆå»ºè®®é¿å…é€ å½±å‰‚æ£€æŸ¥,è€ƒè™‘MRIã€è¶…å£°ç­‰æ›¿ä»£æ£€æŸ¥æ–¹æ³•';
                }

                assessmentResults = `
                    <div class="assessment-section">
                        <div class="assessment-title">è‚¾åŠŸèƒ½è¯„ä¼°ç»“æœ</div>
                        <div class="assessment-content">
                            <span style="color: ${riskColor}; font-weight: bold;">${riskLevel}</span> | ${clinicalRecommendation}
                        </div>
                    </div>
                `;
            } else if (results.patientType === 'metformin' && results.specialData) {
                const data = results.specialData;
                const risk = data.metforminRisk;
                let riskColor = risk.riskLevel === 'low' ? '#22c55e' : risk.riskLevel === 'moderate' ? '#f59e0b' : '#ef4444';

                assessmentResults = `
                    <div class="assessment-section">
                        <div class="assessment-title">äºŒç”²åŒèƒé£é™©è¯„ä¼°</div>
                        <div class="assessment-content">
                            é£é™©è¯„åˆ†${risk.riskScore.toFixed(1)}åˆ†, <span style="color: ${riskColor}; font-weight: bold;">${risk.clinicalAction}</span><br>
                            ç”¨è¯ç®¡ç†: é€ å½±å‰${data.eGFR >= 60 ? '48å°æ—¶' : '48-72å°æ—¶'}åœè¯,é€ å½±å${data.eGFR >= 60 ? '24-48å°æ—¶' : '48-72å°æ—¶'}å¤æŸ¥è‚¾åŠŸèƒ½æ­£å¸¸åæ¢å¤ç”¨è¯
                        </div>
                    </div>
                `;
            } else if (results.patientType === 'heart' && results.specialData) {
                const data = results.specialData;
                const risk = data.heartRisk;
                let riskColor = risk.riskLevel === 'low' ? '#22c55e' : risk.riskLevel === 'moderate' ? '#3b82f6' : risk.riskLevel === 'high' ? '#f59e0b' : '#ef4444';

                let monitoringPlan = '';
                if (risk.riskLevel === 'low') {
                    monitoringPlan = 'æ ‡å‡†å¤„ç†,æ£€æŸ¥åè§‚å¯Ÿ2å°æ—¶';
                } else if (risk.riskLevel === 'moderate') {
                    monitoringPlan = 'ç”¨é‡å‡è‡³85%,æµé€Ÿâ‰¤4.5ml/s,æ£€æŸ¥åè§‚å¯Ÿ4å°æ—¶';
                } else if (risk.riskLevel === 'high') {
                    monitoringPlan = 'ç”¨é‡å‡è‡³70%,æµé€Ÿâ‰¤4.0ml/s,å¿ƒå†…ç§‘ä¼šè¯Š,å‡†å¤‡æ€¥æ•‘è®¾å¤‡';
                } else {
                    monitoringPlan = 'æ…é‡è€ƒè™‘,å»ºè®®æ¨è¿Ÿæ£€æŸ¥æˆ–åœ¨CCUç›‘æŠ¤æ¡ä»¶ä¸‹è¿›è¡Œ';
                }

                assessmentResults = `
                    <div class="assessment-section">
                        <div class="assessment-title">å¿ƒåŠŸèƒ½è¯„ä¼°ç»“æœ</div>
                        <div class="assessment-content">
                            é£é™©è¯„åˆ†${risk.riskScore}åˆ†, <span style="color: ${riskColor}; font-weight: bold;">${risk.clinicalAction}</span><br>
                            ç›‘æŠ¤æ–¹æ¡ˆ: ${monitoringPlan}
                        </div>
                    </div>
                `;
            }

            let eGFRCalculationSection = '';
            if ((results.patientType === 'renal' || results.patientType === 'metformin') && results.specialData && results.specialData.eGFRDetails) {
                const eGFRDetails = results.specialData.eGFRDetails;
                eGFRCalculationSection = `
                    <div class="calculation-details">
                        <h3>eGFRè¯¦ç»†æ¼”ç®—è¿‡ç¨‹</h3>
                        <div class="calculation-steps">
                            <strong>2021ç‰ˆCKD-EPIå…¬å¼:</strong><br>
                            <pre style="font-size: 9px; line-height: 1.2; white-space: pre-wrap; background: #f8f9fa; padding: 6px; border-radius: 4px; margin: 3px 0; font-family: 'Courier New', monospace;">${eGFRDetails.simplifiedCalculation}</pre>
                            <strong>æœ€ç»ˆç»“æœ:</strong> eGFR = ${eGFRDetails.result} ml/min/1.73mÂ²
                        </div>
                    </div>
                `;
            }

            let safetySection = '';
            if (results.isVolumeExceeded || results.isFlowRateExceeded || results.contrastAdjustments.length > 0) {
                let warnings = [];
                
                if (results.isVolumeExceeded) {
                    warnings.push(`ç”¨é‡è¶…é™: ç†è®º${results.originalVolume.toFixed(1)}ml â†’ é™åˆ¶${results.contrastVolume.toFixed(1)}ml`);
                }
                
                if (results.isFlowRateExceeded) {
                    warnings.push(`æµé€Ÿè¶…é™: ç†è®º${results.originalFlowRate.toFixed(2)}ml/s â†’ é™åˆ¶${results.flowRate.toFixed(2)}ml/s`);
                }
                
                if (results.contrastAdjustments.length > 0) {
                    warnings.push(`${results.contrastAdjustments.join(' | ')}`);
                }
                
                safetySection = `
                    <div class="warning-section">
                        <div class="warning-title">å®‰å…¨é™åˆ¶ä¸è°ƒæ•´</div>
                        <div class="warning-content">${warnings.join(' | ')}<br>
                        å·²åº”ç”¨ç¨‹åºå®‰å…¨ä¸Šé™,å®é™…ä½¿ç”¨éœ€ç»“åˆæ‚£è€…å…·ä½“æƒ…å†µè¯„ä¼°</div>
                    </div>
                `;
            }
            
            return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å½±åƒå­¦æœ¯ç ”ç©¶è®¡ç®—ç»“æœ_${reportNumber}</title>
    <style>
        @page { size: A4; margin: 1cm; }
        body { 
            font-family: 'Microsoft YaHei', 'SimSun', sans-serif; 
            line-height: 1.3; 
            color: #333; 
            margin: 0; 
            padding: 0; 
            font-size: 11px; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header { 
            text-align: center; 
            border-bottom: 2px solid #4f46e5; 
            padding-bottom: 8px; 
            margin-bottom: 15px; 
        }
        .header h1 { 
            color: #4f46e5; 
            font-size: 18px; 
            margin: 0 0 5px 0; 
            font-weight: 700; 
        }
        .header .subtitle { 
            color: #666; 
            font-size: 12px; 
            margin-bottom: 5px; 
        }
        .header .meta-info { 
            font-size: 9px; 
            color: #888; 
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            flex: 1;
        }
        
        .info-card {
            border: 1.5px solid #ddd;
            border-radius: 6px;
            height: fit-content;
        }
        
        .card-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #ddd;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 11px;
            color: #4f46e5;
        }
        
        .card-body {
            padding: 10px 12px;
        }
        
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 10px;
        }
        
        .data-row:last-child {
            border-bottom: none;
        }
        
        .data-label {
            color: #666;
            font-weight: 500;
        }
        
        .data-value {
            color: #333;
            font-weight: 600;
        }
        
        .result-highlight {
            color: #4f46e5;
            font-size: 11px;
            font-weight: 700;
        }
        
        .assessment-section {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #f8f9fa, #f1f3f4);
            border: 1.5px solid #ddd;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 8px 0;
        }
        
        .assessment-title {
            font-weight: 700;
            font-size: 11px;
            color: #4f46e5;
            margin-bottom: 5px;
        }
        
        .assessment-content {
            font-size: 10px;
            line-height: 1.4;
            color: #333;
        }
        
        .warning-section {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            border: 1.5px solid #f59e0b;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 8px 0;
        }
        
        .warning-title {
            font-weight: 700;
            font-size: 11px;
            color: #92400e;
            margin-bottom: 5px;
        }
        
        .warning-content {
            font-size: 10px;
            line-height: 1.4;
            color: #92400e;
        }
        
        .calculation-summary {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1.5px solid #bfdbfe;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 8px 0;
        }
        
        .calculation-summary h3 {
            color: #1e40af;
            font-size: 11px;
            margin: 0 0 8px 0;
            font-weight: 700;
        }
        
        .calc-formula {
            font-size: 9px;
            line-height: 1.4;
            color: #1e40af;
        }

        .calculation-details {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #fefce8, #fef3c7);
            border: 1.5px solid #eab308;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 8px 0;
        }

        .calculation-details h3 {
            color: #92400e;
            font-size: 11px;
            margin: 0 0 8px 0;
            font-weight: 700;
        }

        .calculation-steps {
            font-size: 9px;
            line-height: 1.3;
            color: #92400e;
        }
        
        .tech-specs {
            background: linear-gradient(135deg, #f8f9fa, #f1f3f4);
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 9px;
            line-height: 1.3;
            color: #666;
            margin: 15px 0 10px 0;
            border: 1px solid #e2e8f0;
        }
        
        .footer {
            border-top: 1.5px solid #ddd;
            padding-top: 10px;
            text-align: center;
            font-size: 8px;
            color: #666;
            line-height: 1.3;
            margin-top: auto;
        }
        
        @media print { 
            body { margin: 0; padding: 0; } 
            .no-print { display: none; } 
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>å½±åƒå­¦æœ¯ç ”ç©¶è®¡ç®—ç»“æœ</h1>
        <div class="subtitle">CTAé€ å½±å‰‚ç”¨é‡ä¸BMIå­¦æœ¯å‚è€ƒè®¡ç®— v4.2æ··åˆç‰ˆ - ${patientTypeText}</div>
        <div class="meta-info">
            è®¡ç®—æ—¶é—´: ${results.timestamp.toLocaleString()} | ç”Ÿæˆæ—¶é—´: ${currentDate} | ç¼–å·: ${reportNumber}
        </div>
    </div>
    
    <div class="main-content">
        <div class="info-card">
            <div class="card-header">åŸºæœ¬ä¿¡æ¯ä¸BMIè¯„ä¼°</div>
            <div class="card-body">
                <div class="data-row">
                    <span class="data-label">æ‚£è€…ç±»å‹</span>
                    <span class="data-value">${patientTypeText}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">èº«é«˜/ä½“é‡</span>
                    <span class="data-value">${results.height}cm / ${results.weight}kg</span>
                </div>
                <div class="data-row">
                    <span class="data-label">BMIæŒ‡æ•°</span>
                    <span class="data-value">${results.bmi.toFixed(2)} (${bmiStatus})</span>
                </div>
                <div class="data-row">
                    <span class="data-label">æ£€æŸ¥ç±»å‹</span>
                    <span class="data-value">${examTypeText}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">å¿ƒç‡å‚æ•°</span>
                    <span class="data-value">${heartRateText}</span>
                </div>
            </div>
        </div>
        
        <div class="info-card">
            <div class="card-header">ä¸“ç§‘å‚æ•°ä¸è¯„ä¼°</div>
            <div class="card-body">
                ${patientSpecificInfo}
            </div>
        </div>
        
        <div class="info-card">
            <div class="card-header">è®¡ç®—ç»“æœ</div>
            <div class="card-body">
                <div class="data-row">
                    <span class="data-label">é€ å½±å‰‚ç”¨é‡</span>
                    <span class="data-value result-highlight" style="color: ${results.isVolumeExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.contrastVolume.toFixed(1)} ml
                    </span>
                </div>
                <div class="data-row">
                    <span class="data-label">æ³¨å°„æµé€Ÿ</span>
                    <span class="data-value result-highlight" style="color: ${results.isFlowRateExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.flowRate.toFixed(2)} ml/s
                    </span>
                </div>
                <div class="data-row">
                    <span class="data-label">æ³¨å°„æ—¶é—´</span>
                    <span class="data-value">${results.examType === 'coronary' ? '12ç§’' : 'çº¦' + Math.ceil((results.contrastVolume - (results.examType === 'triple' ? 15 : 0)) / results.flowRate) + 'ç§’'}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">å®‰å…¨ä¸Šé™</span>
                    <span class="data-value">â‰¤${results.maxVolume}ml, â‰¤5.0ml/s</span>
                </div>
            </div>
        </div>
        
        <div class="info-card">
            <div class="card-header">æ³¨å°„æ–¹æ¡ˆä¸ç›‘æŠ¤</div>
            <div class="card-body">
                <div class="data-row">
                    <span class="data-label">é™è„‰é€šè·¯</span>
                    <span class="data-value">å³è‚˜ä¸­é™è„‰</span>
                </div>
                <div class="data-row">
                    <span class="data-label">æ³¨å°„å‹åŠ›</span>
                    <span class="data-value"><300psi</span>
                </div>
                <div class="data-row">
                    <span class="data-label">è¿‡æ•ç›‘æµ‹</span>
                    <span class="data-value">å¯†åˆ‡å…³æ³¨æœ‰æ— è¿‡æ•ååº”</span>
                </div>
                <div class="data-row">
                    <span class="data-label">ç›‘æŠ¤æ—¶é—´</span>
                    <span class="data-value">${results.patientType === 'heart' ? '4-6å°æ—¶' : '2-4å°æ—¶'}</span>
                </div>
            </div>
        </div>
        
        ${assessmentResults}
        
        ${eGFRCalculationSection}
        
        ${safetySection}
        
        <div class="calculation-summary">
            <h3>è®¡ç®—å…¬å¼ä¸ç†è®ºä¾æ®</h3>
            <div class="calc-formula">
                <strong>BMIè®¡ç®—:</strong> ${results.weight} Ã· (${results.height/100})Â² = ${results.bmi.toFixed(2)} | 
                <strong>é€ å½±å‰‚ç”¨é‡:</strong> ${results.examType === 'coronary' ? 
                    (results.heartRate <= 80 ? 'ä½“é‡Ã—0.8ml/kg' : 'ä½“é‡Ã—0.85ml/kg') :
                    (results.heartRate <= 80 ? 'ä½“é‡Ã—0.8+15ml' : 'ä½“é‡Ã—0.85+15ml')
                } | 
                <strong>æ³¨å°„æµé€Ÿ:</strong> ${results.examType === 'coronary' ? 'ç”¨é‡Ã·12s' : '(ç”¨é‡-15ml)Ã·12s'}
                ${results.contrastAdjustments.length > 0 ? `<br><strong>è°ƒæ•´ä¾æ®:</strong> ${results.contrastAdjustments.join('; ')}` : ''}
                ${results.specialData && (results.patientType === 'renal' || results.patientType === 'metformin') ? 
                `<br><strong>eGFRè®¡ç®—:</strong> 2021ç‰ˆCKD-EPIå…¬å¼(æ— ç§æ—ç³»æ•°),${results.specialData.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'}${results.specialData.age}å²æ‚£è€…,è¯¦ç»†æ¼”ç®—è¿‡ç¨‹è§ä¸Šæ–¹` : ''}
            </div>
        </div>
    </div>
    
    <div class="tech-specs">
        <strong>ç¨‹åºç‰ˆæœ¬:</strong> v4.2æ··åˆç‰ˆ | 
        <strong>å¼€å‘è€…:</strong> å½±åƒæ¶›å“¥ | 
        <strong>è®¡ç®—æ ‡å‡†:</strong> åŸºäºè”å½±è®¾å¤‡æŠ€æœ¯å‚æ•°ä¸ä¸´åºŠç ”ç©¶æ•°æ® | 
        <strong>è®¡ç®—å…¬å¼:</strong> 2021ç‰ˆCKD-EPIè‚¾å°çƒæ»¤è¿‡ç‡æ–¹ç¨‹(æ— ç§æ—ç³»æ•°)
    </div>
    
    <div class="footer">
        <p><strong>é‡è¦å£°æ˜:</strong> æœ¬è®¡ç®—ç»“æœä»…ä¾›å½±åƒæŠ€æœ¯æ•™å­¦å’Œå­¦æœ¯ç ”ç©¶å‚è€ƒ,ä¸¥ç¦ç”¨äºä¸´åºŠè¯Šæ–­æˆ–æ²»ç–—å†³ç­–ã€‚å®é™…ä½¿ç”¨æ—¶å¿…é¡»ç»“åˆæ‚£è€…å…·ä½“ç—…å²ã€å®éªŒå®¤æ£€æŸ¥ç»“æœå’Œä¸´åºŠåŒ»å¸ˆåˆ¤æ–­ã€‚å¼€å‘è€…ä¸æ‰¿æ‹…ä»»ä½•æ³•å¾‹è´£ä»»ã€‚</p>
        <p><strong>ç»“æœç¼–å·:</strong> ${reportNumber} | <strong>æŠ€æœ¯æ”¯æŒ:</strong> è”å½±CT960+å¹³å° | <strong>ä½¿ç”¨è®¸å¯:</strong> ä»…é™å­¦æœ¯ç ”ç©¶ç”¨é€” | <strong>eGFRå…¬å¼:</strong> 2021ç‰ˆCKD-EPIæ–¹ç¨‹</p>
    </div>
</body>
</html>`;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 15px 20px;
                border-radius: 8px; color: white; font-weight: 500; z-index: 1000;
                opacity: 0; transition: opacity 0.3s ease; max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            switch(type) {
                case 'success': notification.style.background = '#22c55e'; break;
                case 'error': notification.style.background = '#ef4444'; break;
                case 'warning': notification.style.background = '#f59e0b'; break;
                default: notification.style.background = '#3b82f6';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.opacity = '1', 10);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            try {
                updateClock();
                setInterval(updateClock, 1000);
                
                setupRealTimeValidation();
                setupCheckboxExclusivity();
                updateProgress();
                
                document.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !document.getElementById('calculateBtn').disabled) {
                        calculate();
                    }
                });
                
                document.addEventListener('input', function(e) {
                    updateProgress();
                    
                    if (e.target.closest('#allergyForm')) {
                        updateAllergyRiskScore();
                    }
                });
                
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å‡ºé”™:', error);
                showNotification('é¡µé¢åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜,éƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨', 'warning');
            }
        });

        window.addEventListener('error', function(event) {
            console.error('å…¨å±€é”™è¯¯:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
        });
    </script>
</body>
</html>
